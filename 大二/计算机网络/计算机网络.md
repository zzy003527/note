# 计算机网络

## 一.概述

### 1.1 计算机网络在信息时代的作用

- 计算机网络已由一种**通信基础设施**发展成为一种重要的**信息服务基础设施**
- 计算机网络已经像水、电、煤气这些基础设施一样，成为我们**生活中不可或缺**的一部分



### 1.2 因特网概述

#### 1.2.1 网络、互联网和因特网

- 网络（Network）由若干**结点**(Node)和连接这些节点的**链路**（Link）组成
- 多个网络还可以通过路由器互连起来，这样就构成了一个覆盖范围更大的网络，即互联网（互连网）。因此，互联网是"**网络的网络**"
- 因特网（Internet）是世界上最大的互连网络（用户数以亿计，互连的网络数以百万计）
- `internet`和`Internet`的区别
  - `internet`（互联网或互连网）是一个通用名词，它泛指由多个计算机网络互连而成的网络。在这些网络之间的通信协议可以是任意的
  - `Internet`（因特网）则是一个专用名词，它指当前全球最大的、开放的、由众多网络相互连接而成的特定计算机网络，它采用TCP/IP协议族作为通信的规则，其前身是美国的ARPANET



#### 1.2.2 因特网发展的三个阶段

- 从单个网络ARPANET向互联网发展
  - 1969年，第一个分组交换网**ARPANET**
  - 70年代中期，研究多种网络之间的互连
  - 1983年，**TCP/IP协议**成为ARPANET的标准协议（因特网诞生时间）
- 逐步建成三级结构的因特网
  - 1985年，NSF围绕六个大型计算机中心建设**NSFNET**（主干网、地区网和校园网）
  - 1990年，ARPANET任务完成，正式关闭
  - 1991年，美国政府将因特网主干网交给私人公司经营，并开始对接入因特网的单位收费
- 逐步形成了多层次ISP结构的因特网
  - 1993年，NSFNET逐渐被若干个商用因特网主干网替代；政府机构不再负责因特网运营，让各种**因特网服务提供者ISP**来运营
  - 1994年，**万维网WWW技术**促使英特网迅猛发展
  - 1995年，NSFNET停止运作，**因特网彻底商业化**



#### 1.2.3 因特网的标准化工作

- 因特网服务提供者**ISP**（Internet Service Provider）
- 因特网的标准化工作对因特网的发展起到了非常重要的作用
- 因特网在制定其标准上的一个很大的特点是**面向公众**
  - 因特网所有的RFC（Request For Comments）技术文档都可以从因特网上免费下载（http://www.ietf.org/rfc.html)
  - 任何人都可以随时用电子邮件发表对某个文档的意见或建议
- **因特网协会ISOC**是一个国际性组织，它负责对因特网进行全面管理，以及在世界范围内促进其发展和使用
  - 因特网体系结构委员会IAB，负责管理因特网有关协议的开发；
  - 因特网工程部IETF，负责研究中短期工程问题，主要针对协议的开发和标准化
  - 因特网研究部IRTF，从事理论方面的研究和开发一些需要长期考虑的问题
- 制定因特网的正式标准要经过以下**4个阶段**：
  - 因特网草案（在这个阶段还不是RFC文档）
  - 建议标准（从这个阶段开始就成为RFC文档）
  - 草案标准
  - 因特网标准



#### 1.2.4 因特网的组成

- 边缘部分

  - 由所有连接在因特网上的**主机**组成。这部分是**用户直接使用**的，用来进行**通信**（传送数据、音频或视频）和**资源共享**

- 核心部分

  - 由**大量网络**和连接这些网络的**路由器**组成。这部分是**为边缘部分提供服务**的（提供连通性和交换）

  

### 1.3 三种交换方式

- 电路交换(Circuit Switching)

  - 电话交换机接通电话线的方式称为电路交换
  - 从通信资源的分配角度来看，交换（Switching）就是按照某种方式动态地分配传输线路的资源
  - 电路交换的三个步骤：
    - 建立连接（分配通信资源）
    - 通话（一直占用通信资源）
    - 释放连接（归还通信资源）

- **分组交换(Packet Switching)**

  - 比如发送方要给接收方发送一段消息，**表示该消息的整块数据称为一个报文**。**在发送报文之前，先把较长的报文划分成为一个个更小的等长数据段，在每一个数据段前面，加上一些由必要的控制信息组成的首部后，就构成为一个分组，也可称为"包"**
  - 发送方需要：构造分组，发送分组
  - 路由器需要：缓存分组，转发分组
  - 接收方需要：接收分组，还原报文

- 报文交换(Message Switching)

  - 与分组交换类似，但是报文大小没有限制

- 电路交换、报文交换、分组交换的对比

  - 电路交换
    - 优点：通信时延小、有序传输、没有冲突、适用范围广、实时性强、控制简单
    - 缺点：建立连接时间长、线路独占，使用效率低、灵活性差、难以规格化
  - 报文交换
    - 优点：无需建立连接、动态分配线路、提高线路可靠性、提高线路利用率、提供多目标服务
    - 缺点：引起了转发时延、需要较大存储缓存空间、需要传输额外的信息量
  - **分组交换**
    - 优点：无需建立连接、线路利用率高、简化了存储管理、加速传输、减少出错概率和重发数据量
    - 缺点：引起了转发时延、需要传输额外的信息量、对于数据报服务，存在失序、丢失或重复分组的问题；对于虚电路服务，存在呼叫建立、数据传输和虚电路释放三个过程

  

### 1.4 计算机网络的定义和分类

#### 1.4.1  计算机网络的定义

- 计算机网络的精确定义并未统一

- 计算机网络最简单的定义是：**一些互<u>相连接的</u>、<u>自治</u>的计算机的<u>集合</u>**

  - 互连：是指计算机之间可以通过有线或无线的方式进行数据通信
  - 自治：是指独立的计算机，它具有自己的硬件和软件，可以单独运行使用
  - 集合：是指至少需要两台计算机 

- 计算机网络的较好的定义是：计算机网络主要是由一些**通用的、可编程的硬件互连**而成的，而这些硬件并非专门用来实现某一特定目的（例如，传送数据或视频信号）。这些可编程的硬件能够用来**传送多种不同类型的数据**，并能**支持广泛的和日益增长的应用**

  - 计算机网络所连接的硬件，并不限于一般的计算机，而是包括了智能手机等智能硬件
  - 计算机网络并非专门用来传送数据，而是能够支持很多种的应用（包括今后可能出现的各种应用）

  

#### 1.4.2 计算机网络的分类

- **按交换技术分类**

  - 电路交换网络
  - 报文交换网络
  - 分组交换网络

- **按使用者分类**

  - **公用网：指电信公司出资建造的大型网络**
    - "公用"的意思就是所有愿意按电信公司的规定缴纳费用的人都可以使用这种网络
    - 因此公用网也可称为公众网
  - **专用网：指某个部门为本单位的特殊业务工作的需要而建造的网络**
    - 不向本单位以外的人提供服务。如：军队、铁路、电力等系统均有本系统的专用网

- **按传输介质分类**

  - **有线网络**
    - 包括双绞线网络、光纤网络等
  - **无线网络**
    - WIFI技术应用比较普遍

- **按网络覆盖范围分类**

  - **广域网WAN**
    - 作用距离为几十至几千公里，可以覆盖一个国家、地区，甚至横跨几个洲
    - 有时也称为远程网
    - 是因特网的核心部分，其任务是为核心路由器提供远距离（例如，跨越不同国家的）高速连接，互连分布在不同区域的城域网和局域网
  - **城域网MAN**
    - 作用距离为5到50公里。覆盖范围一般是一个城市，可跨越几个街区甚至整个城市
    - 城域网通常作为城市骨干网，互连大量企业、机构和校园局域网
  - **局域网LAN**
    - 局域网一般用微型计算机或工作站通过高速通信线路相连，速率通常在10Mbit/s以上
    - 地理上局限在较小范围内，如一个实验室，一栋楼或一个校园内，距离一般在一公里左右
    - 局域网通常由某个单位单独拥有、使用和维护
  - **个域网PAN**
    - 是个人区域网络的简称
    - 也称为无线个人区域为WPAN，覆盖范围大约为10米

- **按拓扑结构分类**

  - **总线型网络**
    - **使用单根传输线把计算机连接起来**
    - 优点是建网容易、增减节点方便、节省线路
    - 缺点是重负载时通信效率不高，总线任意一处出现故障，则全网瘫痪
  - **星型网络**
    - **是将每个计算机都以单独的线路与中央设备相连**
    - 中央设备早期是计算机，后来是集线器。现在一般是交换机或路由器
    - 这种网络拓扑便于网络的集中控制和管理，因为端用户之间的通信必须经过中央设备
    - 缺点是成本高，中央设备对故障敏感
  - **环形网络**
    - **环形网络是将所有计算机的网络接口连接成一个环**。最典型的例子是令牌环局域网
    - 环可以是单环，也可以是双环，**环中信号是单向传输的**
  - 网状型网络
    - **一般情况下，每个结点至少由两条路径与其他结点相连**，多用在广域网中
    - 优点是可靠性高，缺点是控制复杂、线路成本高
  - 注意：以上四种基本的网络拓扑还可以互连成为更复杂的网络

  





### 1.5 计算机网络的性能指标

- 性能指标可以从不同的方面来度量计算机网络的性能
- **常用的计算机网络的性能指标有以下8个：**
  - 速率
  - 带宽
  - 吞吐量
  - 时延
  - 时延带宽积
  - 往返时间
  - 利用率
  - 丢包率
- **速率**
  - 比特(bit)：比特是计算机中**数据量的单位**，也是信息论中信息量的单位。一个比特就是二进制数字中的一个1或一个0
  - 常用的数据量单位有：
    - 字节（Byte）：8 bit = 1 Byte
    - 千字节（KB），这里的K为2的10次方：1 KB = 2的十次方B = 1024 B
    - 兆字节（MB）：1 MB = 1024 KB
    - 吉字节（GB）：1 GB = 1024 MB
    - 太字节（TB）：1 TB = 1024 GB
  - **速率：指连接在计算机网络上的主机在数字信道上传送比特的速率，也成为<u>比特率</u>或<u>数据率</u>**
  - 常用数据率单位有：
    - bit/s（b/s，bps）
    - kb/s = 1000 b/s（bps）
    - Mb/s = k*kb/s = 1000 * 1000 b/s = 10的六次方b/s（bps）
    - Gb/s = k*Mb/s = 10的三次方 * 10的六次方 = 10的九次方 b/s（bps）
    - Tb/s = k*Gb/s = 10的三次方 * 10的九次方 = 10的十二次方 b/s（bps）
  - **注意：数据率中的k常用小写，而数据量中的K常用大写。小写k在速率单位中的值为10的三次方，也就是1000；而大写K在数据量单位中的值为2的10次方，也就是1024**

- **带宽**

  - **带宽在模拟信号系统中的意义：**
    - **是指<u>信号</u>所包含的各种不同频率成分所占据的<u>频率范围</u>**
    - 单位：Hz(kHz,MHz,GHz)
  - **带宽在计算机网络中的意义：**
    - 用来表示网络的**通信线路**所能传送数据的能力，因此网络带宽表示在单位时间内从网络中的某一点到另一点所能通过的**"最高数据率"**
    - 单位：b/s (kb/s,Mb/s,Gb/s,Tb/s)
  - **带宽的这两种表述之间有着密切的联系。一条通信线路的"频带宽度"越宽，其所传输数据的"最高数据率"也越高**

- 吞吐量

  - **吞吐量表示在单位时间内通过某个网络（或信道、接口）的数据量**
  - 吞吐量经常被用于对现实世界中的网络的一种策略，以便知道实际上到底有多少数据量能够通过网络
  - **吞吐量受网络的带宽或额定速率的限制**

- 时延

  - 分组从源主机传送给目的主机的过程中，**网络时延由三部分构成：**
    - **源主机将分组发往传输线路**，这需要花费一定时间，我们把这段时间称为**发送时延**
      - **计算公式：`分组长度(b) 除以 发送速率(b/s)`**
    - **代表分组的电信号在链路上传输**，这也需要一定的时间，我们把这段时间称为**传播时延**
      - **计算公式：`信道长度(m) 除以 电磁波传播速率(m/s)`**
      - **电磁波在自由空间中的传播速率为`3*10的八次方m/s`；在网络传输媒体中的传播速率比在自由空间中要略低一些，在铜线电缆中约为`2.3*10的八次方m/s`，在光纤中的传播速率约为`2.0*10的八次方m/s`**
      - 因此，**要计算传播时延，首先应该确定采用的是什么传输媒体，进而确定电磁波在该传输媒体中的传播速率**
    - **路由器收到分组后，对其进行存储转发**，这也需要花费一定时间，我们称为**处理时延**
      - 一般不方便计算

- 时延带宽积

  - **指的是传播时延与带宽的乘积**（可以类比为体积）
  - 若发送端连续发送数据，则在发送的第一个比特即将到达终点时，发送端就已经发送了时延带宽积个比特
  - 链路的时延带宽积又称为**以比特为单位的链路长度**

- 往返时间

  - 在很多情况下，因特网上的信息不仅仅单方向传输，而是双向交互；我们有时候很需要知道双向交互一次所需的时间。因此，**往返时间RTT**（Round-Trip Time）也是一个重要的性能指标
  - **往返时间是指：从源主机发送分组开始，直到源主机收到来自目的主机的确认分组为止，所需要的时间**

- 利用率

  - 信道利用率
    - 用来表示某信道有百分之几的时间是被利用的（有数据通过）
  - 网络利用率
    - 全网络的信道利用率的加权平均
  - 根据排队论， 当某信道的利用率增大时，该信道引起的时延也会迅速增加。因此，**信道利用率并非越高越好**
  - 如果令**D0表示网络空闲时的时延，D表示网络当前的时延**，那么在适当的假定条件下，可以用下面的简单公式来表示**D、D0和利用率U之间的关系：`D = D0/(1-U)`**。以D为纵轴，U为横轴画图可知：
    - 当网络的利用率达到50%时，时延就要加倍
    - 当网络的利用率超过50%时，时延急剧增大
    - 当网络的利用率接近100%时，时延就趋于无穷大
    - 因此，一些拥有较大主干网的ISP通常会控制它们的信道利用率不超过50%。如果超过了，就要准备扩容，增大线路的带宽
  - 也不能使信道利用率太低，这会使宝贵的通信资源被白白浪费。应该使用一些机制，可以根据情况动态调整输入到网络中的通信量，使网络利用率保持在一个合理的范围内

- 丢包率

  - **丢包率即分组丢失率，是指在一定的时间范围内，传输过程中<u>丢失的分组数量与总分组数量的比率</u>**

  - 丢包率具体可分为接口丢包率、结点丢包率、链路丢包率、路径丢包率、网络丢包率等

  - 丢包率是网络运维人员非常关系的一个网络性能指标，但对于普通用户来说往往并不关心这个指标，因为它们通常意识不到网络丢包

  - 分包丢失主要有两种情况：

    - 分组在传输过程中出现**误码**，被结点丢弃
    - 分组到达一台队列已满的分组交换机时被丢弃；在通信量较大时就可能造成**网络拥塞**

  - 因此，丢包率反映了网络的拥塞情况：

    - 无拥塞时路径丢包率为0
    - 轻度拥塞时路径丢包率为1%~4%
    - 严重拥塞时路径丢包率为5%~15%

    





### 1.6 计算机网络体系结构

#### 1.6.1 常见的计算机网络体系结构

-  **OSI体系结构**
  - **从下往上依次是：物理层、数据链路层、网络层、运输层（自下而上第一个提供<u>端到端</u>服务的层次）、会话层、表示层、应用层**
  - 是法律上的国际标准
- **TCP/IP体系结构**
  - **从下往上依次是：网络接口层、网际层、运输层、应用层**
  - 是事实上的国际标准
  - 路由器一般只包含网际层和网络接口层
  - TCP/IP体系结构的网络接口层并没有规定什么具体的内容，目的是可以互连全世界各种不同的网络接口
  - **IP协议**是TCP/IP体系结构**网际层的核心协议**
  - **TCP和UDP**是TCP/IP体系**结构运输层的两个重要协议**
    - TCP协议在享受IP协议提供的网络互连服务的基础上，可**向应用层**的相应协议**提供可靠传输的服务**
    - UDP协议在享受IP**协议提供的网络互连服务的基础上**，可**向应用层**的相应协议**提供不可靠传输的服务**
  - IP协议一方面负责互连不同的网络接口（IP over everything）；另一方面为各种网络应用提供服务（Everything over IP）
- **原理体系结构**
  - **从下往上依次是：物理层、数据链路层、网络层、运输层、应用层**





#### 1.6.2 计算机网络体系结构分层的必要性

- 计算机网络是个非常复杂的系统。早在最初的ARPANET设计时就提出了分层的设计理念
- "分层"可将庞大而复杂的问题，转化为若干较小的局部问题，而这些较小的局部问题就比较易于研究和处理
- 下面将按照由简单到复杂的顺序，来看看计算机网络要面临哪些主要的问题，以及如何将这些问题划分到对应的层次，层层处理
- 比如：
  - 最简单的两台计算机通过一条网线连接起来，需要考虑：
    - 采用怎样的传输媒体（介质）
    - 采用怎样的物理接口
    - 使用怎样的信号表示比特0和1
    - 上面三个问题可以划归到物理层
  - 主机A,B,C,D,E通过总线互连，构成了一共总线型网络。假设已经解决了上面所说的物理层的问题，那么还需要考虑：
    - 如何标识网络中的各主机（主机编址问题，例如MAC地址）
    - 目的主机如何从信号所表示的一连串比特流中区分出地址和数据
    - 如何协调各主机争用总线
    - 上面的问题可以划归到数据链路层
  - 由三个路由器、四个网络互连起来的小型互连网
    - 如何表示各网络以及网络中的各主机（网络和主机共同编址的问题，例如IP地址）
    - 路由器如何转发分组，如何进行路由选择
    - 上面的问题可以划归到网络层
  - 如果主机运行着两个进程（浏览器进程和QQ进程），服务器运行着一个进程
    - 此时如果主机收到服务器发送的一个分组，那么这个分组该给哪个进程使用呢。这是如何解决进程之间基于网络的通信问题
    - 出现传输错误时，如何处理
    - 以上问题可以划归到运输层
  - 通过应用进程间的交互来完成特定的网络应用
    - 如支持万维网应用的HTTP协议
    - 支持电子邮件的SMTP协议
    - 支持文件传送的FTP协议
    - 上面的问题划归到应用层
- **总结：**
  - **物理层解决使用何种信号来传输比特的问题**
  - **数据链路层解决分组在一个网络（或一段链路）上传输的问题**
  - **网络层解决文组在多个网络上传输（路由）的问题**
  - **运输层解决进程之间基于网络的通信问题**
  - **应用层解决通过应用进程的交互来实现特定网络应用的问题**





#### 1.6.3 计算机网络体系结构分层思想举例

-  实例：主机属于网络N1，Web服务器属于网络N2

  - 如：`主机——N1——路由器——N2——Web服务器`
  - 使用主机中的浏览器访问服务器
  - 主机与服务器之间基于网络的通信，实际上是主机中的浏览器应用进程与Web服务器中的Web服务器应用进程之间基于网络的通信

- 体系中各层起到的作用（自上而下）：

  - 主机（用户端）

    - **应用层**按HTTP协议的规定，**构建一个HTTP请求报文**。应用层将该HTTP报文交给运输层处理
    - **运输层给HTTP请求报文添加一个TCP首部**，使之**成为TCP报文段**；该**首部的作用主要是为了区分应用进程以及实现可靠传输**。运输层将TCP报文段交给网络层处理
    - **网络层给TCP报文段添加一个IP首部**，使之**成为IP数据报**；该**首部的作用主要是为了使IP数据报可以在互连网上传输，也就是被路由器转发**。网络层将IP数据报交付给数据链路层处理
    - **数据链路层给IP数据报添加一个首部（ETH）和一个尾部（ETH）使之成为帧**；该**首部的作用主要是为了让帧能够在一段链路上或一个网络上传输，能够被相应的目的主机接收；尾部的作用是为了让目的主机检查所接收到的帧是否有误码。**数据链路层将帧交付给物理层
    - **物理层将帧看作是比特流**。由于网络N1是以太网，因此**物理层还会给该比特流前面添加前导码**。**其作用是为了让目的主机做好接收帧的准备**。**物理层将添加有前导码的比特流，变换成相应的信号发送到传输媒体**。
    - 信号通过传输媒体到达路由器

  - 路由器

    - **物理层将信号变换为比特流**，然后去掉前导码后，将其交付给数据链路层（实际上交付的是帧）。
    - **数据链路层将帧的首部和尾部去掉**后，将其交付给网络层（实际上交付的是IP数据报）
    - **网络层解析IP数据报的首部，从中提取出目的网络地址，然后查找自身的路由表，确定转发端口，以便进行转发**，网络层将IP数据报交付给数据链路层
    - **数据链路层给IP数据报添加一个首部（ETH）和一个尾部（ETH）使之成为帧**。数据链路层将帧交付给物理层
    - **物理层将帧看作是比特流**。由于网络N2是以太网，因此**物理层还会给该比特流前面添加前导码**。**其作用是为了让目的主机做好接收帧的准备**。**物理层将添加有前导码的比特流，变换成相应的信号发送到传输媒体**。
    - 信号通过传输媒体到达Web服务器

  - Web服务器

    - **物理层将信号变换为比特流**，然后去掉前导码后，将其交付给数据链路层（实际上交付的是帧）。
    - **数据链路层将帧的首部和尾部去掉**后，将其交付给网络层（实际上交付的是IP数据报）
    - **网络层将IP数据报的首部去掉**后，将其交付给运输层（实际上交付的是TCP报文段）
    - **运输层将TCP报文段的首部去掉**后，将其交付给应用层（实际上交付的是HTTP请求报文）
    - **应用层对HTTP请求报文进行解析，然后给主机发回HTTP响应报文**
    - 与上面类似，HTTP响应报文需要经过层层包装变为相应的信号，再通过传输媒体传输到路由器，路由器转发该响应报文给主机，主机通过物理层将收到的信号转换为比特流，之后通过逐层解封，最终取出HTTP响应报文

    





#### 1.6.4 计算机网络体系结构中的专用术语

- **实体**

  - **实体是指任何可发送或接收信息的<u>硬件或软件进程</u>**

  - **对等实体**：指收发双方**相同层次中的实体**

- **协议**

  - **协议是指控制两个对等实体进行逻辑通信的规则的集合**
  - 如：
    - 应用层使用HTTP,SMTP等进行通信
    - 运输层使用TCP,UDP等进行通信
    - 网络层使用IP进行通信
    - 链路层使用传统以太网CSMA/CD进行通信
    - 物理层协议（如传统以太网使用曼彻斯特编码）进行通信
  - 协议的三要素
    - 语法：定义通信双方所交换信息的格式
    - 语义：定义通信双方所要完成的操作
    - 同步：定义收发双方的时序关系

- **服务**

  - 在协议的控制下，两个对等实体间的逻辑通信使得本层能够向上一层提供服务（如物理层协议为数据链路层提供服务）

  - 要实现本层协议，还需要使用下面一层所提供的服务（如链路层享受物理层提供的服务，实现链路层协议并进行逻辑通信，给网络层提供服务；最后到应用层，应用层是给用户提供服务）

  - 协议是**"水平的"**，而服务是**"垂直的"**

  - 实体看得见相邻下层所提供的服务，但并不知道实现该服务的具体协议。也就是说，下面的协议对上面的实体是**"透明"**的

  - **服务访问点**：指在统一系统中，**相邻两层的实体交换信息的逻辑接口**，用于区分不同的服务类型

    - 如数据链路层的服务访问点为帧的"类型"字段
    - 网络层的服务访问点为IP数据报首部中的"协议字段"
    - 运输层的服务访问点为"端口号"

  - **服务原语**：**上层使用下层所提供的服务**，必须通过与下层**交换一些命令**，这些命令称为服务原语

  - **协议数据单元PDU**：**对等层次之间传送的数据包**称为该层的协议数据单元

    - 如物理层的数据包为：比特流（bit stream）
    - 数据链路层的数据包为：帧（frame）
    - 网络层的数据包为：IP数据或分组（packet）
    - 运输层的数据包为：TCP报文段（segment）或UDP用户数据报（datagram）
    - 应用层的数据包为：报文（message）

  - **服务数据单元SDU**：**同一系统内，层与层之间交换的数据包**称为服务数据单元

  - **多个SDU可以合成为一个PDU；一个SDU也可划分为几个PDU**

    







## 二.物理层

### 2.1 物理层的基本概念

- 传输媒体
  - 导引型传输媒体
    - 双绞线
    - 同轴电缆
    - 光纤
  - 非导引型传输媒体
    - 微波通信（2~40GHz）
- 物理层协议的主要任务
  - **机械特性**：指明接口所用接线器的**形状和尺寸**、**引脚数目和排列**、**固定和锁定装置**
  - **电气特性**：指明在接口电缆的各条线上出现的**电压的范围**
  - **功能特性**：指明某条线上出现的某一电平的**电压表示何种意义**
  - **过程特性**：指明对于不同功能的各种可能**事件的出现顺序**
- 物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流
- 物理层为数据链路层屏蔽了各种传输媒体的差异，使数据链路层只需要考虑如何完成本层的协议和服务，而不必考虑网络具体的传输媒体是什么





### 2.2 物理层下面的传输媒体

#### 2.2.1 导引型传输媒体

- 电磁波被导引沿着固体媒体传播

- 常见的导引型传输媒体：

  - 同轴电缆
  - 双绞线
  - 光纤
  - 电力线

  

- **同轴电缆**

  - 从内到外有：内导体、绝缘层、屏蔽层、绝缘保护套层（因为都是同轴的所以称为同轴电缆）
  - 有两种，分别为：
    - 基带同轴电缆（50Ω）：数据传输，过去用于局域网
    - 宽带同轴电缆（75Ω）：模拟传输，目前主要用于有线电视
  - 同轴电缆价格较贵且布线不够灵活和方便，随着集线器的出现，在局域网领域基本上都是采用双绞线作为传输媒体

  

- **双绞线**

  - 有两种，分别为：

    - 无屏蔽双绞线UTP电缆
    - 屏蔽双绞线STP电缆（比无屏蔽双绞线UTP电缆**增加了金属丝编织的屏蔽层，提高了抗电磁干扰的能力**）

  - **绞合规则**

    - 蓝和蓝白
    - 橙和橙白
    - 绿和绿白
    - 棕和棕白

  - <u>**绞合的作用**</u>

    - 抵御部分来自外界的电磁波干扰
    - 减少相邻导线的电磁干扰

  - | 绞合线类别   | 带宽   | 线缆特点                  | 典型应用                               |
    | ------------ | ------ | ------------------------- | -------------------------------------- |
    | 3            | 16MHz  | 2对4芯双绞线              | 模拟电话；曾用于传统以太网（10Mbit/s） |
    | 4            | 20MHz  | 4对8芯双绞线              | 曾用于令牌局域网                       |
    | 5            | 100MHz | 与4类相比增加了绞合度     | 传输速率不超过100Mbit/s的应用          |
    | 5E（超五类） | 125MHz | 与5类相比衰减更小         | 传输速率不超过1Gbit/s的应用            |
    | 6            | 250MHz | 与5类相比改善了串扰等性能 | 传输速率高于1Gbit/s的应用              |
    | 7            | 600MHz | 使用屏蔽双绞线            | 传输速率高于10Gbit/s的应用             |

  

- 光纤

  - 一根光缆少则一根光纤，多则数十甚至数百条光纤
  - 纤芯直径
    - 多模光纤：50微米，62.5微米
    - 单模光纤：9微米
  - 包层直径125微米
  - 工作波长：
    - 0.85微米（衰减较大）
    - 1.30微米（衰减较小）
    - 1.55微米（衰减较小）
  - 光纤的优点：
    - 通信容量大（25000~30000GHz的带宽）
    - 传输损耗小，远距离传输时更加经济
    - 抗雷电和电磁干扰性好。这在大电流脉冲干扰的环境下尤为重要
    - 无串音干扰，保密性好，不易被窃听
    - 体积小，重量轻
  - 光纤的缺点：
    - 割接需要专用设备
    - 光电接口价格较贵
  - 光在光纤中传输的基本原理
    - 光纤包含：纤芯（非常透明的石英玻璃拉成细丝，直径8~100微米），包层（折射率比纤芯低的玻璃封套，直径125微米）
    - 在发送端，可以采用发光二极管或半导体激光器作为光源
    - 在接收端，可以采用光电二极管或激光检波器检测光脉冲
    - 当光从**高折射率**的媒体射**向低折射率**的媒体时，其**折射角将大于入射角**；因此，如果**入射角足够大**，就会**出现全反射**，即光碰到包层时，就会反射回纤芯
    - **光在纤芯中传输的方式是不断地全反射**
    - **如果可以存在多条不同角度入射的光线在一条光纤中传输，这种光纤称为多模光纤**
      - 由于色散（模式、材料、波导色散），光在多模光纤中传输一定距离后必然产生信号失真（**脉冲展宽**）
      - 因此，多模光纤只适合**近距离传输**（建筑物内）。
      - 发送光源：发光二极管；接收检测：光电二极管
    - **如果光纤的直径减小到只有一个光的波长，则光纤就像一个波导那样，可以使光线一直向前传播，而不会产生多次反射，这种光纤叫做单模光纤**
      - **没有模式色散**，在1.31微米波长附近材料色散和波导色散大小相等符号相反，两者正好抵消
      - 单模光纤适合**长距离传输**且衰减小，但其制造成本高，对光源要求高
      - 发送光源：激光发生器；接收检测：激光检波器





#### 2.2.2 非导引型传输媒体

- 常见的非导引型传输媒体：

  - 无线电波
  - 微波
  - 红外线
  - 可见光

- 国际电信联盟ITU对电磁波频段的划分

  | ITU波段号 | 频段名称 | 缩写 | 频率范围       | 波段名称 | 波长范围           | 用途                                     | 电磁波谱对应名称 |
  | --------- | -------- | ---- | -------------- | -------- | ------------------ | ---------------------------------------- | ---------------- |
  | 1         | 极低频   | ELF  | 3Hz ~ 30Hz     | 极长波   | 100000km ~ 10000km | 潜艇通讯或直接转换成声音                 |                  |
  | 2         | 超低频   | SLF  | 30Hz ~ 300Hz   | 超长波   | 10000km ~ 1000km   | 直接转换成声音或交流输电系统（50~60Hz）  |                  |
  | 3         | 特地频   | ULF  | 300Hz ~ 3kHz   | 特长波   | 1000km ~ 100km     | 矿场通讯或直接转换成声音                 |                  |
  | 4         | 甚低频   | VLF  | 3kHz ~ 30kHz   | 甚长波   | 100km ~ 10km       | 直接转换成声音、超声，地球物理学研究     |                  |
  | 5         | 低频     | LF   | 30kHz ~ 300kHz | 长波     | 10km ~ 1km         | 国际广播，全向信标                       | 无线电波         |
  | 6         | 中频     | MF   | 300kHz ~ 3MHz  | 中波     | 1km ~ 100m         | 调幅(AM)广播，全向信标，海事及航空通讯   | 无线电波         |
  | 7         | 高频     | HF   | 3MHz ~ 30MHz   | 短波     | 100m ~ 10m         | 短波、民用电台                           | 无线电波         |
  | 8         | 甚高频   | VHF  | 30MHz ~ 300MHz | 米波     | 10m ~ 1m           | 调频（FM）广播，电视广播，航空通讯       | 无线电波         |
  | 9         | 特高频   | UHF  | 300MHz ~ 3GHz  | 分米波   | 1m ~ 100mm         | 电视广播，无线电话通讯，无线网络，微波炉 | 微波             |
  | 10        | 超高频   | SHF  | 3GHz ~ 30GHz   | 厘米波   | 100mm ~ 10mm       | 无线网络，雷达，人造卫星接收             | 微波             |
  | 11        | 极高频   | EHF  | 30GHz ~ 300GHz | 毫米波   | 10mm ~ 1mm         | 射电天文学，遥感，人体扫描安检仪         | 微波             |

- 无线电波

  - 低频和中频主要利用地面波进行传输
  - 高频和甚高频，主要考电离层的反射

- **微波**

  - 主要使用2~40GHz的频率范围
  - 在空间主要是直线传播
  - 由于微波会穿透电离层而进入宇宙空间，因此他不能经过电离层的反射传播到地面上很远的地方
  - 传统的微波通信主要有两种方式：
    - **地面微波接力通信**
    - **卫星通信**。特点是通信距离远，但传播时延也比较大

- 红外线

  - 如家用电器的红外遥控器
  - 点对点传输
  - 直线传输，中间不能有障碍物，传输距离短
  - 传输速率低（4Mb/s~16Mb/s）





### 2.3 传输方式

#### 2.3.1 串行传输和并行传输

- 串行传输：指数据是一个比特一个比特一次发送的。在发送端和接收端之间只需要一条线路。
- 并行传输：指一次发送n个比特而不是一个比特。在发送端和接收端之间需要有n条线路
- 并行传输的优点是速度为串行传输的n倍，缺点是成本高



#### 2.3.2 同步传输和异步传输

- **同步传输：数据以稳定的比特流的形式传说，字节之间没有间隔**
  - 接收端在每个比特信号的中间时刻进行检测，以判别接收到的是比特0还是比特1
  - 在传输大量数据的过程中，所产生的判别时刻的累积误差，会导致接收端对比较信号的判别错位。因此需要采取方法使收发双方的时钟保持同步
  - 实现手法双方时钟同步的方法主要有两种：
    - 外同步：在收发双方之间添加一条单独的时钟信号线
    - 内同步：发送端将始终同步信号编码到发送数据中一起传输（例如曼彻斯特编码）
- **异步传输：以字节为独立的传输单位，字节之间的时间间隔不是固定的，接收端仅在每个字节的起始处对字节内的比特实现同步。**为此，**通常要在每个字节前后加上起始位和结束位**
  - 异步是指：字节之间异步（字节之间的时间间隔不固定）
  - 字节中的每个比特仍然要同步（各比特的持续时间是相同的)





#### 2.3.3 单向通信（单工）和双向交替通信（半双工）和双向同时通信（全双工）

-  **单工通信**

  - 又称单向通信，**通信双方只有一个数据传输方向**。
  - 只需要一条信道

- **半双工**

  - 又称双向交替通信，**通信双方可以相互传输数据，但不能同时进行**
  - 需要两条信道

- **全双工**

  - 又称双向同时通信，**通信双方可以同时发送和接受信息**
  - 需要两条信道

  



### 2.4 编码与调制

#### 2.4.1 基本介绍

- **需要发送的文字、图片、音频、视频可以统称为消息**，计算机将消息的比特0和比特1变换成相应的电信号发送到网线。**由信源发送的原始电信号称为基带信号**
- 基带信号可分为两类
  - 数字基带信号（如计算机内部CPU与内存之间传输的信号）
  - 模拟基带信号（如麦克风收到声音后产生的音频信号）
- 信号需要在信道中进行传输。**信道可分为数字信道和模拟信道**
- **<u>在不改变信号性质的前提下，仅对数字基带信号的波形进行变换，称为编码</u>。编码后产生的信号仍为数字信号，可以在数字信道中传输**
- **<u>把数字基带信号的频率范围搬移到较高的频段，并转换为模拟信号，称为调制</u>。调制后产生的信号是模拟信号，可以在模拟信道中传输**
- **码元：在使用时间域的波形表示数字信号时，<u>代表不同离散数值的基本波形</u>**（简单来说，码元就是构成信号的一个波形）



#### 2.4.2 常用编码

- 如何判断一段信号中码元的个数（**不归零编码**:即不存在零电平的编码）

  - 需要**额外一根传输线来传输时钟信号**，使发送方和接收方同步
  - 对于计算机网络，**宁愿使用这根传输线传输数据信号**，而不是传输时钟信号

- **归零编码**

  - **每个码元传输结束后信号都要"归零"**，所以接收方只要在信号归零后进行采样即可，不需要单独的时钟信号
  - 实际上，归零编码相当于把时钟信号用"归零"方式编码在了数据之内，这成为"**自同步**"信号
  - 但是，归零编码中大部分的**数据带宽**，都用来传输"归零"而**浪费**掉了

- **曼彻斯特编码**

  - 码元中间时刻的跳变既表示时钟，又表示数据

- **差分曼彻斯特编码**

  - 在每个码元时间的中间时刻，信号都会发生跳变
  - 但是跳变仅表示时钟
  - 用码元开始处电平是否发生变化表示数据

  

#### 2.4.3 调制方法

- 基本调制方法

  - **调幅（AM）**
    - 用无载波输出表示比特0，有载波输出表示比特1
  - **调频(FM)**
    - 用不同频率的信号表示，比如频率f1表示比特0，频率f2表示比特1
  - **调相（PM）**
    - 用初相位0度的波形表示比特0，用初相位180度的波形表示比特1
  - 但是使用基本调制方法，1个码元只能包含1个比特信息。如何能使1个码元包含更多的比特呢？

- 混合调制

  - 因为**频率和相位是相关**的，即频率是相位随时间的变化率。所以**一次只能调制频率和相位两个中的一个**

  - 通常情况下，相位和振幅可以结合起来一起调制，称为**正交振幅调制QAM**

  - 举例：QAM-16

    - 12种相位

    - 每种相位有1或2种振幅可选

    - 可以调制出16种码元（波形），每种码元可以对应4个比特

    - 码元与4个比特的对应关系采用格雷码（格雷码指的是任意两个相邻码元只有1个比特不同）

      



### 2.5 信道的极限容量

- **当输入信号通过通信质量较差的信道时，此时失真严重，在输出端无法识别信号的0和1，信号波形失去了码元之间的清晰界限，这种现象叫做码间串扰**

- **产生失真的因素**

  - 码元传输速率
  - 信号传输距离
  - 噪声干扰
  - 传输媒体质量

- **奈氏准则**

  - 在假定的理想条件下，**为了避免码间串扰，码元传输速率是有上限的**
  - 理想低通信道的最高码元传输速率 = 2W Baud
  - 理想带通信道的最高码元传输速率 = W Baud
    - W： 信道带宽（单位为Hz）
    - Baud： 波特，即码元/秒
  - **码元传输速率又称为波特率、调制速率、波形速率或符号速率。**它与比特率有一定关系：
    - 当1个码元只携带1比特的信息量时，则波特率（码元/秒）与比特率（比特/秒）在数值上是相等的
    - 当1个码元携带n比特的信息量时，则波特率转换成比特率时，数值要乘以n
  - **要提高信息传输速率（比特率），就必须设法使每一个码元能携带更多个比特的信息类。这需要采用多元制**
  - 实际的信道所能传输的最高码元速率，要明显低于奈氏准则给出的这个上限数值
  - 那么这么看，只要采用更好的调制方法，让码元可以携带更多的比特，岂不是可以无限制地提高信息的传输速率？
    - 答案是否定的。因为**信道的极限信息传输速率还要受限于**实际的信号在信道种传输时的**信噪比**

- 香农公式

  - **带宽受限且有高斯白噪声干扰的信道的极限信息传输速率**。公式：`c = W * log2(1 + S/N)`
    - c：信道的极限信息传输速率（单位：b/s）
    - W：信道带宽（单位：Hz）
    - S：信道内所传信号的平均功率
    - N：信道内的高斯噪声功率
    - S/N：信噪比，使用分贝（dB）作为度量单位
      - 信噪比（dB） = 10 * log10(S/N) (dB)
  - 信道带宽或信道中信噪比越大，信息的极限传输速率就越高
  - 在实际信道上能够达到的信息传输速率要比该公式的极限传输速率低比绍。这是因为在实际信道中，信号还要受到其他一些损伤，如各种脉冲干扰、信号在传输中的衰减和失真等，这些因素在香农公式中并未考虑

- 在信道带宽一定的情况下，根据奈氏准则和香农公式，想要**提高信息的传输速率**就必须采用**多元制**（更好的调制方法）和努力**提高信道中的信噪比**

- 自从香农公式发表后，各种**新的信号处理和调制方法就不断出现**，其目的都是为了尽可能地**接近香农公式给出的传输速率极限**

  







## 三.数据链路层

### 3.1 数据链路层概述

- **链路**（Link）就是从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点
- **数据链路**（Data Link）是指把实现通信协议的硬件和软件加到链路上，就构成了数据链路
- 数据链路层以**帧**为单位传输和处理数据
- **数据链路层的三个重要问题**
  - 封装成帧
    - 在包装数据的时候，网络层会给数据链路层一个网络层协议数据单元。此时，数据链路层会对其添加一个数据链路层协议首部，称为帧头；还要添加一个帧尾。**这个添加帧头和帧尾的操作，称为封装成帧**
    - 添加帧头和帧尾的目的，都是为了在链路上以帧为单元来传送数据，也就是为了实现数据链路层本身的功能
  - 差错检测
    - 发送方将封装好的帧通过物理层发送到传输媒体。帧在传输过程中遭遇干扰后可能会出现误码。那么接收方主机如何判断帧在传输过程中是否出现了误码？可以通过检错码来发现
    - **发送方在发送帧之前，基于待发送的数据和检错算法计算出检错码，并将其封装在帧尾。接收方主机收到帧后，通过检错码和检错算法，就可以判断出帧在传输过程中是否出现了误码**
  - 可靠传输
    - 接收方主机收到有误码的帧后，不会接收该帧，会将其丢弃。
    - 如果数据链路层向其上提供的是不可靠服务，那么丢弃了也没事
    - 如果数据链路层向其上提供的是可靠服务，那么就还需要其他设施可以接收到被丢弃的这个帧的正确版本
    - **倘若发送方发送什么，接收端最终收到什么，就称为可靠传输**
- **对于使用广播信道的数据链路层**，除了上面三个问题外，还有其他问题要解决：
  - **当多台主机连接在同一根总线上**时，接收主机如何直到该帧是发送给它的？
    - 在帧头加上目的地址和源地址
  - 当总线上多台主机同时使用总线来传输帧时，**传输信号就会产生碰撞**
    - 以太网的解决方法：**使用一种特殊的协议CSMA/CD**，也就是**载波监听多点接入/碰撞检测**
    - 802.11局域网的媒体介入**控制协议CSMA/CA**，也就是**载波监听多点接入/碰撞避免**
- 对于使用点对点链路和链路层交换机的交换式局域网，在有线（局域网）领域已完全取代了共享式局域网。那么**网络中的交换机又是如何转发帧的呢？**
  - 涉及到网桥和交换机的工作原理
  - 集线器（物理层互连设备）与交换机的区别





### 3.2 封装成帧

- **封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧**
  - 帧头和帧尾中包含有重要的控制信息
  - 帧头和帧尾的作用之一就是**帧定界**
    - 数据接收方可以根据帧头和帧尾的帧定界标志，从一串比特流中提取出一个个的帧（PPP帧格式）
    - 如果是MAC帧格式，则是在数据链路层将帧交付给物理层之后，物理层在MAC帧中添加前导码，然后再将比特流转换成电信号发送
- 透明传输是指**数据链路层对上层交付的传输数据没有任何限制**，就好像数据链路层不存在一样
  - 面向字节的物理链路 使用字节填充（或称字符填充）的方法实现透明传输
  - 面向比特的物理链路 使用比特填充的方法实现透明传输
- 为了提高帧的传输效率，应当使**帧的数据部分的长度尽可能大些**
- 考虑到差错控制等多种因素，每一种数据链路层协议都规定了帧的数据部分的长度上限，即**最大传送单元MTU**（Maximum Transfer Unit)





### 3.3 差错检测

- 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错：1可能会变成0，而0也可能会变成1。这称为**比特差错（或误码）**

- 在一段时间内，传输错误的比特占所传输的比特总数的比率称为**误码率BER（Bit Error Rate）**

- 使用**差错检测码**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一

- **奇偶校验**

  - 在待发送的数据后面**添加1位奇偶校验位**，使整个数据（包括所添加的校验位在内）中**"1"的个数**为奇数（奇校验）或偶数（偶校验）
  - 如果有**奇数个位发生误码**，则奇偶性发生变化，**可以检查出误码**
  - 如果有**偶数个位发生误码**，则奇偶性不发生变化，**不能检查出误码（漏检）**

- **循环冗余校验CRC（Cyclic Redundancy Check）**

  - 收发双方约定好一个**生成多项式G(x)**
    - **生成多项式必须包含最低次项（常数项）**
  - 发送方基于待发送的数据和生成多项式计算出差错检测码（**冗余码**），将其添加到待传输数据的后面一起传输
    - 冗余码计算：**`待发送的数据 后面添加 生成多项式最高次个0 / 生成多项式各项系数构成的比特串`的<u>余数</u>就是计算出的冗余码**
    - 冗余码的长度与 生成多项式的最高次数相同
    - **注意：/表示异或运算**
  - 接收方通过生成多项式来计算收到的数据是否产生了误码
    - 接收方的处理：**`已接收的数据 后面添加 余数（冗余码） / 生成多项式各项系数构成的比特串`**，**得到余数**
    - **如果余数为0，可判定传输过程没有产生误码；如果余数不为0，可判定传输过程产生了误码**

- **检错码**只能检测出帧在传输过程中出现了差错，但并不能定位错误，因此**无法纠正错误**

- 要想纠正传输中的差错，可以使用冗余信息更多的**纠错码**进行**前向纠错**。但纠错码的开销比较大，在**计算机网络中较少使用**

- 循环冗余校验**CRC**有很好的检错能力（**漏检率非常低**），虽然计算较为复杂，但非常**易于用硬件实现**，因此被**广泛应用于数据链路层**

- 在计算机网络中通常采用后续课程中要讨论的**检错重传方式来纠正传输中的差错**，或者**仅仅是丢弃检测到差错的帧**，这取决于数据链路层向其上层提供的是可靠传输服务还是不可靠传输服务

  



### 3.4 可靠传输

#### 3.4.1可靠传输的基本概念

- 使用**差错检测技术**（例如循环冗余校验CRC），接收方的数据链路层就可检测出帧在传输过程中是否产生了**误码**（比特错误）

- 数据链路层向上层提供的服务类型

  - **不可靠传输服务**：**仅仅丢弃有误码的帧**，其他上面都不做
  - **可靠传输服务**：想办法实现**发送端发送什么，接收端就收到什么**

- 一般情况下，**有线链路**的误码率比较低，为了减小开销，并**不要求数据链路层**向上提供**可靠**传输服务。即使出现了误码，可靠传输的问题由其上层处理

- **无线链路**易受干扰，误码率比较高，因此**要求数据链路层**必须向上层提供**可靠**传输服务

- 传输差错

  - **比特差错**只是传输差错中的一种
  - 从整个计算机网络体系结构来看，传输差错还包括**分组丢失、分组失序和分组重复**
  - 分组丢失、分组失序以及分组重复这些传输差错，一般不会出现在数据链路层，而会出现在其上层

- **可靠传输服务并不局限于数据链路层**，其他各层均可选择实现可靠传输

- 可靠传输的实现比较复杂，开销也比较大，是否使用可靠传输取决于应用需求

  





#### 3.4.2 可靠传输的实现机制 — 停止-等待协议SW(Stop-and-Wait)

- 像停止-等待协议这种通过确认和重传机制实现的可靠传输协议，通常称为自动请求重传协议ARQ，意思是重传的请求是自动进行的。（因为不需要接收方显示的请求发送方重传某个出错的分组）

- 发送方发送给接收方一个DATA分组，然后**停止，等待接收方返回分组**

  - 如果接收方收到了，且**没有误码**，那就返回一个**ACK分组**；如果**有误码**，就返回一个**NAK分组**
  - 等到发送方收到了ACK或者NAK，才会发送下一个DATA分组

- 如果接收方收不到数据分组，就不会发送ACK或NAK。如果不采取其他措施，发送方就会一直处于等待接收方ACK或NAK的状态

  - 为解决该问题，可以在发送方发送完一个数据分组时，启动一个**超时计时器**。若到了超时计时器所设置的**重传时间**而发送方仍收不到接收方的ACK或NAK，则重传原来的数据分组，这就叫做**超时重传**
  - 一般可将重传时间选为略大于"从发送方到接收方的平均往返时间"

- 为**避免分组重复**这种传输错误，必须给**每个分组带上序号**

  - 对于停止-等待协议，由于每发送一个数据分组就停止等待，只要保证每发送一个新的数据分组，其发送序号与上次发送的数据分组的序号不同就可以了，因此用**一个比特来编号就够了**

- 注意事项：

  - 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传。但对于误码率较高的点对点链路，为使发送方**尽早重传**，也可**给发送端发送NAK分组**
  - 为了让接收方能够判断所收到的的数据分组是否重复的，需要给**数据分组编号**。由于等待-停止协议的停等特性，**只需1个比特编号**就够了，即变化0和1
  - 为了让发送方能够判断所受到的ACK分组是否是重复的，需要给**ACK分组编号**，所用比特数量**与数据分组编号所用比特数量一样**。数据链路层一般不会出现ACK分组迟到的情况，因此在**数据链路层实现停止-等待协议可以不用给ACK分组编号**
  - 超时计时器设置的**重传时间**应仔细选择。一般可将重传时间选为**略大于"从发送方到接收方的平均往返时间"**
    - 在数据链路层点对点的往返时间比较确定，重传时间比较好设定
    - 然而在运输层，由于端到端往返时间非常不确定，设置合适的重传时间有时并不容易

- 停止-等待协议的信道利用率

  - **设Td为发送方发送数据分组所耗费的发送时延，RTT为收发双方之间的往返时间，TA是接收方发送确认分组所耗费的发送时延**；则从发送一个数据分组到可以发送下一个数据分组所用的**总时间为：Td+RTT+TA**
  - 信道利用率为：`Td / Td+RTT+TA`（可以忽略TA，因为TA一般都远远小于Td）
    - **当往返时延RTT远大于数据帧发送时延Td时（例如使用卫星链路），信道利用率非常低**
    - 若出现重传，则对于传送有用的数据信息来说，信道利用率还要降低
    - 为了客服停止-等待协议信道利用率很低的缺点，就产生了另外两种协议，即后退N帧协议GBN和选择重传协议SR

  

  



#### 3.4.3 可靠传输的实现机制—回退N帧协议GBN（Go-Back-N）

- 示例：

  - 若采用3个比特给分组编序号，即序号0~7
  - 则发送窗口的尺寸WT的取值为：**1 < WT <= 2的三次方 -1**，本例取WT=5
    - 发送窗口内的分组可以发送
    - **若WT=1，则就是停止-等待协议**
    - **若WT超过取值范围的上限，会造成很严重的后果**
  - 接收窗口的尺寸WR的取值为：WR=1
    - 每成功接收一个分组，可以返回信息，然后WT下滑一格

- 累计确认

  - 接收方**不一定**要对收到的数据分组**逐个发送确认**，而是可以在收到几个数据分组后（由具体实现决定），**对按序到达的最后一个数据分组发送确认**。**ACKn表示序号为n及以前的所有数据分组都已正确接收**
  - 累计确认的优点：即使确认分组（接收方返回的分组）丢失，发送方也可能不必重传
  - 累计确认的缺点：不能向发送方及时反映出接收方已经正确接收的数据分组的信息

- 比如发送分组1，0，7，6，5， 若发送的分组5出现误码

  - 接收方会将分组5丢弃，并且返回给发送方ACK4
  - 因为分组5被丢弃，但此时接收窗口在5处，1、0、7、6都不符合，故都被丢弃了，并且返回4个ACK4
  - 发送方收到重复的确认，就知道之前所发送的数据分组出现了差错，于是可以不等超时器超时就立刻重传
  - 至于收到几个重复确认就立刻重传，由具体实现决定
  - **在本例中，尽管序号为6、7、0、1的数据分组正确到达接收方，但是由于5号分组误码不被接受，它们也"受到牵连"而不被接受，发送方还要重传这些数据分组，这就是所谓的Go-Back-N（回退N帧）**
  - 可见，当通信线路质量不好时，回退N帧协议的信道利用率并不比停止-等待协议高

- 若WT超过取值范围的上限，会出现什么情况？

  - 接收方无法分辨新、旧分组，进而会产生分组重复这种传输差错

- **回退N帧协议在流水线传输的基础上利用发送窗口来限制发送方连续发送数据分组的数量，是一种连续ARQ协议**

- **在协议的工作过程中发送窗口和接收窗口不断向前滑动，因此这类协议又称为滑动窗口协议**

- **小结**

  - 发送方
    - 发送窗口尺寸WT的取值范围是**1 < WT <= 2的n次方 -1**
      - 其中，n是构成分组序号的比特数量
      - 若WT=1，则就是停止-等待协议
      - 若WT > 2的n次方-1，则接收方无法分辨新、旧分组
    - 发送方可在未收到接收方确认分组的情况下，将序号落在发送窗口内的多个数据分组全部发送出去
    - 发送方**只有收到**对已发送数据分组的**确认时**，**发送窗口才能向前相应滑动**
    - 发送方**收到多个重复确认时**，**可**在重传计时器超时前**尽早开始重传**，由具体实现决定
    - **发送方发送窗口内某个已发送的数据分组产生超时重发时，其后续在发送窗口内且已发送的数据分组也必须全部重传，这就是回退N帧协议名称的由来**
    - d
  - 接收方
    - 接收方的接收窗口尺寸WR的取值范围是WR=1，因此**接收方只能按序接收数据分组**
    - 接收方只接受序号落在接收窗口内且无误码的数据分组，并且将接收窗口向前滑动一个位置，于此同时给发送方发回相应的确认分组。为了减小开销，**接收方不一定每收到一个按序到达且无误码的数据分组就给发送方发回一个确认分组**
      - **而是可以在连续收到好几个按序到达且无误码的数据分组后（由具体实现决定），才针对最后一个数据分组发送确认分组，这称为累积确认**
      - 或者可以在自己有数据要发送时才对之前按序且无误码的数据分组进行捎带确认
    - 接收方收到未按序到达的数据分组，除丢弃外，还要对最近按序接收的数据分组进行确认

  





#### 3.4.4 可靠传输的实现机制 — 选择重传协议SR（Selective Request）

- 在回退N帧协议中，接收窗口的尺寸WR只能等于1，这样一个数据分组的误码就会导致其后面多个数据分组被丢弃，这对通信资源很是浪费

  - 为了进一步提高性能，可设法只重传出现误码的数据分组。因此，**接收窗口的尺寸<u>WR不应再等于1（而应大于1）</u>，以便<u>接收方先收下失序到达但无误码并且序号落在接收窗口内的那些数据分组</u>，等到所缺分组收齐后再一并送交上层。这就是<u>选择重传协议</u>**
  - **注意：<u>选择重传协议</u>为了使发送方仅重传出现差错的分组，接收方<u>不能再采用累积确认</u>，而需要对每个正确接收到的数据分组进行<u>逐一确认</u>**

- **发送方的发送窗口尺寸必须满足：`1 < WT < 2的（n-1）次方`**

  - 其中n是构成分组序号的比特数量
  - 若WT=1，则与停止-等待协议相同
  - 若WT>2的（n-1）次方，则会造成接收方无法辨析新旧数据分组的问题

- **接收方的接收窗口尺寸必须满足：`1 < WR <= WT`**

  - 若WR=1，则与回退N帧协议相同
  - 若WR > WT，则没有意义

- **小结**

  - 发送方

    - **发送方的发送窗口尺寸必须满足：`1 < WT < 2的（n-1）次方`**
      - 其中n是构成分组序号的比特数量
      - 若WT=1，则与停止-等待协议相同
      - 若WT>2的（n-1）次方，则会造成接收方无法辨析新旧数据分组的问题
    - **发送方可在<u>未收到接收方确认分组</u>的情况下，将序号落在发送窗口内的多个数据分组全部发送出去**
    - 发送方**只有按序收到**对已发送数据分组的确认时，发送窗口**才能向前相应滑动**；**若收到未按序到达的确认分组时，对其进行记录，以防止其相应数据分组的超时重发，但发送窗口不能向前滑动**

  - 接收方

    - **接收方的接收窗口尺寸必须满足：`1 < WR <= WT`**

      - 若WR=1，则与回退N帧协议相同
      - 若WR > WT，则没有意义

    - **接收方可接收<u>未按序到达但没有误码并且序号落在接收窗口内</u>的数据分组**

      - 为了使发送方仅重传出现差错的分组，接收方**不能再采用累计确认**，而需要对每个正确接收到的数据分组进行**逐一确认**

    - **接收方只有在按序接收数据分组后，接收窗口才能向前相应滑动**

      





### 3.5 点对点协议PPP

- 点对点协议PPP（Point-to-Point Protocol）是目前使用最广泛的点对点数据链路层协议

- PPP协议在点对点链路传输各种协议数据报提供了一个标准方法，主要由以下三部分构成：

  - 对各种协议数据报的封装方法（封装成帧）
  - 链路控制协议LCP——用于建立、配置以及测试数据链路的连接
  - 一套网络控制协议NCPs——其中的每一个协议支持不同的网络层协议

- 帧格式

  - 帧的首部
    - 标志（Flag）字段：PPP帧的定界符，取值为0x7E
    - 地址（Address）字段：取值为0xFF，预留（目前没什么作用）
    - 控制（Control）字段：取值为0x03，预留（目前没什么作用）
    - 协议（Protocol）字段：指明帧的数据部分送交哪个协议处理
      - 取值0x0021表示：帧的数据部分为IP数据报
      - 取值0xC021表示：帧的数据部分为LCP分组
      - 取值0x8021表示：帧的数据部分为NCP分组
  - 帧的尾部
    - 帧检验序列（Frame Check Sequence）字段：CRC计算出的校验位

- 透明传输

  - 对于面向字节的异步链路

    - 采用字节填充法，插入"转义字符"
    - 发送方的处理：
      - 出现的每一个**7E**（PPP帧的定界符）字节转变成2字节序列（**7D，5E**）
      - 出现的每一个**7D**（转义字符）字节转变成2字节序列（**7D,5D**）
      - 出现的每一个ASCll码控制字符（**数值小于0x20的字符**），则在该字符前面插入一个**7D**字节，同时将该字符的编码**加上0x20**
    - 接收方的处理：进行**反变换**即可恢复出原来的帧的数据部分

  - 对于面向比特的同步链路

    - 采用比特填充发，插入"比特0"

    - 发送方的处理：

      - 对帧的数据部分进行扫描（一般由硬件实现）。只要发现**5个连续的比特1**，则立即**填充1个比特0**

    - 接收方的处理：

      - 对帧的数据部分进行扫描（一般由硬件实现）。只要发现**5个连续的比特1**，就**把其后的1个比特0删除**

      

- 差错检测

  - 采用的多项式：`CRC-CCITT = X的16次方 + X的12次方 + X的5次方 + 1`
  - 接收方每收到一个PPP帧，就进行CRC检验。若CRC检验正确，就收下这个帧；反之，就丢弃这个帧。使用PPP的数据链路层**向上不提供可靠传输服务**

- 工作状态

  - 开始是**静止状态**，当检测到载波并建立物理层连接，进入**建立状态**；
  - 此时链路控制协议LCP开始协商一些配置选项
    - 配置选项：
      - 最大帧长
      - 鉴别协议
        - 无需鉴别
        - 口令鉴别协议PAP
        - 挑战握手鉴别协议CHAP
    - 若协商成功，进入**鉴别状态**
    - 若协商失败，退回到**静止状态**
  - 进入**鉴别状态**后
    - 若无需鉴别或鉴别成功，则进入**网络状态**
    - 若鉴别失败，则进入**终止状态**
  - 进入**网络状态**后
    - 进行NCP配置，进入**打开状态**
      - NCP配置：PPP链路的两端互相交换网络层特定的NCP分组。如果在PPP链路上运行的是IP，则使用IP控制协议IPCP来对PPP链路的每一端配置IP模块（如分配IP地址）
  - 进入**打开状态**后
    - **就可以进行数据通信**
    - 如果出现故障或终止请求时，就进入**终止状态**
  - 进入**终止状态**后
    - 当载波停止时，就进入**静止状态**

  



### 3.6 媒体接入控制

#### 3.6.1 媒体接入控制的基本概念

- 共享信道要着重考虑的一个问题就是如何协调多个发送和接收站点对一个共享传输媒体的占用，即**媒体接入控制MAC**（Medium Access Control）

- 媒体接入控制可分为：

  - 静态划分信道
    - 预先固定分配好信道，这类方法非常不灵活，对于突发性数据传输信道利用率会很低
    - 通常在无线网络的物理层中使用，而不是在数据链路层中使用
    - 可分为：
      - 频分多址
      - 时分多址
      - 码分多址
  - 动态接入控制
    - 可分为：
      - 受控接入
        - 集中控制	（由一个主站以循环方式轮询每个站点有无数据发送，只有被轮询到的站点才能发送数据。最大缺点是存在单点故障问题）
        - 分散控制（各站点是平等的，并连接成一个环形网络。令牌（一个特殊的控制帧）沿环逐站传递，接收到令牌的站点才有权发送数据，并在发送完数据后将令牌传递给下一个站点）
      - 随机接入（所有站点通过竞争，随机地在信道上发送数据。如果恰巧有两个或更多的站点在同一时刻发送数据，则信号在共享媒体上就要产生碰撞（即发生了冲突）。使得这些站点的发送都失败。因此，这类协议要解决的关键问题是如何尽量避免冲突及在发生冲突后如何尽快恢复通信。著名的共享式以太网采用的就是随机接入）

- 随着技术的发展，交换技术的成熟和成本的降低，具有更高性能的使用点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了共享式局域网，但由于无线信道的广播天性，无线局域网仍然使用的是共享媒体技术

  



#### 3.6.2 媒体接入控制 — 静态划分信道

- 信道复用

  - 复用（Multiplexing）是通信技术中的一个重要概念。复用就是通过一条物理线路同时传输多路用户的信号

  - 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量时，可利用复用技术在一条物理线路上建立多条通信信道来充分利用传输媒体的带宽

  - 常见的信道复用有：

    - 频分复用FDM
    - 时分复用TDM
    - 波分复用WDM
    - 码分复用CDM

  - **频分复用FDM**

    - 将传输线路的频带资源划分成多个子频带，形成多个子信带，各子信道之间需要留出隔离频带，以免造成子信道间的干扰。当多路信号输入一个多路复用器时，这个复用器将每一路信号调制到不同频率的载波上。
    - 接收端由相应的分用器通过滤波将各路信号分开，将合成的复用信号恢复成原始的多路信号
    - **频分复用的所有用户同时占用不同的频带资源并行通信**

  - **时分复用TDM**

    - 将时间划分成一个个时隙。
    - **时分复用技术将传输线路的带宽资源按时隙轮流分配给不同的用户，每对用户只在所分配的时隙里使用线路传输数据**
    - **时分复用技术将时间划分成了一段段等长的时分复用帧，每一个时分复用的用户在每一个时分复用帧中占用固定序号的时隙** 
    - 每一个用户所占用的时隙是周期性出现的，其周期就是时分复用帧的长度
    - **时分复用的所有用户在不同的时间占用同样的频带宽度**

  - **波分复用WDM**

    - 波分复用其实就是光的频分复用

  - **码分复用CDM**

    - 码分复用CDM是另一种共享信道的方法。实际上，由于该技术主要用于多址接入，人们更常用的名词是码分多址CDMA（Code Division Multiple Access）

    - 同理，频分复用FDM和时分复用TDM同样可用于多址接入，相应的名词是频分多址FDMA和时分多址TDMA

    - 复用与多址

      - 复用是将单一媒体的频带资源划分成很多子信道，这些子信道之间相互独立，互不干扰。从媒体的整体频带资源上看，每个子信道只占用该媒体频带资源的一部分
      - 多址（更确切地应该称为多点接入）处理的是动态分配信道给用户。这在用户仅仅暂时性地占用信道的应用中是必须的，而所有的移动通信系统基本上都属于这种情况。相反，在信道永久性地分配给用户的应用中，多址是不需要的（对于无线广播或电视广播站就是这样）
      - 某种程度上，FDMA、TDMA、CDMA可以分别看成是FDM、TDM、CDM的应用

    - 与FDM和TDM不同，CDM的每一个用户可以**在同样的时间使用同样的频带进行通信**

    - 由于**各用户使用经过特殊挑选的不同码型**，因此各用户之间**不会造成干扰**

    - CDM最初是用于军事通信的，因为这种系统所发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现

    - **码分复用使用（直接序列扩频DSSS）**

      - 在CDMA中，每一个比特时间再划分为m个短的间隔，称为**码片**。通常m的值是64或128。为了简单起见，在后续的举例中，我们假设m为8
      - 使用CDMA的每一个站被指派一个唯一的**m bit码片序列**。
        - 一个站如果要发送**比特1**，则**发送它自己的m bit码片序列**
        - 一个站如果要发送**比特0**，则**发送它自己的m bit码片序列的二进制反码**
      - 码片序列的挑选原则如下：
        - 分配给每个站的**码片序列必须各不相同**，实际常采用伪随机码序列
        - 分配给每个站的**码片序列必须相互正交**（规格化内积为0）
          - 令向量S表示站S的码片序列，令向量T表示其他任何站的码片序列。**两个不同站S和T的码片序列正交，就是相邻S和T的规格化内积为0。即`S * T = 0`**

    - 码分多址使用

      - 假设接收方D接收到了`A + B的共轭`，发送方A发送`A（比特1）`，发送方B发送`B（比特0）`，发送方C未发送
      - 假设所有站所发送的码片序列都是同步的，接收方D直到其他各站所特有的码片序列。接收站D对所接收到的叠加信号进行判断：**`用D所接收到的码片序列 与发送方发送的码片序列 进行规格化内积（点乘）`**
        - **结果为1，对方发送比特1**
        - **结果为-1，对方发送比特0**
        - **结果为0，对方未发送**

      



#### 3.6.3  媒体接入控制 — 动态接入控制 — 随机接入（CSMA/CD协议）

- **总线局域网使用的协议：载波监听多址接入/碰撞检测（CSMA/CD）协议**

- 多址接入MA

  - 多个站连接在一条总线上，竞争使用总线

- 载波监听CS

  - 每一个站在发送帧之前先要检测一下总线上是否有其他站点在发送帧（"先听后说"）：
    - 若检测到总线空闲96比特时间，则发送这个帧；
    - 若检测到总线忙，则继续检测并等待总线转为空闲96比特时间，然后发送这个帧
    - **96比特时间是指发送96比特所耗费的时间，也称为帧间最小间隔，其作用是使接收方可以检测出一个帧的结束，同时也使得所有其他站点都能有机会平等竞争信道并发送帧**

- 碰撞检测CD

  - 每一个正在发送帧的站边发送边检测碰撞（"边说边听"）
    - 一旦发现总线上出现碰撞，则立即停止发送，退避一段随机时间后在次发送（"一旦冲突，立即停说，等待时间，重新再说"）
  - 以太网还采取一种叫做**强化碰撞**的措施。这就是当发送帧的站点一旦检测到碰撞，除了立即停止发送帧以外，还要再继续发送**32比特或48比特的人为干扰信号，以便有足够多的碰撞信号使所有站点都能检测出碰撞**

  

- **CSMA/CD协议 —— 争用期（碰撞窗口）**

  - 假设以太网单程端传播时延为T
  - 那么**主机最多经过2T的时长就可检测到本次发送是否遭受了碰撞**
  - 因此，**以太网的端到端往返传播时延2T称为<u>争用期</u>或<u>碰撞窗口</u>**
  - 经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞
  - 每一个主机在自己发送帧之后的一小段时间内，存在着遭遇碰撞的可能性。这一小段时间是不确定的。它取决于另一个发送帧的主机到本主机的举例，但不会超过总线的端到端往返传播时延，即一个争用期时间
  - 显然，在以太网中发送帧的主机越多，端到端往返传播时延越大，发生碰撞的概率就越大。因此，**共享式以太网不能连接太多的主机，使用的总线也不能太长**
    - 10Mb/s以太网把争用期定位512比特发送时间，即51.2微妙，因此其总线长度不能超过5120m，但考虑到其他一些因素，如信号衰减等，以太网规定总线长度不能超过2500m

- **CSMA/CD协议 —— 最小帧长**

  - **以太网规定最小帧长为64字节**，即512比特（512比特时间即为争用期）
    - 如果要发送的数据非常少，那么必须加入一些填充字节，使帧长不小于64字节
  - 以太网的**最小帧长确保了主机可在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞**
    - 如果在争用期（共发送64字节）没有检测到碰撞，那么后续发送的数据就一定不会发生碰撞
    - 如果在争用期内检测到碰撞，就立即中止发送，这时已经发送出去的数据就一定小于64字节。因此**凡长度小于64字节的帧都是由于碰撞而异常中止的无效帧**

- **CSMA/CD协议 —— 截断二进制指数退避算法**

  - `退避时间 = 基本退避时间（争用期2T） * 随机数r（r从离散的整数集合{0，1，... ，(2的k次方-1)}中随机选出一个数k = Min[重传次数，10]`
  - 若连续多次发生碰撞，就表明可能有较多的主机参与竞争信道。但使用上述退避算法可**使重传需要推迟的平均时间随重传次数而增大**（这也称为**动态退避**），因而**减小发生碰撞的概率**，有利于整个系统的稳定
  - **当重传达16次仍不能成功时**，表明同时打算发送帧的主机太多，以至于连续发生碰撞，则**丢弃该帧**，并向高层报告

- **CSMA/CD协议 —— 信道利用率**

  - 考虑以下这种理想情况：
    - 各主机发送帧都不会产生碰撞
    - 总线一旦空闲就有某个主机立即发送帧
    - 发送一帧占用总线的时间为T0+ T，而帧本身的发送时间是T0
  - 故极限信道利用率为`S = T0 / T0 + T`
  - 要提高信道利用率，需要：
    - 减小以太网端到端的距离 
    - 增长以太网帧的长度

- **CSMA/CD协议 —— 帧发送流程**

  - 首先监听信道，查看信道是否活跃

    - 若否，继续监听
    - 若是，开始接收帧

  - 判断是否接收完成

    - 否，继续接收
    - 是，判断帧是否太短

  - 帧是否太短**（小于最短帧长则认为遭遇了碰撞）**

    - 是，丢弃帧
    - 否，判断地址是否正确

  - 地址是否正确**（帧的目的MAC地址与接收方的MAC地址相同或是广播地址）**

    - 否，丢弃帧
    - 是，判断是否校验正确

  - 是否校验正确**（使用CRC检查帧是否出现了误码）**

    - 否，丢弃该帧
    - 是，接收该帧，接收结束

    





#### 3.6.4  媒体接入控制 — 动态接入控制 — 随机接入（CSMA/CA协议）

- **无线局域网使用的协议：载波监听多址接入/碰撞避免（CSMA/CA）协议**

- 既然CSMA/CD协议已经成功地应用于使用广播信道的有线局域网，那么同样使用广播信道的无线局域网能不能也使用CSMA/CD协议呢？

  - **在无线局域网中，仍然可以使用载波监听多址接入CSMA**，即在发送帧之前先对传输媒体进行载波监听。若发现有其他站在发送帧，就推迟发送以免发生碰撞
  - **在无线局域网中，不能使用碰撞检测CD**，原因如下：
    - 由于无线信道的传输条件特殊，其信号强度的动态范围非常大，无线网卡上接收到的信号强度往往会远远小于发送信号的强度（可能相差百万倍）。**如果要在无线网卡上实现碰撞检测CD，对硬件的要求非常高**
    - 即使能够在硬件上实现无线局域网的碰撞检测功能，但由于无线电波传播的特殊性**（存在隐蔽站问题），进行碰撞检测的意义也不大**

- **载波监听多址接入/碰撞避免（CSMA/CA）**

  - **802.11无线局域网**使用CSMA/CA协议，在CSMA的基础上增加了一个**碰撞避免CA功能**，而不再实现碰撞检测功能
  - 由于**不可能避免所有的碰撞**，并且**无线信道误码率较高**，802.11标准还使用了**数据链路层确认机制（停止-等待协议）**来保证数据被正确接收
  - 802.11的MAC层标准定义了两种不同的媒体接入控制方式：
    - **分布式协调功能DCF**（Distributed Coordination Function）。在DCF方式下，没有中心控制站点，每个站点使用CSMA/CA协议通过争用信道来获取发送权，这是802.11定义的默认方式
    - **点协调功能PCF**（Point Coordination Function）。PCF方式使用集中控制的接入算法（一般在接入点AP实现集中控制），是802.11定义的可选方式，在实际中较少使用

- **帧间间隔IFS（InterFrame Space）**

  - 802.11标准规定，所有的**站点必须在持续检测到信道空闲一段时间后才能发送帧**，这段时间称为帧间间隔IFS 
  - 帧间间隔的长短取决于该站点要发送的帧的类型：
    - 高优先级帧需要等待的时间较短，因此可优先获得发送权
    - 低优先级帧需要等待的时间较长。若某个站的低优先级帧还没来得及发送，而其他站的高优先级帧已发送到信道上，则信道变为忙态，因而低优先级帧就只能再推迟发送了。这样就减少了发生碰撞的机会
  - 常用的两种帧间间隔如下：
    - **短帧间间隔SIFS（28微秒）**，是最短的帧间间隔，用来分隔开属于一次对话的各帧。一个站点应当能够在这段时间内从发送方式切换到接收方式。使用SIFS的帧类型有ACK帧、CTS帧、由过长的MAC帧分片后的数据帧、以及所有回答AP探询的帧和在PCF方式中接入点AP发送出的任何帧
    - **DCF帧间间隔DIFS（128微秒）**，它比短帧间间隔SIFS要长的多，在DCF方式中用来发送数据帧和管理帧

- **CSMA/CA协议的工作原理**

  - 源站有数据帧要发送，此时**检测到信道是空闲的**，则**源站在等待帧间间隔DIFS后发送该数据帧**。**目的站**若正确接收到该数据帧，则**经过帧间间隔SIFS后**，**向源站发送确认帧ACK**。（若源站没有在规定时间内收到ACK，则由重传计时器控制这段时间，就必须重传该数据帧，直到收到确认ACK为止。或者经过若干次的重传失败后放弃发送）

  - 源站为什么要检测到信道空闲后还要再等待一段时间DIFS？

    - 就是考虑到可能有其他的站有高优先级的帧要发送。若有，就让高优先级帧先发送。

  - 目的站为什么正确接收数据帧后还要等待一段时间SIFS才能发送ACK帧？

    - SIFS是最短的帧间间隔，用来分隔开属于一次对话的各帧。在这段时间内，一个站点应当能够从发送方式切换到接收方式

  - 在信道忙的时候，其他站要发送数据需要退避。当信道由忙转为空闲后，其他站需要等待一段时间DIFS，然后再退避一段随机时间才能使用信道发送下一帧

    - 为什么当**信道由忙转为空闲并经过一段时间DIFS后，还要再退避一段随机时间才能使用信道**？
      - **这样做的目的在于，防止多个站点同时发送数据而产生碰撞**

  - **当站点检测到信道是空闲的，并且所发送的数据帧不是成功发送完上一个数据帧之后立即连续发送的数据帧，则不使用退避算法**

  - 以下情况必须使用退避算法：

    - 在发送数据帧之前检测到信道处于忙状态时；
    - 在每一次重传一个数据帧时
    - 在每一次成功发送后要连续发送下一个帧时（这是为了避免一个站点长时间占用信道）

    

- **<u>CSMA/CA协议的退避算法</u>**

  - 在执行退避算法时，站点为退避计时器设置一个随机的退避时间

    - 当退避计时器的时间减小到零时，就开始发送数据
    - 当退避计时器的时间还未减小到零时而信道又转变为忙状态，这时就冻结退避计时器的数值，重新等待信道变为空闲，再经过时间DIFS后，继续启动退避计时器

  - 在进行第i次退避时，退避时间在时隙编号{0,1,...,2的2+i次方-1}中随机选择一个，然后乘以基本退避时间（也就是一个时隙的长度）就可以得到随机的退避时间。这样做是为了使不同站点选择相同退避时间的概率减少。当时隙编号达到255时（对应于第6次退避）就不再增加了

    

- **CSMA/CA协议的信道预约和虚拟载波监听**

  - 为了**尽可能减少碰撞的概率**和降低碰撞的影响，802.11标准允许要发送数据的站点**对信道进行预约**

    1. 源站在发送数据帧之前先发送一个短的控制帧，称为**请求发送RTS**（Request To Send），它包括源地址、目的地址以及这次通信（包括相应的确认帧）所需的持续时间
    2. 若目的站正确收到源站发来的RTS帧，且媒体空闲，就发送一个响应控制帧，称为**允许发送CTS**（Clear To Send），它也包括这次通信所需的持续时间（从RTS帧中将此持续时间复制到CTS帧中）
    3. 源站收到CTS帧后，再等待一段时间SIFS后，就可发送其数据帧
    4. 若目的站正确收到了源站发来的数据帧，在等待时间SIFS后，就向源站发送确认帧ACK 

  - 除源站和目的站以外的**其他各站**，在**收到CTS帧（或数据帧）后就推迟接入到无线局域网中**。这样就保证了源站和目的站之间的通信不会收到其他站的干扰

  - 如果RTS帧发生碰撞，源站就收不到CTS帧，需执行退避算法重传RTS帧

  - 由于**RTS帧和CTS帧很短，发送碰撞的概率、碰撞产生的开销及本身的开销都很小**。而对于一般的数据帧，其发送时延往往大于传播时延（因为是局域网），碰撞的概率很大，且一旦发生碰撞而导致数据帧重发，则浪费的时间就很多，因此**用很小的代价对信道进行预约往往是值得的**。802.11标准规定了3中情况供用户选择

    - 使用RTS帧和CTS帧
    - 不使用RTS帧和CTS帧
    - 只有当数据帧的长度超过某一数值时才使用RTS帧和CTS帧

    

  - 除RST帧和CTS帧会携带通信需要持续的时间，数据帧也能携带通信需要持续的时间，这称为802.11的**虚拟载波监听**机制

  - 由于利用虚拟载波监听机制，**站点只需要监听到RTS帧、CTS帧或数据帧中的任何一个，就能知道信道被占用的持续时间**，而不需要真正监听到信道上的信号，因此**虚拟载波监听机制能减少隐蔽站带来的碰撞问题**

    







### 3.7 MAC地址、IP地址以及ARP协议

#### 3.7.1 MAC地址

- **MAC地址是以太网的MAC子层所使用的地址（数据链路层）**

- 使用情况

  - 使用点对点信道的数据链路层不需要使用地址
  - 使用广播信道的数据链路层必须使用地址来区分各主机

- 当多个主机连接在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个唯一的标识，即一个数据链路层地址；

- 在每个主机发送的**帧中必须携带标识发送主机和接收主机的地址**。由于这类地址是用于媒体接入控制MAC（Media Access Control），因此这类地址被称为**MAC地址**

  - MAC地址一般被固化在网卡（网络适配器）的点可擦可编程只读存储器EEPROM中，因此MAC地址也被称为**硬件地址**
  - MAC地址有时也被称为**物理地址**。但是注意：**这并不意味着MAC地址属于网络体系结构中的物理层**

- 一般情况下，用户主机会包含两个网络适配器：有线局域网适配器（有线网卡）和无线局域网适配器（无线网卡）。每个网络适配器都有一个全球唯一的MAC地址。而交换机和路由器往往拥有更多的网络接口，所以会拥有更多的MAC地址。综上所述，**严格来说，MAC地址是对网络上个接口的唯一标识，而不是对网络上各设备的唯一标识**

- IEEE 802局域网的MAC地址格式

  - 这种标识符称为**扩展的唯一标识符EUI-48**

  - 共有6个字节，每个字节有8个比特(b7,b6,b5,b4,b3,b2,b1,b0)

  - 前三个字节为组织唯一的标识符OUI（由IEEE的注册管理机构分配）

  - 后三个字节是网络接口标识符（获得OUI的厂商可自行随意分配）

  - 表示法

    - 标准表示法：将四个比特写为一个十六进制的数，连接起来`XX-XX-XX-XX-XX-XX`
    - 其他表示法：`XX:XX:XX:XX:XX:XX`或`XXXX.XXXX.XXXX`

  - MAC地址第一字节的b0位

    - 取1时，表示该地址是多播地址，又称为组播地址
    - 取0时，表示该地址是单播地址

  - MAC地址第一字节的b1位

    - 取0时，表示该地址是全球管理的，也就是全球唯一的
    - 取1时，表示该地址是本地管理

  - | 第一字节的b1位 | 第一字节的b0位 | MAC地址类型                                                  | 地址数量占比 | 总地址数量                                  |
    | -------------- | -------------- | ------------------------------------------------------------ | ------------ | ------------------------------------------- |
    | 0              | 0              | 全球管理，单播地址；厂商生产网络设备（网卡，交换机，路由去）时固化 | 1/4          | 2的48次方=281474976710656（二百八十多万亿） |
    | 0              | 1              | 全球管理，多播地址；标准网络设备所支持的多播地址，用于特定功能 | 1/4          | 2的48次方=281474976710656（二百八十多万亿） |
    | 1              | 0              | 本地管理，单播地址；由网络管理员分配，覆盖网络接口的全球管理单播地址 | 1/4          | 2的48次方=281474976710656（二百八十多万亿） |
    | 1              | 1              | 本地管理，多播地址；用户对主机进行软件配置，以表面其属于哪些多播组。**注意：剩余46位全为1时，就是广播地址FF-FF-FF-FF-FF-FF** | 1/4          | 2的48次方=281474976710656（二百八十多万亿） |

  - 发送顺序：

    - 字节发送顺序：第一字节到第六字节
    - 字节内比特发送顺序： b0到b7

- **单播MAC地址**举例

  - 一条总线上连着A,B,C三台主机
  - 假设主机B要给主机C发送单播帧。
    - 主机B首先要构建该单播帧：在帧首部中的目的地址字段填入主机C的MAC地址，源地址字段填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该单播帧
    - 主机B将该单播帧发送出去，主机A和C都会收到该单播帧
    - 主机A发现目的地址与自己不匹配，丢弃该帧
    - 主机C发现目的地址与自己匹配，接收该帧，并交给上层处理

- **广播MAC地址**举例

  - 假设主机B要发送广播帧
    - 主机B首先要构建该广播帧：在帧首部的目的地址字段填入**广播地址（也就是十六进制的全F`FF-FF-FF-FF-FF-FF`）**，源地址字段填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该广播帧
    - 主机B将该广播帧发送出去，主机A和C都会收到该广播帧，发现该帧首部中的目的地址字段的内容是广播帧，就知道该帧是广播帧，接收该帧并交给上层处理

- **多播MAC地址**举例

  - 一条总线上连着A,B,C,D四台主机
  - 假设主机A要发送多播帧给该多播地址
    - 将该多播地址的左起第一个字节写成8个比特（最低比特位b0是1，表明这是一个多播地址）
      - **快速判断MAC地址是否是多播地址的方法：左起第一位十六进制数不能整除2（1，3，5，7，9，B，D，F），则为多播地址**
    - 主机A首先要构建该多播帧：在帧首部的目的地址字段填入该多播地址，源地址字段填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该多播帧
    - 主机A将该多播帧发送出去，主机B,C,D都会收到该多播帧，主机B，C发现该多播帧的目的MAC地址在自己的多播组列表中，接收该帧并传交给上层处理
    - 主机D发现该多播帧的目的MAC地址不在自己的多播组列表中，丢弃该帧





#### 3.7.2 IP地址

- **IP地址是TCP/IP体系结构网际层所使用的地址（网际层），用于标识两部分信息：**

  - 网络编号：标识因特网上数以百万计的网络
  - 主机编号：标识同一网络上不同主机（或路由器接口）

- 很显然，上面的MAC地址不具备区分不同网络的功能

  - 如果只是一个单独的网络，不接入因特网，可以只使用MAC地址（这不是一般用户的应用方式）
  - 如果主机所在的网络需要接入因特网，则IP地址和MAC地址都需要使用

- 数据包转发过程中IP地址与MAC地址的变化情况

  - 假设此时的连接情况为：`主机H1——路由器R1——路由器R2——主机H2`，此时H1要给H2发送一个数据包

  - H1发送到路由器R1

    - 网络层时，H1数据包的源IP地址应填写主机H1的IP地址IP1，目的IP地址应填写主机H2的IP地址IP2
    - 数据链路层时，数据包的源MAC地址应填写主机H1的MAC地址MAC1，目的MAC地址应填写路由器R1的MAC地址MAC3

  - 路由器R1转发到路由器R2

    - 网络层时，数据包的源IP地址仍填写主机H1的IP地址IP1，目的IP地址仍填写主机H2的IP地址IP2
    - 数据链路层时，H1数据包的源MAC地址应填写路由器R1的MAC地址MAC4，目的MAC地址应填写路由器R2的MAC地址MAC5（MAC3和MAC4是R1中的不同接口）

  - 路由器R2转发给主机H2

    - 网络层时，H1数据包的源IP地址仍填写主机H1的IP地址IP1，目的IP地址仍填写主机H2的IP地址IP2
    - 数据链路层时，H1数据包的源MAC地址应填写路由器R2的MAC地址MAC6，目的MAC地址应填写主机H2的MAC地址MAC2

  - 可看出：

    - **数据包转发过程中源IP地址和目的IP地址保持不变**
    - **数据包转发过程中源MAC地址和目的MAC地址逐个链路（或逐个网络）改变**

    



#### 3.7.3 ARP协议

- **ARP协议属于TCP/IP体系结构的网际层，<u>其作用是已知设备所分配到的IP地址，使用ARP协议可以通过该IP地址获取到设备的MAC地址</u>（网际层）**

- **实际上每台主机都会有一个ARP高速缓存表，其中记录有IP地址和MAC地址的对应关系**

  - **ARP高速缓存表中的每一条记录，都有其类型，分为动态和静态：**
    - **动态：自动获取，生命周期默认为两分钟；（生命周期结束时，记录将自动删除——因为IP地址与MAC地址的对应关系并不是永久性的）**
    - **静态：手工设置，不同操作系统下的生命周期不同，例如系统重启后不存在或系统重启后依然有效**

- **发送过程**

  - 源主机在自己的**ARP高速缓存表**中查找目的主机的IP地址所对应的MAC地址，若找到了，则可以封装MAC帧进行发送；若找不到，则发送**ARP请求（封装在广播MAC帧中）**

  - 目的主机收到ARP请求后，将源主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后给源主机发送**ARP响应（封装在单播MAC帧中）**，ARP响应中包含有目的主机的IP地址和MAC地址

  - 源主机收到ARP响应后，将目的主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后就可以封装之前想发送的MAC帧并发送给目的主机

    

- 例子：

  - 假设此时一根总线上有主机A,B,C

  - B要给C发送数据包，B知道C的IP地址但不知道C的MAC地址，因此B的数据链路层在封装MAC帧时就无法填写目的的MAC地址

    - A收到B发送的帧，交给上层，发现IP地址不对应，丢弃该帧
    - C收到B发送的帧，交给上层，上层的ARP进程解析ARP报文，发现询问的IP地址是自己的IP地址，需要进行响应
      - **主机C首先将B的IP地址与MAC地址记录到自己的ARP高速缓存表中**
      - **然后给主机B发送ARP响应（单播帧），以告知自己的MAC地址**
      - **ARP响应报文内容：我的IP地址和我的MAC地址**

  - 主机C给主机B发送ARP单播帧

    - 主机A收到后发现其MAC地址不匹配，丢弃该帧

    - 主机B收到后发现MAC地址匹配，接收该帧交付上层，

      - **上层解析ARP报文，将C的IP地址与MAC地址记录到自己的ARP高速缓存表中**

        

- ARP请求报文（广播）

  - **封装在MAC帧中，目的地址为FF-FF-FF-FF-FF-FF（广播地址）**
  - 我的IP地址为192.168.0.2
  - 我的MAC地址为00-E0-F9-A3-43-77
  - **我想知道IP地址为192.168.0.3的主机的MAC地址**

- **作用范围：ARP协议只能在一段链路或一个网络上使用，而不能跨网络使用**

- **除ARP请求和响应外，ARP还有其他类型的报文**（例如用于检查IP地址冲突的"无故ARP、免费ARP"）

- ARP没有安全验证机制，**存在ARP欺骗（攻击）问题**

  



### 3.8 集线器与交换机的区别

- 使用双绞线和集线器HUB的星型以太网

  - **使用集线器的以太网在逻辑上仍是一个总线网**，各站共享总线资源，**使用的还是CSMA/CD协议**
  - **集线器只工作在物理层**，它的每个接口仅简单地转发比特，不进行碰撞检测（由各站的网卡检测）
  - **集线器一般都有少量的容错能力和网络管理功能**。例如，若网络中某个网卡出了故障，不停地发送帧。此时，集线器可以检测到这个问题，在内部断开与故障网卡的连线，使整个以太网仍然能正常 工作
  - 比较可靠，价格便宜，使用方便

  

- 以太网交换机

  - 以太网交换机通常都有**多个接口**。每个接口都可以直接与一台主机或另一个以太网交换机相连。一般都工作在**全双工方式**
  - 以太网交换机具有并行性，能**同时连通多对接口**，使多对主机能同时通信，**无碰撞（不适用CSMA/CD协议）**
  - 以太网交换机一般都具有多种速率的接口，例如：10Mb/s、100Mb/s、1Gb/s、10Gb/s接口的多种组合
  - 以太网交换机**工作在数据链路层**（也包括物理层），它收到帧后，在帧交换表中查找**帧的目的MAC地址所对应的接口号**，然后通过该接口转发帧
  - 以太网交换机是一种即插即用设备，其内部的**帧交换表**是通过**自学习算法**自动地逐渐建立起来的
  - 帧的两种转发方式：
    - **存储转发**
    - **直通交换**：采用基于硬件的交叉矩阵（交换时延非常小，但不检查帧是否有差错）

- 对比集线器和交换机

  - 当一台主机要给另外一台主机发送单播帧时

    - 集线器会将单播帧传播到总线上的其他各主机。各主机中的网卡，根据帧的目的MAC地址决定是否接收该帧
    - 交换机收到单播帧后，根据帧的目的MAC地址和自身的帧交换表，将帧转发给目的主机，而不是网络中的其他各主机

  - 当一台主机发送广播帧时

    - 对于集线器：广播帧会传播到总线上的其他各主机，各主机的网卡检测到该帧的MAC地址是广播帧，就接收该帧
    - 对于交换机：交换机收到广播帧后，检测到帧的目的MAC地址是广播地址，于是从除该帧进入交换机接口外的其他个接口转发该帧。网络中除源主机外的其他各主机收到广播帧后，接收该广播帧

  - 网络中多台主机同时给另一台主机发送单播帧

    - 对于集线器：会产生碰撞，遭遇碰撞的帧会传播到总线上的各主机
    - 对于交换机：交换机收到多个帧时，会将它们缓存起来，然后逐个转发给目的主机，不会产生碰撞

  - 使用集线器扩展以太网和使用交换机扩展以太网有什么区别

    - 如果使用集线器扩展以太网，不仅扩大了广播域，还扩大了碰撞域
    - 如果使用交换机扩展以太网，只会扩大广播域，而不会扩大碰撞域（交换机可以隔离碰撞域）

    

- 小结：

  - 集线器HUB
    - 早期以太网的互连设备
    - 工作在OSI体系结构的物理层
    - 对接收到的信号进行放大、转发
    - 使用集线器作为互联设备的以太网仍然属于共享总线式以太网。集线器互连起来的所有主机共享总线带宽，属于同一个碰撞域和广播域
  - 交换机SWITCH
    - 目前以太网中使用最广泛的互连设备
    - 工作在OSI体系结构的数据链路层（也包括物理层）
    - 根据MAC地址对帧进行转发
    - 使用交换机作为互联设备的以太网，称为交换式以太网。交换机可以根据MAC地址过滤帧，即隔离碰撞域
    - 交换机的每个接口是一个独立的碰撞域
    - 交换机隔离碰撞域但不隔离广播域（VLAN除外）

  





### 3.9 以太网交换机自学习和转发帧的流程

- 以太网交换机工作在**数据链路层**（也包括物理层）
- 以太网交换机收到帧后，在帧交换表中查找**帧的目的MAC地址所对应的接口号**，然后通过该接口转发帧
- 以太网交换机是一种即插即用设备，刚上电启动时其内部的帧交换表是空的。随着网络中各主机间的通信，以太网交换机**通过自学习算法**自动逐渐**建立起帧交换表**
- 以太网交换机自学习和转发帧的流程：
  - 收到帧后进行**登记**。登记的内容为**帧的源MAC地址**及进入交换机的**接口号**
  - 根据**帧的目的MAC地址**和交换机的**帧交换表**对帧进行**转发**，有以下三种情况：
    - **明确转发**：交换机知道应当从哪个（或哪些）接口转发该帧（单播，多播，广播）
    - **盲目转发**：交换机不知道应当从哪个端口转发帧，只能将其通过除进入交换机的接口外的其他所有接口转发（也称为泛洪）
    - **明确丢弃**：交换机知道不应该转发该帧，将其丢弃
- 帧交换表中的每条记录都有自己的**有效时间**，到期删除。原因如下：
  - 交换机的接口改接了另一台主机
  - 主机更换了网卡







### 3.10 以太网交换机的生成树协议STP

- 如何提高以太网的可靠性？
  - 添加**冗余链路**可以提高以太网的可靠性
  - 但是，冗余链路也会带来负面效应——形成**网络环路**
  - 网络环路会带来以下问题：
    - **广播风暴**
      - 大量消耗网络资源，使得网络无法正常转发其他数据帧
    - **主机收到重复的广播帧**
      - 大量消耗主机资源
    - **交换机的帧交换表震荡（漂移）**
- 以太网交换机使用**生成树协议STP**（Spanning Tree Protocol），可以在增加冗余链路来提高网络可靠性的同时又**避免网络环路带来的各种问题**
  - 不论交换机之间采用怎样的物理连接，交换机都能够**自动计算并构建一个逻辑上没有环路的网络**，其逻辑拓扑结构必须是树形的（无逻辑环路）
  - 最终生成的树形逻辑拓扑要**确保连通整个网络**
  - 当首次连接交换机或网络**物理拓扑发生变化**时（有可能是人为改变或故障），交换机都将进行**生成树的重新计算**









### 3.11 虚拟局域网VLAN

#### 3.11.1 虚拟局域网VLAN概述

- 以太网交换机工作在**数据链路层**（也包括物理层）
- 使用一个或多个以太网交换机互连起来的交换式以太网，其所有站点都属于**同一个广播域**
- 随着交换式以太网规模的扩大，广播域相应扩大
- **巨大的广播域会带来很多弊端：广播风暴**，难以管理和维护
- **网络中会频繁出现广播信息**（TCP/IP协议栈中很多协议都会使用广播，例如ARP、RIP、DHCP等）
- 分割广播域的方法：使用路由器可以隔离广播域，但路由器成本较高，**虚拟局域网VLAN技术**应运而生
- 虚拟局域网VLAN（Virtual Local Area Network）是一种将局域网内的**设备划分成与物理位置无关的逻辑组的技术，这些逻辑组具有某些共同的需求**





#### 3.11.2 虚拟局域网VLAN的实现机制

- **IEEE 802.1Q帧** 

  - IEEE 802.1Q帧（也称Dot One Q帧）对以太网的MAC帧格式进行了扩展，插入了**4字节的VLAN标记**
  - VLAN标记的**最后12比特**称为**VLAN标识符VID**，它唯一地标识了以太网帧属于哪一个VLAN
    - VID的取值范围是0~4095
    - 0和4095都不用来标识VLAN，因此用于标识VLAN的**VID的有效取值范围是1~4094**
  - **802.1Q帧是由交换机来处理的，而不是用户主机来处理的**
    - 当交换机**收到普通的以太网帧**时，会将其插入4字节的VLAN标记转变为802.1Q帧，简称"**打标签**"
    - 当交换机**转发802.1Q帧**时，**可能**会删除其4字节VLAN标记转变为普通以太网帧，简称"**去标签**"

- 交换机的端口类型

  - 交换机的端口类型有以下三种：
    - Access
    - Trunk 
    - Hybrid
  - 交换机各端口的缺省VLAN ID
    - 在思科交换机上称为Native VLAN，即本征VLAN
    - 在华为交换机上称为Port VLAN ID，即端口VLAN ID，简记为PVID（交换机的每个端口有且仅有一个PVID）

- Access端口

  - Access端口一般用于连接用户计算机
  - **Access端口只能属于一个VLAN**
  - Access端口的PVID值与端口所属VLAN的ID相同（默认为1）
  - Access端口接收处理方法：
    - 一般只接受"未打标签"的普通以太网MAC帧。根据接收帧的端口的PVID给帧"**打标签**"，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等
  - Access端口发送处理方法：
    - 若帧中的VID与端口的PVID相等，则"**去标签**"并**转发**该帧；否则不转发

- Trunk端口

  - Trunk端口一般用于交换机之间或交换机与路由器之间的互连
  - **Trunk端口可以属于多个VLAN**
  - 用户可以设置Trunk端口的PVID值。默认情况下，Trunk端口的PVID值为1
  - Trunk端口发送处理方法：
    - 对VID等于PVID的帧，**"去标签"再转发**；
    - 对VID不等于PVID的帧，**直接转发**
  - Trunk端口接收处理方法：
    - 接收"未打标签"的帧，根据接收帧的端口的PVID给帧"**打标签**"，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等
    - 接收"已打标签"的帧

- Hybrid端口

  - Hybrid端口既可用于交换机之间或交换机与路由器之间的互连（同Trunk端口），也可用于交换机与用户计算机之间的互连（同Access端口）
  - Hybrid端口可以属于多个VLAN（同Trunk端口）
  - 用户可以设置Hybrid端口的PVID值。默认情况下，Hybrid端口的PVID值为1（同Trunk端口）
  - Hybrid端口发送处理方法（**与Trunk端口不同**）
    - 查看帧的VID是否在端口的"去标签"列表中：
      - 若存在，则"去标签"后再转发
      - 若不存在，则直接转发
  - Hybrid端口接收处理方法（同Trunk端口）
    - 接收"未打标签"的帧，根据接收帧的端口的PVID给帧"**打标签**"，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等
    - 接收"已打标签"的帧

  







## 四. 网络层

### 4.1 网络层概述

- 网络层的主要任务是**实现网络互连**，进而**实现数据包在各网络之间的传输**
- 要实现网络层任务，需要解决以下主要问题：
  - 网络层向运输层提供怎样的服务（"可靠传输"还是"不可靠传输"）
  - 网络层寻址问题
  - 路由选择问题
- **因特网**（Internet）是目前全世界用户数量最多的互联网，它**使用TCP/IP协议栈**
- 由于TCP/IP协议栈的网络层使用**网络协议IP**，它是整个协议栈的核心协议，因此在TCP/IP协议栈中网络层常称为**网际层**





### 4.2 网络层提供的两种服务

- 面向连接的虚电路服务

  - **可靠通信由网络来保证**
  - 必须建立**网际层的连接——虚电路VC**（Virtual Circuit）
  - 通信双方**沿着已建立的虚电路发送分组**
  - 目的主机的地址仅在连接建立阶段使用，之后每个**分组的首部只需携带一条虚电路的编号**（构成虚电路的每一段链路都有一个虚电路编号）
  - 这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组最终正确到达接收方（无差错按序到达、不丢失、不重复）
  - **通信结束后，需要释放之前所建立的虚电路**
  - 很多广域分组交换网都使用面向连接的虚电路服务。例如，曾经的X.25和逐渐过时的帧中继FR、异步传输模式ATM等

- 无连接的数据报服务

  - **可靠通信应当由用户主机来保证**
  - **不需要建立网络层连接**
  - **每个分组可走不同的路径**
  - 每个分组的**首部必须携带目的主机的完整地址**
  - 这种通信方式所传送的**分组可能误码、丢失、重复和失序**
  - 由于**网络本身不提供端到端的可靠传输服务**，这就使网络中的路由器可以做得比较简单，而且加个低廉（与电信网的交换机相比较）
  - 因特网采用了这种设计思想，也就是**将复杂的网络处理功能置于因特网的边缘（用户主机和其内部的运输层）**，而将相对简单的尽最大努力的分组交付功能置于因特网核心

- 虚电路服务与数据报服务的比较

  - | 对比方面       | 虚电路服务                                     | 数据报服务                                         |
    | -------------- | ---------------------------------------------- | -------------------------------------------------- |
    | 思路           | 可靠通信应当由网络来保证                       | 可靠通信应当由用户主机来保证                       |
    | 连接的建立     | 必须建立网络层连接                             | 不需要建立网络层连接                               |
    | 终点地址       | 仅在连接建立阶段使用，每个分组使用短的虚电路号 | 每个分组都有终点的完整地址                         |
    | 分组的转发     | 属于同一条虚电路的分组均按照同一路由进行转发   | 每个分组可走不同的路由                             |
    | 当结点出故障时 | 所有通过出故障的结点的虚电路均不能工作         | 出故障的结点可能会丢失分组，一些路由可能会发生变化 |
    | 分组的顺序     | 总是按发送顺序到达终点                         | 到达终点时不一定按发送顺序                         |
    | 服务质量保证   | 可以将通信资源提前分配给每一个虚电路，容易实现 | 很难实现                                           |







### 4.3 IPv4地址

#### 4.3.1 IPv4地址概述

- 在TCP/IP体系中，IP地址是一个最基本的概念
- **IPv4地址**就是给因特网(Internet)上的**每一台主机（或路由器）的每一个接口**分配一个在全世界范围内是**唯一的32比特的标识符**
- IP地址由因特网名字和数字分配机构ICANN（Internet Corporation for Assigned Names and Numbers）进行分配
  - 我国用户可向亚太网络信息中心APNIC申请IP地址，需要缴费
  - 2011年2月3日，互联网号码分配管理局IANA（由ICANN行使职能）宣布，IPv4地址已经分配完毕
  - 我国在2014至2015年也逐步停止了向新用户和应用分配IPv4地址。同时全面开展商用部署IPv6
- **IPv4的编址方法经历了如下三个历史阶段：**
  - 分类编址（1981）
  - 划分子网（1985）
  - 无分类编址（1993）
- 32比特的IPv4地址不方便阅读、记录以及输入等，因此IPv4地址采用**点分十进制表示方法**以方便用户使用
  - 32个比特分成四组，每组8个
  - 写出每组的十进制数
  - 在每个十进制数间加上.





#### 4.3.2 分类编址的IPv4地址

- A类地址

  - 网络号占8比特，主机号占24比特
  - 网络号的最高位固定为0

- B类地址

  - 网络号和主机号各占16比特
  - 网络号的最高两位固定为10

- C类地址

  - 网络号占24比特，主机号占8比特
  - 网络号的最高三位固定为110

- D类地址

  - 是多播地址
  - 其最高四位固定为1110

- E类地址

  - 是保留地址，保留为今后使用
  - 最高四位固定为1111

- 注意事项：

  - 只有A类、B类、C类地址可分配给网络中的主机或路由器的各接口
  - 主机号为"全0"的地址是网络地址，不能分配给主机或路由器的各接口
  - 主机号为"全1"的地址是广播地址，不能分配给主机或路由器的各接口

- 小结

  - | 网络类别 | 第一个可指派的网络号 | 最后一个可指派的网络号 | 最大可指派的网络数量 | 每个网络中的最大主机数量 | 不能指派的网络号 | 占总地址空间 |
    | -------- | -------------------- | ---------------------- | -------------------- | ------------------------ | ---------------- | ------------ |
    | A        | 1                    | 126                    | 126                  | 16777214                 | 0和127           | 1/2          |
    | B        | 128.0                | 191.255                | 16384                | 65534                    | 无               | 1/4          |
    | C        | 192.0.0              | 223.255.255            | 2097152              | 254                      | 无               | 1/8          |

  - | 网络类别 | 作用           | 第一个地址 | 最后一个地址    | 地址数量               | 占总地址空间 |
    | -------- | -------------- | ---------- | --------------- | ---------------------- | ------------ |
    | D        | 多播地址       | 224.0.0.0  | 239.255.255.255 | 268435456（2的28次方） | 1/16         |
    | E        | 保留为今后使用 | 240.0.0.0  | 255.255.255.255 | 268435456（2的28次方） | 1/16         |

  - 一般不使用的特殊IP地址

    | 网络号 | 主机号     | 作为源地址 | 作为目的地址 | 代表的意思                               |
    | ------ | ---------- | ---------- | ------------ | ---------------------------------------- |
    | 0      | 0          | 可以       | 不可         | 在本网络上的本主机（DHCP协议）           |
    | 0      | host-id    | 可以       | 不可         | 在本网络上的某台主机host-id              |
    | 全1    | 全1        | 不可       | 可以         | 只在本网络上进行广播（各路由器均不转发） |
    | net-id | 全1        | 不可       | 可以         | 对net-id上的所有主机进行广播             |
    | 127    | 非全0或全1 | 可以       | 可以         | 用于本地软件环回测试                     |







#### 4.3.3 划分子网的IPv4地址

- 为新增网络申请新的网络号会带来以下弊端：
  - 需要等待时间和花费更多的费用
  - 会增加其他路由器中路由表记录的数量
  - 浪费原有网络号中剩余的大量IP地址
- 可以从主机号部分借用一部分比特作为子网号
- **32比特的子网掩码可以表面分类IP地址的主机号部分被借用了几个比特作为子网号**
  - 子网掩码使用**连续的比特1来对应网络号和子网号**
  - 子网掩码使用**连续的比特0来对应主机号**
  - 将划分子网的**IPv4地址**与其相应的**子网掩码**进行**逻辑与运算**就可得到IPv4地址所在子网的网络地址
- **给定一个分类的IP地址和其相应的子网掩码，就可知道子网划分的细节：**
  - **划分出的子网数量**
  - **每个子网可分配的IP地址数量**
  - **每个子网的网络地址和广播地址**
  - **每个子网可分配的最小和最大地址**
- **默认的子网掩码是指在未划分子网的情况下使用的子网掩码**
  - A类：255.0.0.0
  - B类：255.255.0.0
  - C类：255.255.255.0







#### 4.3.4 无分类编址的IPv4地址

- 划分子网在一定程度上缓解了因特网在发展中遇到的困难，但是**数量巨大的C类网**因为其**地址空间太小**并**没有得到充分使用**，而因特网的IP地址仍在加速消耗，整个**IPv4地址空间面临全部耗尽的威胁**
- 为此，因特网工程任务组IETF又提出了采用**无分类编址**的方法来解决IP地址紧张的问题，同时还专门成立IPv6工作组负责研究新版本IP以彻底解决IP地址耗尽问题
- 1993年，IETF发布了**无分类域间路由选择CIDR**的RFC文档：
  - **CIDR消除了传统的A类、B类和C类地址，以及划分子网的概念**
  - **CIDR可以更加有效地分配IPv4的地址空间**，并且可以在新的IPv6使用之前允许因特网的规模继续增长

- CIDR使用"**斜线记法**"，或称CIDR激发。即在IPv4地址后面加上斜线"/"。在**斜线后面加上网络前缀所占的比特数量**
- CIDR实际上是**将网络前缀都相同的连续的IP地址组成一个"CIDR地址块"**
- 我们**只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的全部细节：**
  - 地址块的最小地址
  - 地址块的最大地址
  - 地址块中的地址数量
  - 地址块聚合某类网络（A类、B类、C类）的数量：`用地址数量 除以 2的8次方`
  - 地址掩码（也可继续称为子网掩码）

- **路由聚合**（构建超网）的方法是**找共同前缀**
  - 将共同前缀以外的位全部取0，化为16进制
  - 然后再在最后添加上 `/共同前缀位数`

- **网络前缀越长，地址块越小，路由越具体**
- 若路由器查表转发分组时发现有多条路由可选，则选择网络前缀最长的那条，这称为**最长前缀匹配**，因为这样的路由更具体





#### 4.3.5 IPv4地址的应用规划

- 定长的子网掩码FLSM（Fixed Length Subnet Mask）
  - 使用同一个子网掩码来划分子网
  - 子网划分方式不灵活：只能划分出`2的n次方`个子网（n是从主机号部分借用的用来作为子网号的比特数量）
  - 每个子网所分配的IP地址数量相同，容易造成IP地址浪费
- 变长的子网掩码VLSM（Variable Length Subnet Mask）
  - 使用不同的子网掩码来划分子网
  - 子网划分方式灵活：可以按需分配
    - **分配原则：每个子块的起点位置不能随意选取，只能选取块大小整数倍的地址作为起点。建议先给大的子块分配**
  - 每个子网所分配的IP地址数量可以不同，尽可能减少对IP地址的浪费









### 4.4 IP数据报的发送和转发过程

- IP数据报的发送和转发过程包含以下两部分：
  - 主机发送IP数据报
  - 路由器转发IP数据报
- 主机发送IP数据报
  - **判断目的主机是否与自己在同一个网络**
    - 若在**同一个网络**，则属于**直接交付**
    - 若**不在同一个网络**，则属于**间接交付**，传输给主机所在网络的默认网关（路由器），由**默认网关**帮忙转发
  - **判断方法：**
    - 让**源主机的地址**和**源主机的子网掩码**`相与`得到**源主机的网络地址**
    - 让**目的主机的地址**和**源主机的子网掩码**`相与`得到**目的主机的网络地址**
    - **比较源主机和目的主机的网络地址**可知是否在同一网络
- 路由器转发IP数据报
  - **检查IP数据报首部是否出错：**
    - 若出错，则直接丢弃该IP数据报并通告源主机
    - 若没有出错，则进行转发
  - **根据IP数据报的目的地址在路由表中查找匹配的条目**
    - 若找到匹配的条目，则转发给条目中指示的下一跳
    - 若找不到，则丢弃该IP数据报并通告源主机
    - 判断是否匹配的方法：
      - 将**目的地址**和**路由表中的地址掩码**`相与`得到**目的网络地址**
      - **将得到的目的网络地址与路由表中的目的网络地址比较**，若不相同，则路由条目不匹配
      - 若相同，则路由条目匹配







### 4.5 静态路由配置及其可能产生的路由环路问题

-   静态路由配置是指用户或网络管理员使用路由器的相关命令给路由器**人工配置路由表**
  - 这种人工配置方式简单、开销小。但**不能及时适应网络状态（流量、拓扑等）的变化**
  - 一般只在小规模网络中采用
- 使用静态路由配置可能出现以下**导致**产生**路由环路**的错误
  - 配置错误
  - 聚合了不存在的网络
  - 网络故障
- 路由条目的类型
  - 直连网络
  - 静态路由（人工配置）
  - 动态路由（路由选择协议）
- 特殊的静态路由条目
  - 默认路由（目的网络为0.0.0.0，地址掩码为0.0.0.0）
    - 当要从一个网络发送数据到因特网时，由于因特网中的子网过多，会导致路由表过大，因此可以采用目的网络为默认路由的方法，节约路由表的空间
  - 特定主机路由（目的网络为 特定主机的IP地址/32，地址掩码为255.255.255.255）
    - 当要给某特定主机发送消息时
  - 黑洞路由（下一跳为null0） 
    - 相当于路由器丢弃了进入黑洞路由的IP数据报





### 4.6 路由选择协议

#### 4.6.1 路由选择协议概述

- 静态路由选择
  - 由**人工配置**的网络路由、默认路由、特定主机路由、黑洞路由等都属于静态路由
  - 这种人工配置方式简单、开销小。但**不能及时适应网络状态（流量、拓扑等）的变化**
  - 一般只在**小规模网络**中采用
- 动态路由选择
  - 路由器通过路由选择协议**自动获取路由信息**
  - 比较复杂、开销比较大。**能较好地适应网络状态的变化**
  - 适用于**大规模网络**
- 因特网所采用的路由选择协议的主要特点
  - 自适应：动态路由选择，能较好地适应网络状态的变化
  - 分布式：路由器之间交换路由信息
  - 分层次：将整个因特网划分为许多较小的自治系统AS（Autonomous System）
- 因特网采用**分层次**的路由选择协议
  - 将一些网络和路由器划分为两个自治系统AS
  - 自治系统之间的路由选择简称为域间路由选择
    - 使用外部网关协议EGP这个类别的路由选择协议
  - 自治系统内部的路由选择简称为域内路由选择
    - 内部网关协议IGP可改称为内部路由协议IRP
- 常见的路由选择协议
  - **内部网关协议IGP**
    - **路由信息协议RIP** 和 **内部网关路由协议IGRP**
      - 基于**距离向量**
        - RIP在因特网上最早使用
        - IGRP是思科早期私有的协议，现在已被EIGRP取代
    - **增强型内部网关路由协议EIGRP**
      - 思科私有的，用来取代IGRP的混合型路由协议（结合距离向量和链路状态）
    - **开放式最短路径优先OSPF** 和 **中间系统到中间系统IS-IS**
      - 基于**链路状态**
        - OSPF在各种网络中广泛使用
        - 集成化IS-IS是ISP骨干网上最长常用的IGP协议
  - **外部网关协议EGP**
    - **边界网关协议BGP**
- 路由器的基本结构
  - **路由选择部分**
    - 核心构件是路由选择处理机
    - 路由选择处理机的任务是**根据所使用的路由选择协议，周期性地与其他路由器进行路由信息的交互来更新路由表**
  - **分组转发部分**
    - 由三部分构成：
      - 交换结构
      - 一组输入端口
      - 一组输出端口
    - 信息从输入端口进入
      - 若分组为正常的信息分组，则按正常流程查表转发
      - 若分组为路由器间交换路由信息的路由报文，则送交路由选择处理机，路由选择处理机根据内容更新路由表
    - 路由表一般仅包含从目的网络到下一跳的映射
      - 路由表需要对网络拓扑变化的计算最优化
    - 转发表是从路由表得出的（转发表就是正常信息分组查的表，在交换结构中）
      - 转发表的结构应当使查找过程最优化
    - **路由器的各端口还应具有输入缓冲区和输出缓冲区**
      - **输入缓冲区用来暂存新进入路由器但还来不及处理的分组**
      - **输出缓冲区用来暂存已经处理完毕但还来不及发送的分组**







#### 4.6.2 路由信息协议RIP的基本工作原理

- **路由信息协议RIP**是内部网关协议IGP中最先得到广泛使用的协议之一，其相关标准文档为RFC 1058
- RIP要求自治系统AS内的每一个路由器都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为"**距离向量D-V(Distance-Vector）**"
- RIP使用**跳数**(Hop Count)作为度量**来衡量到达目的网络的距离**
  - 路由器到直连网络的距离定义为1
  - 路由器到非直连网络的距离定义为所经过的路由器数加1
  - 允许一条路径最多只能包含15个路由器。**"距离"等于16时相当于不可达**。因此，**RIP只适用于小型互联网**
- RIP认为**好的路由**就是"距离短"的路由，也就是**所通过路由器数量最少的路由**
- 当到达同一目的网络有多条"距离相等"的路由时，可以进行**等价负载均衡**
- RIP包含以下三个要点：
  - **和谁交换信息**——仅和**相邻路由器**交换信息
  - **交换什么信息**——自己的**路由表**
  - **何时交换信息**——**周期性交换**（例如每３０秒）
- **RIP的基本工作过程**
  - 路由器刚开始工作时，**只知道自己到直连网络的距离为1**
  - 每个路由器**仅和相邻路由器周期性地交换并更新路由信息**
  - 若干次交换和更新后，**每个路由器都知道到达本AS内各网络的最短距离和下一跳地址**，称为收敛
- **RIP的路由条目和更新规则**
  - 发现了新的网络，添加
  - 到达目的网络，相同下一跳，更新消息，更新
  - 到达目的网络，不同下一跳，新路由优势，更新
  - 到达目的网络，不同下一跳，新路由劣势，不更新
  - 到达目的网络，不同下一跳，等价负载均衡
- RIP存在"**坏消息传播得慢**"的问题
- "坏消息传播得慢"又称为**路由环路**或**距离无穷计数问题**，这是**距离向量算法的一个固有问题**。可以采取多种措施**减少**出现该问题的概率或减小该问题带来的危害
  - **限制最大路径距离**为15（16表示不可达）
  - 当路由表发生变化时就立即发送更新报文（即"**触发更新**"），而不仅是周期性发送
  - 让路由器记录收到某特定路由信息的接口，而不让同一路由器信息再通过此接口向反方向传输（即"**水平分割**"）





#### 4.6.3 开放最短路径优先OSPF的基本工作原理

- 开放最短路径优先OSPF（Open Shortest Path First），是为克服RIP的缺点在1989年开发出来的
  - "开放"表明OSPF协议不是受某一家厂商控制，而是**公开发表**的
  - "最短路径优先"是因为使用了Dijkstra提出的**最短路径算法**SPF

- OSPF是**基于链路状态**的，而不像RIP那样是基于距离向量的
- OSPF采用SPF算法计算路由，从算法上保证了**不会产生路由环路**
- OSPF**不限制网络规模**，更新效率高，**收敛速度块**
- 链路状态是指本路由器都**和哪些路由器相邻**，以及相应**链路的"代价"**（cost）
  - "代价"用来表示费用、距离、时延、带宽，等等。这些都由网络管理人员来决定
  - 思科路由器中OSPF计算代价的方法：`100Mbps / 链路带宽`
    - 计算结果小于1的值仍记为1；大于1且有小数的，舍去小数
- OSPF相邻路由器之间通过交互**问候（Hello）分组**，建立和维护**邻居关系**
  - Hello分组封装在IP数据报中，发往组播地址224.0.0.5（目的地址为224.0.0.5）
  - 发送周期为10秒
  - 若40秒未接收到来自邻居路由器的Hello分组，则认为该邻居路由器不可达
- 使用OSPF的每个路由器都会产生**链路状态通告LSA**（Link State Advertisement）。**LSA中包含以下内容：**
  - **直连网络的链路状态信息** 
  - **邻居路由器的链路状态信息**
- LAS被封装在**链路状态更新分组LSU**中，采用**洪泛**法发送
- 使用OSPF的每个路由器都有一个**链路状态数据库LSDB**，用于储存LSA
- 通过个路由器洪泛发送封装有自己LSA的LSU分组，各路由器的LSDB最终达到一致
- 使用OSPF的各路由器**基于LSDB进行最短路径优先SPF计算**，构建出各自到达其他路由器的最短路径，即构建各自的路由表
- OSPF有以下五种分组类型
  - **问候**(hello)分组
    - 用来发现和维护邻居路由器的可达性
  - **数据库描述**（Database Description）分组
    - 向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息
  - **链路状态请求**（Link State Request）分组
    - 向邻居路由器请求发送某些链路状态项目的详细信息
  - **链路状态更新**（Link State Update）分组
    - 路由器使用这种分组将其链路状态进行洪泛发送，即用洪泛法对全网更新链路状态
  - **链路状态确认**（Link State Acknowledgment）分组
    - 这是对链路状态更新分组的确认分组
- OSPF在多点接入网络中路由器邻居关系的建立
  - 选举**指定路由器DR**和**备用的指定路由器BDR**
  - **所有的非DR/BDR只与DR/BDR建立邻居关系**
  - 非DR/BDR之间通过DR/BDR交换信息
- 为了使OSPF能够用于规模很大的网络，OSPF把一个自治系统再划分为若干个更小的范围，叫做区域（Area）
  - 划分区域的好处就是**把利用洪泛法交换链路状体信息的范围局限于每一个区域而不是整个自治系统**，这就减少了整个网络上的通信量
  - 如果路由器的所有接口都在同一个区域内，那么这个路由器称为区域内路由器IR(internal router)
  - 为了本区域可以和自治系统内的其他区域连通，每个区域都会有一个区域边界路由器。它的一个接口用于连接自身所在区域，另一个接口用于连接主干区域。
  - 主干区域内的路由器称为主干路由器（区域边界路由器也可以看作主干路由器）
  - 在主干区域内还要有一个路由器专门和本自治系统外的其他自治系统交换路由信息，称为自治系统边界路由器





#### 4.6.4 边界网关协议BGP的基本工作原理

- 外部网关协议EGP（例如边界网关协议BGP）
  - 在不同自治系统内，度量路由的"代价"（距离，带宽，费用等）可能不同
  - 自治系统之间的路由选择必须考虑相关策略（政治，经济，安全等）
  - BGP只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由
- 在配置BGP时，每个自治系统的管理员要选择至少一个路由器作为该自治系统的"**BGP发言人**"
- 不同自治系统的BGP发言人要交换路由信息，首先必须建立**TCP连接**，端口号为179
  - 在此TCP连接上交换BGP报文以建立BGP会话
  - 利用BGP会话**交换路由信息**（例如，增加新的路由，或撤销过时的路由，以及报告出错的情况等）
  - 使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的**邻站**（neighbor）或**对等站**（peer）
- BGP发言人处理运行BGP外，还必须运行自己所在自治系统所使用的内部网关协议IGP，例如OSPF或RIP
- BGP发言人**交换网络可达性的信息**（要到达某个网络所要经过的一系列自治系统）
- 当BGP发言人互相交换了网络可达性的信息后，各BGP发言人就**根据**所采用的**策略**从收到的路由信息中**找出到达各自治系统的较好的路由**。也就是构造出树形结构、**不存在回路的自治系统连通图**
- BGP适用于多级结构的因特网
- BGP-4有以下四种报文
  - **OPEN（打开）报文**：用来与相邻的另一个BGP发言人建立关系，使通信初始化
  - **UPDATE（更新）报文**：用来通告某一路由的信息，以及列出要撤销的多条路由
  - **KEEPALIVE（保活）报文**：用来周期性地正式邻站的连通性
  - **NOTIFICATION（通知）报文**：用来发送检测到的差错







### 4.7 IPv4数据报的首部格式

- 版本
  - 占4比特，表示IP协议的版本。
  - 通信双方使用的IP协议版本必须一致
  - 目前广泛使用的IP协议版本号为4（即IPv4）
- 首部长度
  - 占4比特，表示IP数据报首部的长度。
  - 该字段的取值以4字节为单位
  - 最小十进制取值为5，表示IP数据报首部只有20字节固定部分
  - 最大十进制取值为15，表示IP数据报首部包含20字节固定部分和最大40字节可变部分
- 可选字段
  - 长度从1个字节到40个字节不等。
  - 用来支持排错、测量及安全等措施
  - 可选字段增加了IP数据报的功能，但这同时也使得IP数据报的首部长度成为可变的。这就增加了每一个路由器处理IP数据报的开销。实际上可选字段很少被使用

- 填充字段

  - 确保首部长度为4字节的整数倍。
  - 使用全0进行填充

- 区分服务

  - 占8比特，用来获得更好的服务
  - 1998年，因特网工程任务组IETF把这个字段改名为区分服务。利用该字段的不同数值可提供不同等级的服务质量。只有在使用区分服务时，该字段才起作用。一般情况下都不使用该字段

- 总长度

  - 占6比特，表示IP数据报的总长度（首部+数据载荷）
  - 最大取值为十进制的65535，以字节为单位

- 标识

  - 占16比特，属于同一个数据报的各分片数据报应该具有相同的标识
  - IP软件维持一个计数器，每产生一个数据报，计数器值加1，并将此值赋给标识字段

- 标志

  - 占3比特
  - 各比特含义如下：
    - DF位：1表示不允许分片；0表示允许分片
    - MF位：1表示"后面还有分片"；0表示"这是最后一个分片"；
    - 保留位：必须为0

- 片偏移

  - 占13比特，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多少个单位。
  - 片偏移以8个字节为单位

- 生存时间TTL

  - 占8比特，表示IP数据报的生存时间
  - 最初以秒为单位，最大生存周期为255秒；路由器转发IP数据报时，将IP数据报首部中的该字段减去IP数据报在本路由器上所耗费的时间，若不为0就转发，否则就丢弃
  - 现在以"跳数"为单位，路由器转发IP数据报时，将IP数据报首部中的该字段的值减1，若不为0就转发，否则就丢弃
  - IP数据报每经过一个路由器，路由器都要重新计算首部检验和，因为某些字段（生存时间、标志、片偏移等）的取值可能发生变化

- 协议

  - 占8比特，指明IPv4数据报的数据部分是何种协议数据单元

  - 常用的一些协议和相应的协议字段值：

    | 协议名称   | ICMP | IGMP | TCP  | UDP  | IPv6 | OSPF |
    | ---------- | ---- | ---- | ---- | ---- | ---- | ---- |
    | 协议字段值 | 1    | 2    | 6    | 17   | 41   | 89   |

- 首部检验和

  - 占16比特，用来检测首部在传输过程中是否出现差错
  - 比CRC检验码简单，成为因特网检验和
  - 由于IP层本身并不提供可靠传输服务，并且计算首部校验和是一项耗时的操作，因此在IPv6中，路由器不再计算首部校验和，从而更快转发IP数据报

- 源IP地址和目的IP地址

  - 各占32比特，用来填写发送该IP数据报的源主机的IP地址和接收该IP数据报的目的主机的IP地址







### 4.8 网际控制报文协议ICMP

-  为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP（Internet Control Message Protocol）
- 主机或路由器使用ICMP来发送**差错报告报文**和**询问报文**
- ICMP报文被封装在IP数据报中发送
- ICMP差错报告报文共有以下五种：
  - 终点不可达
    - 当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。具体可再根据ICMP的代码字段细分为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机位置等13种错误
  - 源点抑制
    - 当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢
  - 时间超过
    - 当路由器收到一个目的IP地址不是自己的IP数据报，会将其生存时间TTL字段的值减1
      - 若结果不为0，则将该IP数据报转发出去
      - 若结果为0，除丢弃该IP数据报外，还要向源点发送时间超过报文
    - 另外，当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，也会向源点发送时间超过报文
  - 参数问题
    - 当路由器或目的主机收到IP数据报后，根据其首部中的检验和字段发现首部在传输过程中出现了误码，就丢弃该数据报，并向源点发送参数问题报文
  - 改变路由（重定向）
    - 路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）
- 以下情况**不应发送ICMP差错报告报文**：
  - 对ICMP差错报告报文不再发送ICMP差错报告报文
  - 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
  - 对具有多播地址的数据报都不发送ICMP差错报告报文
  - 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文
- 常用的**ICMP询问报文**有以下两种：
  - **回送请求和回答**
    - ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问
    - 收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文
    - 这种询问报文用来**测试目的站是否可达**及了解其有关状态
  - **时间戳请求和回答**
    - ICMP时间戳请求报文是请某个主机或路由器回答当前的日期和时间
    - 在ICMP时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒
    - 这种询问报文用来**进行时钟同步和测量时间**
- ICMP应用：
  - 分组网间探测PING
    - 用来测试主机或路由器间的连通性
    - 应用层直接使用网际层的ICMP（没有通过运输层的TCP或UDP）
    - 使用ICMP回送请求和回答报文
  - 跟踪路由tracerouter
    - 用来测试IP数据报从源主机到达目的主机要经过哪些路由器
    - Windows版本
      - tracert命令
      - 应用层直接使用网际层ICMP
      - 使用了ICMP回送请求和回答报文以及差错报告报文
    - Unix版本
      - traceroute命令
      - 在运输层使用UDP协议
      - 仅使用ICMP差错报告报文







### 4.9 虚拟专用网VPN与网络地址转换NAT

- 虚拟专用网VPN（Virtual Private Network）
  - **利用公用的因特网作为本机构各专用网之间的通信载体**，这样的专用网又称为虚拟专用网
  - 专用（私有）地址：
    - 10.0.0.0~10.255.255.255(10/8地址块)
    - 172.16.0.0~172.31.255.255(172.16/12地址块)
    - 192.168.0.0~192.168.255.255(192.168/16地址块)
  - 同一机构内不同部门的内部网络所构成的虚拟专用网VPN又称为**内联网VPN**
  - VPN要保证传输数据的安全性，会将原始的**内部数据报进行加密**，然后再将其封装成为在因特网上发送到的外部数据报
  - 有时一个机构的VPN需要有某些外部机构（通常就是合作伙伴）参加进来。这样的VPN就称为**外联网VPN**
  - 在外地工作的员工需要访问公司内部的专用网络时，只要在任何地点接入到因特网，运行驻留在员工PC中的VPN软件，在员工的PC和公司的主机之间建立VPN隧道，即可访问专用网络中的资源。这样VPN称为**远程接入VPN**
- 网络地址转换NAT（Network Address Translation）
  - 由于IP地址的紧缺，一个机构能够申请到的IP地址数量往往小于本机构所拥有的主机数量。因此，**虚拟专用网中的各主机所分配的地址应该是本机构可自由分配的专用地址**，而不是需要申请的、在因特网上使用的公有地址
  - 虽然因特网采用了无分类编址方式来减缓IP地址空间耗尽的速度，但由于因特网用户数目的激增，特别是大量小型办公室网络和家庭网络接入因特网的需求不断增加，IPv4地址空间即将面临耗尽的危险仍然没有被解除
  - 1994年提出了一种网络地址转换**NAT的方法再次缓解了IP地址空间耗尽的问题**
  - NAT能**使大量使用内部专用地址的专用网络用户共享少量外部全球地址**来访问因特网上的主机和资源
  - 由于绝大多数的网络应用都是使用运输层协议TCP或UDP来传送数据，因此可以**利用运输层的端口号和IP地址一起进行转换**。这样，用**一个全球IP地址就可以使多个拥有本地地址的主机同时和因特网上的主机进行通信**。这种将端口号和IP地址一起进行转换的技术叫做**网络地址与端口号转换NAPT**（Network Address and Port Translation）
  - 对于一些P2P网络应用，需要**外网主机主动与内网主机进行通信，在通过NAT时会遇到问题**，需要网络应用自己使用一些特殊的NAT穿越技术来解决问题
  - 由于**NAT对外网屏蔽了内网主机的网络地址，能为内网的主机提供一定的安全保护**









## 五.运输层

### 5.1 运输层概述

- 上面介绍的物理层、数据链路层以及网络层它们共同解决了将主机通过异构网络互连起来所面临的问题，**实现了主机到主机的通信**
- 但实际上在计算机网络中进行**通信的真正实体是位于通信两端主机中的进程**
- **如何为运行在不同主机上的应用进程提供直接的通信服务是运输层的任务**，运输层协议又称为端到端协议
- 运输层向高层用户屏蔽了下面网络核心的细节（如网络拓扑、所采用的路由选择协议等），它使应用进程看见的就**好像是在两个运输层实体之间有一条端到端的逻辑通信信道**
- 根据应用需求的不同，因特网的运输层为应用层提供了两种不同的运输协议，即**面向连接的TCP**和**无连接的UDP**，这两种协议就是本章要讨论的主要内容







### 5.2 运输层端口号、复用与分用的概念

- 运行在计算机上的进程使用**进程标识符PID**来标志
- 因特网上的计算机并不是使用统一的操作系统，不同的操作系统（windows，Linux，Mac OS）又使用**不同格式的进程标识符**
- 为了使运行不同操作系统的计算机的应用进程之间能够进行网络通信，就必须**使用统一的方法对TCP/IP体系的应用进程进行标识**
- TCP/IP体系的运输层使用**端口号**来区分应用层的不同应用进程
  - 端口号使用**16比特标识**，取值范围**0~65535**
    - **熟知端口号**：0~1023，IANA把这些端口号指派给了TCP/IP体系中最重要的一些应用协议，例如：FTP使用21/20，HTTP使用80，DNS使用53
    - **登记端口号**：1024~49151，为没有熟知端口号的应用程序使用。使用这类端口号必须在IANA按照规定的手续登记，以防止重复。例如：Microsoft RDP微软远程桌面使用的端口是3389
    - **短暂端口号**：49152~65535，留给客户进程选择暂时使用。当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可供其他客户进程以后使用
  - **端口号只具有本地意义**，即端口号只是为了**标识本计算机应用层中的各进程**，在因特网中，**不同计算机中的相同端口号是没有联系的**
- 发送方的复用和接收方的分用
  - 发送方的某些应用进程所发送的不同应用报文，在运输层使用UDP协议进行封装，这称为**UDP复用**；而另一些应用进程所发送的不同应用报文，在运输层使用TCP协议进行封装，这称为**TCP复用**
  - 运输层使用端口号来区分不同的应用进程，UDP用户数据报和TCP报文段在网络层都需要使用IP协议封装成IP数据报，这称为**IP复用**
    - IP数据报中的协议字段为17时，表示封装的是UDP用户数据报；为6时，表示封装的是TCP报文段
  - 接收方的网络层收到IP数据报后进行**IP分用**
    - 若IP数据报中的协议字段为17，则把IP数据报的数据载荷部分所封装的UDP用户数据报上交运输层的UDP
    - 若协议字段为6，则把IP数据报的数据载荷部分所封装的TCP报文段上交运输层的TCP
  - 运输层对UDP用户数据报进行**UDP分用**，对TCP报文段进行**TCP分用**（也就是根据端口号将它们交付给上层相应的应用进程）
- TCP/IP体系的应用层常用协议所使用的运输层熟知端口号
  - 这些协议在运输层使用UDP协议：
    - RIP:520
    - DNS:53
    - TFTP:69
    - SNMP:161
    - DHCP:67/68
  - 这些协议在运输层使用TCP协议：
    - SMTP:25
    - FTP:21/20
    - BGP:179
    - HTTP:80
    - HTTPS:443







### 5.3 UDP和TCP的对比

- 用户数据报协议UDP（User Datagram Protocol）
  - 无连接
  - 支持一对一，一对多，多对一和多对多交互通信
  - 对应用层交付的报文直接打包
  - 尽最大努力交付，也就是不可靠；不使用流量控制和拥塞控制
  - 首部开销小，仅8字节
- 传输控制协议TCP（Transmission Control Protocol）
  - 面向连接
  - 每一条TCP连接只能由两个端点EP，只能是一对一通信
  - 面向字节流
  - 可靠传输，使用流量控制和拥塞控制
  - 首部最小20字节，最大60字节







### 5.4 TCP的流量控制

- 一般来说，我们总是希望数据传输得更快一些
  - 但如果发送方把数据发送得过快，接收方就可能来不及接收，这就会造成数据的丢失
- 所谓流量控制（flow control）就是让**发送方的发送频率不要太快，要让接收方来得及接收**
- 利用**滑动窗口**机制可以很方便地在TCP连接上实现对发送方的流量控制
  - TCP接收方利用自己的**接收窗口**的大小来限制发送方**发送窗口**的大小
  - TCP接收方收到接收方的**零窗口通知**后，应启动**持续计时器**。持续计时器超时后，向接收方发送**零窗口探测报文**







### 5.5 TCP的拥塞控制

- 在某段时间，若**对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏**。这种情况就叫做**拥塞**（congestion）

  - 在计算机网络中的链路容量（即带宽）、交换节点中的缓存和处理机等，都是网络的资源

- 若**出现拥塞而不进行控制**，整个网络的**吞吐量将随输入负荷的增大而下降**

- **拥塞控制算法举例**

  - 假设有一个发送方给接收方发送一个TCP数据报文段，接收方给发送方发送了一个TCP确认报文段

  - 发送方维护一个叫做**拥塞窗口cwnd**的状态变量，其值**取决于网络的拥塞程度**，并且**动态变化**

    - 拥塞窗口**cwnd的维护原则**：只要网络**没有出现拥塞**，**拥塞窗口**就再**增大**一些；但只要网络**出现拥塞**，**拥塞窗口就减少**一些
    - 判断出现**网络拥塞的依据**：没有按时收到应当到达的确认报文（即**发生超时重传**）

  - 发送方将拥塞窗口作为**发送窗口swnd**，即**`swnd=cwnd`**

  - 维护一个慢开始门限**ssthresh**状态变量：

    - 当`cwnd<ssthresh`时，使用慢开始算法；
    - 当`cwnd>ssthresh`时，停止使用慢开始算法而改用拥塞避免算法
    - 当`cwnd=ssthresh`时，既可使用慢开始算法，也可使用拥塞避免算法

    

  - 当发送方有发送的数据丢失了

    - 此时重传计时器超时了，判断网络很可能出现了拥塞，进行以下工作：
      - 将`ssthresh`值更新为发生拥塞时`拥塞窗口cwnd`的一半
      - 将`拥塞窗口cwnd`值减少为1，并重新开始执行慢开始算法

  

- **TCP的四种拥塞控制算法**

  - **慢开始**

    - 有几个分组被成功接收，在接收ack返回分组后，拥塞窗口cwnd就增加多少
    - “慢开始"是指一开始向网络注入的报文段少，并不是指拥塞窗口cwnd增长速度慢；

  - **拥塞避免**

    - 无论每次有多少个分组，在接收ack返回分组后，拥塞窗口cwnd加1
    - "拥塞避免"并非指完全能够避免拥塞，而是指在拥塞避免阶段将拥塞窗口控制为按线性规律增长，使网络比较不容易出现拥塞

    

  - 慢开始和拥塞避免算法是1988年提出的TCP拥塞控制算法（TCP Tahoe版本）

  - 1990年又增加了两个新的拥塞控制算法（**改进TCP的性能**），这就是快重传和快恢复（TCP Reno版本）

    - 有时，**个别报文段**会在网络中**丢失**，但实际上网络**并未发生拥塞**
      - 这将导致**发送方**超时重传，并**误认为**网络发生了**拥塞**
      - **发送方把拥塞窗口cwnd又设置为最小值1**，并错误地启动慢开始算法，因而**降低了传输效率**

    

  - **快重传**

    - 使用快重传算法可以**让发送方尽早知道发生了个别报文段的丢失**
    - 所谓快重传，就是使发送方**尽快进行重传**，而**不是等超时重传计时器超时**再重传
      - 要求接收方不要等待自己发送数据时才进行捎带确认，而是要**立即发送确认**
      - 即使收到了失序的报文段也要立即发出对已收到的报文段的重复确认
      - 发送方一旦**收到3个连续的重复确认**，就将相应的报文段**立即重传**，而不是等该报文段的超时重传计时器超时再重传
      - 对于个别丢失的报文段，发送方不会出现超时重传，也就不会误认为出现了拥塞（进而降低拥塞窗口cwnd为1）。使用快重传可以使整个网络的吞吐量提高约20%

  - **快恢复**

    - 发送方一旦收到**3个重复确认**，就知道现在只是丢失了个别的报文段。于是不启动慢开始算法，而**执行快恢复算法**；
      - **发送方将慢开始门限ssthresh值和拥塞窗口cwnd值调整为当前窗口的一半；开始执行拥塞避免算法**
      - 也有的快恢复实现是把快恢复开始时的拥塞窗口cwnd值再增大一些，即等于新的ssthresh+3
        - 既然发送方收到3个重复的确认，就表明有3个数据报文段已经离开了网络
        - 这3个报文段不再消耗网络资源而是停留在接收方的接收缓存中
        - 可见现在网络中不是堆积了报文段而是减少了3个报文段。因此可以适当把拥塞窗口扩大些





### 5.6 TCP超时重传时间的选择

- **不能直接使用某次测量得到的RTT（往返时间）样本来计算超时重传时间RTO**
- 利用每次测量得到的RTT样本，计算加权平均**往返时间RTT~S~**（又称为平滑的往返时间）
- RFC6298建议使用下式计算**超时重传时间RTO**：
  - **RTO = RTT~s~ + 4 * RTT~D~**
- **加权平均往返时间RTT~S~**
  - **RTT~S1~ = RTT~1~**
  - **新的RTT~S~ = [(1 - a) × 旧的RTT~S~] + (a × 新的RTT样本)**
    - **0 <= a < 1**
    - 若a很接近于0，则新RTT样本为RTT~S~的影响不大
    - 若a很接近于1，则新RTT样本对RTT~S~的影响较大
  - 已成为建议标准的RFC6298**推荐的a值为1/8，即0.125**
- **RTT偏差的加权平均RTT~D~**
  - **RTT~D1~ = RTT~1~ ÷ 2**
  - **新的RTT~D~ = [(1 - b) × 旧的RTT~D~] + (b × |RTT~S~ - 新的RTT样本|)**
    - **0 <= b < 1**
  - 已成为建议标准的RFC6298**推荐的b值为1/4，即0.25**
- 针对**出现超时重传时无法测准往返时间RTT**的问题，**Karn**提出了一个**算法**：**在计算加权平均往返时间RTT~S~时，只要报文段重传了，就不采用其往返时间RTT样本**。也就是出现重传时，不重新计算RTT~S~，进而超时重传时间RTO也不会重新计算
  - 这又引起了新的问题。设想出现这样的情况：报文段的时延突然增大了很多，并且之后很长一段时间都会保持这种时延。因此在原来得出的重传时间内，不会收到确认报文段。于是就重传报文段。但根据Karn算法，不考虑重传的报文段的往返时间样本。这样，超时重传时间就无法更新。这会导致报文段反复被重传
  - 因此，要对**Karn算法进行修正**。方法是：报**文段每重传一次，就把超时重传时间RTO增大一些**。典型的做法是将**新RTO的值取为旧RTO值的2倍（出现超时重传时）**







### 5.7 TCP可靠传输的实现

- TCP基于**以字节为单位的滑动窗口**来实现可靠传输
  - 发送方在未收到接收方的确认时，可将发送窗口内还未发送的数据全部发送出去
  - 接收方只接收序号落入发送窗口内的数据
- 虽然发送方的发送窗口是根据接收方的接收窗口设置的，但在同一时刻**，发送方的发送窗口并不总是和接收方的接收窗口**一样大
  - 网络传送窗口值需要经历一定的时间滞后，并且这个时间还是不确定的
  - 发送方还可能根据网络当时的拥塞情况适当减小自己的发送窗口尺寸
- 对于**不按序到达的数据应如何处理**，TCP并无明确规定
  - 如果接收方把不按序到达的数据一律丢弃，那么接收窗口的管理将会比较简单，但这样子对网络资源的利用不利，因为发送方会重复传送较多的数据
  - TCP通常对不按序到达的数据是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再**按序交付上层的应用进程**
- TCP要求接收方必须有**累积确认和捎带确认机制**，这样可以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上
  - **接收方不应过分推迟发送确认**，否则会导致发送方不必要的超时重传，这反而浪费了网络的资源
  - TCP标准规定，确认推迟的时间不应超过0.5秒。若收到一连串具有最大长度的报文段，则必须每隔一个报文段就发送一个确认[RFC 1122]
  - 捎带确认实际上并不经常发生，因为大多数应用程序很少同时在两个方向上发送数据
- **TCP的通信是全双工通信**。通信中的每一方都在发送和接收报文段。因此，每一方都有自己的发送窗口和接收窗口。在谈到这些窗口时，一定要弄清楚是哪一方的窗口







### 5.8 TCP的运输连接管理

#### 5.8.1 TCP的连接建立

- TCP是面向连接的协议，它基于运输连接来传送TCP报文段

- TCP运输连接的建立和释放是每一次面向连接的通信中必不可少的过程

- TCP运输连接有以下三个阶段：

  - 建立TCP连接
  - 数据传送
  - 释放TCP连接

- TCP的运输连接管理就是使运输连接的建立和释放都能正常地进行

- **TCP的连接建立要解决以下三个问题：**

  - 使TCP双方能够确知对方的存在 
  - 使TCP双方能够协商一些参数（如最大窗口值、是否使用窗口扩大选项和时间戳选项以及服务质量等）
  - 使TCP双方能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配

- **TCP使用"三报文握手"建立连接**

  - 有两台要基于TCP进行通信的主机

    - 其中一台主机中的某个应用进程主动发起TCP连接建立，称为**TCP客户**
    - 另一台主机中被动等待TCP连接建立的应用进程，称为**TCP服务器**

  - 可以将TCP建立连接的过程比喻位"握手",**"握手"需要在TCP客户和服务器之间交换三个TCP报文段**

  - 过程：

    - 最初，**两端的TCP进程都处于<u>关闭状态</u>**

    - 一开始，**TCP服务器进程**首先**创建传输控制块**，用来存储TCP连接中的一些重要信息（例如TCP连接表、指向发送和接收缓存的指针、指向重传队列的指针、当前发送和接收序号等）。之后，就**准备接受TCP客户进程的连接请求**

    - 此时，**TCP服务器进程就进入<u>监听状态</u>**，等待TCP客户进程的连接请求。

      - TCP服务器进程是被动等待来及TCP客户进程的连接请求，而不是主动发起，因此称为**被动打开连接**

    - **TCP客户进程**也是首先**创建传输控制块**。然后，在**打算建立TCP连接时向TCP服务器进程发送<u>*TCP连接请求报文段*</u>，并进入<u>同步已发送状态</u>**

      - TCP连接请求报文段首部中的**同步位SYN被设置为1**，表明这是一个TCP连接请求报文段；**序号字段seq被设置了一个初始值x**，作为TCP客户进程所选择的初始序号
      - **注意：TCP规定SYN被设置为1的报文段不能携带数据，但要消耗掉一个序号**
      - 由于TCP连接建立是由TCP客户主动发起的，因此称为**主动打开连接**

    - **TCP服务器进程收到TCP连接请求报文段后**，如果同意建立连接，则向TCP客户进程发送**<u>*TCP连接请求确认报文段*</u>，并进入<u>同步已接收状态</u>**

      - TCP连接请求确认报文段首部中的**同步位SYN和确认位ACK都设置为1**，表明这是一个TCP连接请求确认报文段；**序号字段seq被设置了一个初始值y**，作为TCP服务器进程所选择的初始序号；**确认号字段ack的值被设置成了x+1**，这是对TCP客户进程所选择的初始序号的确认
      - **注意：这个报文段也不能携带数据，**因为它是SYN被设置为1的报文段，但同样要消耗掉一个序号

    - **TCP客户进程收到TCP连接请求确认报文段后**，还要向TCP服务器进程发送一个***<u>普通的TCP确认报文段</u>***，并进入**<u>连接已建立状态</u>**

      - 该报文段首部中的**确认位ACK被设置为1**，表明这是一个普通的TCP确认报文段；**序号字段seq被设置为x+1**，这是因为TCP客户进程发送的第一个TCP报文段的序号为x，并且不携带数据，因此第二个报文段的序号为x+1；**确认号字段ack被设置为y+1**，这是对TCP服务进程所选择的初始序号的确认。
      - **注意：TCP规定普通的TCP确认报文段可以携带数据，但如果不携带数据，则不消耗序号。在这种情况下，所发送的下一个数据报文段的序号仍是x+1**

    - **TCP服务器进程**收到该确认报文段后也进入**<u>连接已建立状态</u>**

    - 现在，TCP双方都进入了连接已建立状态，它们可以基于已建立好的TCP连接进行可靠的数据传输了

      

    - **为什么TCP客户进程最后还要发送一个普通的TCP确认报文段呢，是否多余？**

      - **不多余！这是为了防止已失效的连接请求报文突然又传送到了TCP服务器，因而导致错误**





#### 5.8.2 TCP的连接释放

- **TCP通过"四报文挥手"来释放连接**

  - 数据传输结束后，TCP通信双方都可以释放连接
  - 现在TCP客户进程和TCP服务器进程都处于连接已建立状态

- **过程：**

  - 假设使用TCP客户进程的应用进程通知其主动关闭TCP连接，**TCP客户进程**会发送**<u>*TCP连接释放报文段*</u>**，并进入**<u>终止等待1状态</u>**

    - 该报文段首部中的**终止位FIN和确认位ACK的值都被设置为1**，表明这是一个TCP连接释放报文段，同时也对之前收到的报文段进行确认；**序号seq字段的值设置为u**，**它等于TCP客户进程之前已传送过的、数据的最后一个字节的序号加1**；**确认号ack字段的值设置为v**，**它等于TCP客户进程之前已收到的、数据的最后一个字节的序号加1**
      - **注意：TCP规定终止位FIN等于1的报文段即使不携带数据，也要消耗掉一个序号**

  - **TCP服务器进程收到TCP连接释放报文段后**，会发送一个**<u>*普通的TCP确认报文段*</u>**并进入**<u>关闭等待状态</u>**

    - 该报文段首部中的**确认位ACK的值被设置为1**，表明这是一个普通的TCP确认报文段；序号**seq字段的值设置为v**，**它等于TCP服务器进程之前已传送过的数据的最后一个字节的序号加1**，这也与之前收到的TCP连接释放报文段中的确认号匹配；**确认号ack字段的值设置为u+1**，这是对TCP连接释放报文段的确认
    - **TCP服务器进程这时应通知高层应用进程：TCP客户进程要断开与自己的TCP连接**。此时，**从TCP客户进程到TCP服务器进程这个方向的连接就释放了**，这时的TCP连接处于**<u>半关闭状态</u>**，也就是TCP客户进程已经没有数据要发送了。但TCP服务器进程如果还有数据要发送，TCP客户进程仍要接收。也就是说，**从TCP服务进程到TCP客户进程这个方向的连接并未关闭**

  - **TCP客户进程收到TCP确认报文段后**就进入**<u>终止等待2状态</u>**，等待TCP服务器进程发出的TCP连接释放报文段

  - 若使用TCP服务器进程的应用程序已经没有数据要发送了，应用进程就**通知其TCP服务器进程释放连接。**

    - 由于TCP连接释放是由TCP客户进程主动发起的，因此**TCP服务进程对TCP连接的释放称为被动关闭连接**

  - **TCP服务器进程**发送**<u>*TCP连接释放报文段*</u>**并进入**<u>最后确认状态</u>**

    - 该报文段首部中的**终止位FIN和确认位ACK的值都被设置为1**，表明这是一个TCP连接释放报文段，同时也对之前收到的报文段进行确认；现在**假定序号seq字段的值为w**，这是因为在半关闭状态下，TCP服务器进程可能又发送了一些数据；**确认号ack字段的值为u+1**，这是对之前收到的TCP连接释放报文段的**重复确认**

  - **TCP客户进程收到TCP连接释放报文段后**，必须**<u>*针对该报文段发送普通的TCP确认报文段*</u>**，之后进入**<u>时间等待状态</u>**

    - 该报文段首部中**确认位ACK的值被设置为1**，表面这是一个普通的TCP确认报文段；**序号seq字段的值设置为u+1**，这是因为TCP客户进程之前发送的TCP连接释放报文段虽然不携带数据，但是要消耗掉一个序号；**确认号ack字段的值设置为w+1**，这是对所受到的TCP连接释放报文段的确认

  - **TCP服务器进程收到该报文段后**就进入**<u>关闭状态</u>**

  - 而**TCP客户进程还要经过2MSL后**才能进入**<u>关闭状态</u>**

    - MSL的意思是最长报文段寿命，RFC793文档建议为2分钟
    - **也就是说TCP客户进程进入时间等待状态后，还要经过4分钟才能进入关闭状态**
    - TCP允许不同的实现可根据具体情况使用更小的MSL值

    

  - **TCP客户进程在发送完最后一个确认报文段后，为什么不直接进入关闭状态，而是要进入时间等待状态，2MSL后才进入关闭状态，这是否有必要？**

    - **有必要！时间等待状态以及处于该状态2MSL时长，可以确保TCP服务器进程可以收到最后一个TCP确认报文段而进入关闭状态**
    - **另外，TCP客户进程在发送完最后一个TCP确认报文段后，再经过2MSL时长，就可以使本次连接持续时间内所产生的所有报文段都从网络中消失，这样就可以使下一个新的TCP连接中，不会出现旧连接中的报文段**

    

- TCP中保活计时器的作用

  - TCP服务器进程每收到一个TCP客户进程的数据，就重新设置并启动**保活计时器**（2小时定时）
  - 若保活计时器定时周期内未收到TCP客户进程发来的数据，则**当保活计时器到时后，TCP服务器进程就向TCP客户进程发送一个探测报文段**，以后则每隔75秒发送一次。若一连发送10个探测报文段后仍无TCP客户进程的响应，TCP服务器进程就认为TCP客户进程所在主机出了故障，接着就关闭这个连接







### 5.9  TCP报文段的首部格式

- 为了实现可靠传输，TCP采用了**面向字节流**的方式
- 但TCP在发送数据时，是从发送缓存取出一部分或全部字节并给其添加一个首部使之成为**TCP报文段**后进行发送
  - 一个TCP报文段由**首部**和**数据载荷**两部分构成
  - TCP的全部功能都体现在它首部中各字段的作用

- TCP报文段的首部
  - 是由20字节的固定首部和最大40字节的扩展首部构成
  - **固定首部：**
    - **源端口**：占16比特，写入源端口号，用来**标识发送该TCP报文段的应用进程**
    - **目的端口**：占16比特，写入目的端口号，用来**标识接收该TCP报文段的应用进程**
    - **序号**：占32比特，取值范围[0,2^32^ - 1]，序号增加到最后一个后，下一个序号就又回到0
      - 用来**指出本TCP报文段数据载荷的第一个字节的符号**

    - **确认号**：占32比特，取值范围[0,2^32^ - 1]，确认号增加到最后一个后，下一个确认号就又回到0
      - 用来**指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号，同时也是对之前收到的所有数据的确认**
      - **若确认号=n，则表明到序号n-1为止的所有数据都已正确接收，期望接收序号为n的数据**

    - **确认标志位ACK**：取值为1时确认号字段才有效；取值为0时确认号字段无效
      - **TCP规定，在连接建立后所有传送的TCP报文段都必须把ACK置1**

    - **数据偏移**：占4比特，并以4字节为单位
      - **用来指出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远**
      - **这个字段实际上是指出了TCP报文段的首部长度**
        - 首部固定长度为20字节，因此数据偏移字段的最小值为(0101)~2~
        - 首部最大长度为60字节，因此数据偏移字段的最大值为(1111)~2~

    - **保留**：占6比特，保留为今后使用，但目前应置为0
    - **窗口**：占16比特，以字节为单位。**指出发送本报文段的一方的接收窗口**
      - **窗口值作为接收方让发送方设置其发送窗口的依据**
      - **这是以接收方的接收能力来控制发送方的发送能力，称为流量控制**

    - **校验和**：占16比特，检查范围包括TCP报文段的首部和数据载荷两部分。
      - 在计算校验和时，要在TCP报文段的前面加上12字节的伪首部

    - **同步标志位SYN**：在TCP连接建立时用来同步序号
    - **终止标志位FIN**：用来释放TCP连接
    - **复位标志位RST**：用来复位TCP连接
      - **当RST=1时，表明TCP连接出现了异常，必须释放连接，然后再重新建立连接**
      - **RST置1还用来拒绝一个非法的报文段或拒绝打开一个TCP连接**

    - **推送标志位PSH**：接收方的TCP收到该标志位为1的报文段会**尽快上交应用进程**，而不必等到接收缓存都填满后再向上交付
    - **紧急标志位URG**：取值为1时紧急指针字段有效；取值为0时紧急指针字段无效
    - **紧急指针**：占16比特，以字节为单位，用来指明紧急数据的长度
      - **当发送方有紧急数据时，可将紧急数据插队到发送缓存的最前面，并立刻封装到一个TCP报文段中进行发送。紧急指针会指出本报文段数据载荷部分包含了多长的紧急数据，紧急数据之后是普通数据**

  - **扩展选项：**
    - **最大报文段长度MSS选项**：TCP报文段数据载荷部分的最大长度
    - **窗口扩大选项**：为了扩大窗口（提高吞吐率）
    - **时间戳选项**：
      - 用来计算往返时间RTT
      - 用于处理序号超范围的情况，又称为防止序号绕回PAWS

    - **选择确认选项**：用来实现选择确认功能
    - **填充**：由于选项的长度可变，因此使用填充来**确保报文段首部能被4整除**（因为数据偏移字段，也就是首部长度字段，是以4字节为单位的）










## 六. 应用层

### 6.1 应用层概述

- 应用层是计算机网络体系结构的最顶层，是设计和建立计算机网络的最终目的，也是计算机网络中发展最快的部分
  - 早期基于文本的应用（电子邮件、远程登录、文件传输、新闻组）
  - 20世纪90年代将因特网带入千家万户的万维网WWW
  - 当今流行的即时通信、P2P文件共享及各种音视频应用
  - 计算设备的小型化和"无处不在"，宽带住宅接入和无线接入的日益普及和迅速发展，为未来更多的新型应用提供了广阔的舞台
- 在本章中以一些经典的网络应用为例来学习有关知识
  - 万维网WWW
  - 域名系统DNS
  - 动态主机配置协议DHCP
  - 电子邮件
  - 文件传送协议
  - P2P文件共享
  - 多媒体网络应用





### 6.2 客户/服务器方式（C/S方式）和对等方式（P2P方式）

- 网络应用程序运行在处于网络边缘的不同的端系统上，通过彼此间的通信来共同完成某项任务
- 开发一种新的网络应用首先要考虑的问题就是**网络应用程序在各种端系统上的组织方式和它们之间的关系**。目前流行的主要有以下两种：
  - 客户/服务器（Client/server，C/S）方式
  - 对等（Peer-To-Peer，P2P）方式
- **客户/服务器（Client/server，C/S）方式**
  - 客户和服务器是指通信中所设计的两个应用进程
  - 客户/服务器方式所描述的是进程之间服务和被服务的关系
  - **客户是服务请求方，服务器是服务提供方**
  - **服务器总是处于运行状态，并等待客户的服务请求**。**服务器具有固定端口号（例如HTTP服务器的默认端口号为80），而运行服务器的主机也具有固定的IP地址**
  - C/S方式是因特网上传统的、同时也是最成熟的方式，很多我们熟悉的网络应用采用的都是C/S方式。包括万维网WWW、电子邮件、文件传输FTP等
  - 基于C/S方式的应用服务通常是**服务集中型**的，即应用服务集中在网络中比客户计算机少得多的服务器计算机上
    - 由于一台服务器计算机要为多个用户及提供服务，在C/S应用中，**常会出现服务器计算机跟不上众多客户机请求的情况**
    - 为此，在C/S应用中，常用**计算机群集**（或服务器场）构建一个强大的**虚拟服务器**
- **对等（Peer-To-Peer，P2P）方式**
  - 在P2P方式中，**没有固定的服务请求者和服务提供者**，分布在网络边缘各端系统中的应用进程是对等的，被称为对等方。对等方相互之间直接通信，每个对等方既是服务的请求者，又是服务的提供者
  - 目前，在因特网上留下的P2P应用主要包括P2P文件共享、即时通信、P2P流媒体、分布式存储等
  - 基于P2P的应用是**服务分散型**的，因为服务不是集中在少数几个服务器计算机中，而是分散在大量对等计算机中，这些计算机并不为服务提供商所有，而是为个人控制的桌面计算机和笔记本电脑，它们通常位于住宅、校园和办公室中
  - P2P方式的最突出特性之一就是它的**可扩展性**。因为系统每增加一个对等方，不仅增加的是服务的请求者，同时也增加了服务的提供者，**系统性能不会因规模的增大而降低**
  - P2P方式**具有成本上的优势**，因为它通常不需要庞大的服务器设施和服务器带宽。为了降低成本，服务提供商对于将P2P方式用于应用的兴趣越来越大







### 6.3 动态主机配置协议DHCP

- 动态主机配置协议DHCP（Dynamic Host Configuration Protocol）提供了一种机制，称为即插即用连网。这种机制**允许一台计算机加入新网络时可自动获取IP地址等网络配置信息而不用手工参与**

- DHCP的工作过程

  - 当启用DHCP客户进程后，DHCP客户将广播发送**<u>DHCP发现报文</u>**。

    - 封装该报文的IP数据报的源IP地址为0.0.0.0，这是因为主机目前还为分配到IP地址，因此使用该地址来代替
    - 目的IP地址为广播地址255.255.255.255，之所以进行广播发送，是因为主机现在并不知道网络中有哪几个DHCP服务器，它们的IP地址各是什么
    - 由于是广播的IP数据报，因此网络中的所有设备都会收到该IP数据报，并对其层层解封，解封出封装有DHCP发现报文的UDP用户数据报
      - 对于DHCP客户，其应用层没有监听该UDP用户数据报目的端口67的进程，也就是DHCP服务器进程，因此无法交付DHCP发现报文，只能丢弃
      - 而对于DHCP服务器，其应用层始终运行着DHCP服务器进程，因此会接收该DHCP发现报文并作出响应
    - **DHCP发现报文其内部封装有事物ID和DHCP客户端的MAC地址**

  - DHCP服务器收到DHCP发现报文后，根据其中封装的DHCP客户端的MAC地址来查找自己的数据库，看是否有针对该MAC地址的配置信息

    - 如果有，则使用这些配置信息来构建并发送**<u>DHCP提供报文</u>**
    - 如果没有，则采用默认配置信息来构建并发送DHCP提供报文
    - 封装该报文的IP数据报的源IP地址为DHCP服务器的IP地址；目的IP地址仍为广播地址。**仍然使用广播地址的原因是，主机目前还没有配置IP地址，为了使主机可以收到，只能发送广播**

  - 这样，网络中的所有设备都会收到该IP数据报，并对其层层解封，解封出封装有DHCP发现报文的UDP用户数据报

    - 对于DHCP服务器，其应用层没有监听该UDP用户数据报目的端口68的进程，也就是DHCP客户进程，因此无法交付DHCP提供报文，只能丢弃
    - 而对于DHCP客户，其应用层运行着DHCP客户进程，因此会接收该DHCP提供报文并作出相应处理
      - **DHCP客户会根据DHCP提供报文中的事物ID来判断该报文是否是自己所请求的报文** 

    

  - **注意：DHCP服务器从自己的IP地址池中挑选待租用给主机的IP地址时，会使用ARP来确保所选IP地址未被网络中其他主机占用**

    

  - DHCP客户收到后，会向所选择的DHCP服务器发送**<u>DHCP请求报文</u>**

    - 封装该报文的IP数据报的源IP地址仍为0.0.0.0，因为此时DHCP客户才从多个DHCP服务器中挑选一个作为自己的DHCP服务器，它首先需要征得该服务器的同意，之后才能正式使用向该DHCP服务器租用的IP地址
    - 目的IP地址仍为广播地址。这样做的目的是，不用向网络中的每一个DHCP服务器单播发送DHCP请求报文，来告知它们是否请求它们作为自己的DHCP服务器
    - **DHCP请求报文**中封装有事务ID，DHCP客户端的MAC地址，接受租约中的IP地址，提供此租约的DHCP服务器端的IP地址

  - DHCP服务器收到DHCP请求报文后，向DHCP客户发送<u>**DHCP确认报文**</u>

    - 封装该报文的IP数据报的源IP地址为DHCP服务器的IP地址；目的IP地址仍为广播地址

  - DHCP客户收到该确认报文后，就可以使用所租用到的IP地址了

    

  - **注意：在使用租用的IP地址之前，主机还会使用ARP检测该IP地址是否已被网络中其他主机占用：**

    - **若被占用：给DHCP服务器发送"DHCP DECLINE“报文（DHCP谢绝报文）撤销IP地址租约，并重新发送"DHCP DISCOVER"报文**
    - **若未被占用：可以使用租约中的IP地址与网络中其他主机通信了**

    

  - 当租用期过了一半时，DHCP客户会向DHCP服务器发送**<u>DHCP请求报文</u>**，来请求更新租用期

  - DHCP服务器

    - 若同意，就发回**<u>DHCP确认报文</u>**。这样，DHCP客户就得到了新的租用期
    - 若不同意，就发回**<u>DHCP否认报文</u>**。这时，DHCP客户必须立即停止使用之前租用的IP地址，并重新发送**<u>DHCP发现报文</u>**来重新申请IP地址
      - DHCP服务器若不响应，则DHCP客户必须重新发送**<u>DHCP请求报文</u>**，然后继续等待DHCP服务器可能做出的反应
      - 若未响应，则当租用期到期后，DHCP客户必须立即停止使用之前租用的IP地址，并重新发送**<u>DHCP发现报文</u>**来重新申请IP地址

  - DHCP客户可以随时提前终止DHCP服务器所提供的租用期，这时只需要向DHCP服务器发送**<u>DHCP释放报文段</u>**即可

  - d

- DHCP主要使用以下报文来实现其功能：

  - DHCP DISCOVER: DHCP发现报文
  - DHCP OFFER: DHCP提供报文
  - DHCP REQUEST: DHCP请求报文
  - DHCP ACK: DHCP确认报文
  - DHCP NACK: DHCP否认报文
  - DHCP RELEASE: DHCP释放报文

- DHCP报文**在运输层使用UDP协议封装**

  - DHCP客户使用的UDP端口号为68
  - DHCP服务器使用的UDP端口号为67

- DHCP客户在**未获取到IP地址时使用地址0.0.0.0**

- 在每一个网络上都设置一个DHCP服务器会使DHCP服务器的数量太多。因此现在是使每一个网络至少有一个**DHCP中继代理（通常是一台路由器）**，它配置了DHCP服务器的IP地址信息，作为各网络中计算机与DHCP服务器的桥梁







### 6.4 域名系统DNS（Domain Name System）

- 域名系统DNS是因特网使用的命名系统，用来把便于人们记忆的具有特定含义的主机名（例如：www,hnust.cn），转换为便于机器处理的IP地址
- 因特网采用**层次树状结构的域名结构**
  - 域名的结构由若干个分量组成，各分量之间用"点"隔开，分别代表不同级别的域名：`….三级域名.二级域名.顶级域名`
    - 每一级的域名都由英文字母和数字组成，不超过63个字符，不区分大小写字母
    - 级别最低的域名写在最左边，而级别最高的顶级域名写在最右边
    - 完整的域名不超过255个字符
  - 域名系统既不规定一个域名需要包含多少个下级域名，也不规定每一级的域名代表什么意思
  - 各级域名由其上一级的域名管理机构管理，而最高的顶级域名则由因特网名称与数字地址分配机构ICANN进行管理
- 顶级域名TLD（Top Level Domain）分为以下三类：
  - 国家顶级域名nTLD
    - 采用ISO 3166规定。如cn表示中共，us表示美国，uk表示英国等
  - 通用顶级域名gTLD
    - 最常见的通用顶级域名有七个，即：com（公司企业）、net（网络服务机构）、org（非营利性组织）、int（国际组织）、edu（美国教育结构）、gov（美国政府部门）、mil（美国军事部门）
  - 反向域arpa
    - 用于反向域名解析，即IP地址反向解析为域名
- 在**国家顶级域名下注册的二级域名均由该国家自行确定**。
  - 例如，顶级域名为jp的日本，将其教育和企业机构的二级域名定为ac和co，而不用edu和com
- **我国**则将**二级域名**划分为以下**两类**：
  - 类别域名
    - 共七个：ac（科研机构）、com（工、商、金融等企业）、edu（教育机构）、gov（政府部门）、net（提供网络服务的机构）、mil（军事机构）和org（非营利性组织）
  - 行政区域名
    - 共34个，适用于我国的各省、自治区、直辖市
- 域名和IP地址的映射关系必须保存在域名服务器中，供所有其他应用查询。显然不能将所有信息都储存在一台域名服务器中。DNS使用**分布在各地的域名服务器**来实现域名到IP地址的转换
- 域名服务器可以划分为以下四种不同的类型
  - **根域名服务器**
    - 根域名服务器是最高层次的域名服务器。每个根域名服务器都知道所有的顶级域名服务器的域名及其IP地址。因特网上共有**13个**不同IP地址的根域名服务器。尽管我们将这13个根域名服务器中的每一个都视为单个的服务器，但"每台服务器"实际上是由许多分布在世界各地的计算机构成的**服务器群集**。当本地域名服务器向根域名服务器发出查询请求时，路由器就把查询请求报文转发到离这个DNS客户最近的一个根域名服务器。这就加快了DNS的查询过程，同时也更合理地利用率因特网的资源。**根域名服务器通常并不直接对域名进行解析，而是返回该域名所属顶级域名的顶级域名服务器的IP地址**
  - **顶级域名服务器**
    - 这些域名服务器负责**管理在该顶级域名服务器注册的所有二级域名**。当收到DNS查询请求时就给出相应的回答（可能是最后的结构，也可能是下一级权限域名服务器的IP地址）
  - **权限域名服务器**
    - 这些域名服务器负责**管理某个区的域名**。每一个主机的域名都必须在某个权限域名服务器处注册登记。因此权限域名服务器知道其管辖的域名与IP地址的映射关系。另外，权限域名服务器还知道其下级域名服务器的地址
  - **本地域名服务器**
    - 本地域名服务器不属于上述的域名服务器的等级结构。当一个主机发出DNS请求报文时，这个报文就首先被送往该主机的本地域名服务器。**本地域名服务器起着代理的作用，会将该报文转发到上述的域名服务器的等级结构中**。每一个因特网服务提供者ISP，一个大学，甚至一个大学里的学院，都可以拥有一个本地域名服务器，它有时也被称为**默认域名服务器**。本地域名服务器离用户较近，一般不超过几个路由器的距离，也有可能就在同一个局域网中，本地域名服务器中的IP地址需要直接配置在域名解析的主机中
- 域名解析的过程使用两种域名查询方式
  - **递归查询**
    - 主机想知道y.abc.com的IP地址，查询信息会依次**采用递归查询**传到本地域名服务器，根域名服务器，顶级域名服务器，权限域名服务器，查询到结果后依次返回
  - **迭代查询**
    - 主机想知道y.abc.com的IP地址，主机首先向其本地域名服务器进行递归查询
      - 本地域名服务器采用迭代查询，它先向某个根域名服务区查询
      - 根域名服务器告诉本地域名服务器，下一次应查询的顶级域名服务器的IP地址。本地域名服务器向顶级域名服务器进行迭代查询
      - 顶级域名服务器告诉本地域名服务器，下一次应查询的权限域名服务器的IP地址。本地域名服务器向权限域名服务器进行迭代查询
      - 顶级域名服务器告诉本地域名服务器所查询的域名的IP地址。
      - 本地域名服务器最后把查询结果告诉主机
  - **由于递归查询对于被查询的域名服务器负担太大，通常采用以下模式：从请求主机到本地域名服务器的查询是递归查询，而其余的查询是迭代查询**
- 为了提高DNS的查询效率，并减轻根域名服务器的负荷和减少因特网上的DNS查询报文数量，在域名服务器和主机中广泛地使用了**高速缓存**
  - **高速缓存用来存放最近查询过的域名以及从何处获得域名映射信息的记录**
  - 由于域名到IP地址的映射关系并不是永久不变，为保持高速缓存中的内容正确，域名服务器**应为每项内容设置计时器并删除超过合理时间的项**（例如，每个项目只存放两天）
  - 不但在本地域名服务器中需要高速缓存，在用户主机中也很需要。**许多用户主机在启动时从本地域名服务器下载域名和IP地址的全部数据库，维护存放自己最近使用的域名的高速缓存，并且只在从缓存中找不到域名时才向域名服务器查询**。同理，主机也需要保持高速缓存中内容的正确性
- DNS报文使用运输层的UDP协议进行封装，运输层**端口号为53**







### 6.5 文件传送协议FTP

- 将某台计算机中的文件通过网络传送到可能相距很远的另一台计算机中，是一项基本的网络应用，即文件传送
- **文件传送协议FTP**（File Transfer Protocol）是因特网上使用得最广泛的文件传送协议
  - FTP**提供交互式的访问**，允许客户**指明文件的类型与格式**（如指明是哦福使用ASCII码），并允许**文件具有存取权限**（如访问文件的用户必须经过授权，并输入有效的口令）
  - **FTP屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件**
- 在因特网发展的早期阶段，用FTP传送文件约占整个因特网的通信量的三分之一，而电子邮件和域名系统所产生的通信量还要小于FTP所产生的通信量。只是到了1995年，万维网WWW的通信量才首次超过了FTP
- FTP的用途
  - FTP的常见用途是在计算机之间传输文件，尤其是用于批量传输文件
  - FTP的另一个常见用途是让网站设计者将构成网站内容的大量文件批量上传到它们的Web服务器
- FTP的基本工作原理
  1.  FTP客户发起TCP连接与FTP服务器连接，这是用于传送控制命令的TCP连接
  2. 有数据要传输时，FTP客户通过命令通道告知FTP服务器来与自己的另一个临时端口号建立TCP连接，建立数据通道
  3. FTP服务器发起TCP连接与FTP客户连接，这是用于传送数据的TCP连接
     - **因为建立数据通道时，FTP服务器主动连接FTP客户，因此称为主动模式**
  4. -----------------------------------------------------分割线--------------------------------------------------------------------------
  5. 被动模式：基本与主动模式相同，不同在于当有数据要传输时，FTP客户发起TCP连接FTP服务器
- FTP客户和服务器要**建立以下两个并行的TCP连接**：
  - **控制连接**，**在整个会话期间一直保持打开，用于传送FTP相关控制命令**
  - **数据连接**，**用于文件传输，在每次文件传输时才建立，传输结束就关闭**
  - **默认情况下，FTP使用TCP 21端口进行控制连接，TCP 20端口进行数据连接**。但是，是否使用TCP 20端口建立数据连接与传输模式有关，**主动方式使用TCP 20端口，被动方式由服务器和客户端自行协商决定**







### 6.6 电子邮件

- 电子邮件系统采用**客户/服务器方式**。三个主要组成构建：**用户代理，邮件服务器**，以及电子邮件所需的**协议**

  - **用户代理**是用户与电子邮件系统的接口，又称为**电子邮件客户端软件**
  - **邮件服务器**是电子邮件系统的基础设施。因特网上所有的ISP都有邮件服务器，其功能是**发送和接收邮件**，同时还要负责维护用户的邮箱
  - **协议**包括邮件**发送协议**（例如SMTP）和邮件**读取协议**（例如POP3）

- 发送过程

  - **发送方用户代理作为SMTP客户**与**发送方邮件服务器中的SMTP服务**求进行TCP连接，然后基于这条连接，使用SMTP协议来发送邮件给发送方邮件服务器

  - **发送方邮件服务器中的SMTP客户**与**接收方邮件服务器中的SMTP服务器**进行TCP连接，然后基于这条连接，使用SMTP协议来发送已收到的待转发邮件给接收方邮件服务器

  - **接收方的用户代理作为POP3客户**，与**接收方邮件服务器中的POP3服务器**进行TCP连接，然后基于这条连接，使用POP3协议从接收方邮件POP3服务器读取邮件

  - 发送协议的使用范围：包含发送方用户代理到发送方邮件服务器，以及发送方邮件服务器到接收方邮件服务器这两部分

  - 接收协议的使用范围：只有接收方用户代理到接收方邮件服务器这一部分

    

- '常用的**邮件发送协议**是**简单邮件传送协议SMTP**

  - 基于TCP连接，端口号为25
  - 只能传送ASCII码文本
  - 用于用户代理向邮件服务器发送邮件以及邮件服务器之间的邮件发送
  - 基本工作原理
    - 发送方邮件服务器周期性地扫描邮件缓存，如果发现有待转发的邮件，则**发送方邮件服务器中的SMTP客户会与接收方邮件中的SMTP服务器进行TCP连接**，端口号为25。之后，SMTP客户就可以基于这条TCP连接给SMTP服务器发送SMTP命令（共14条）。SMTP服务器也会给SMTP客户发送相应的应答（共21种）
    - 当TCP连接建立成功后，SMTP服务器会主动**推送服务就绪应答给SMTP客户（应答代码220**后面可能跟有描述信息）
    - SMTP客户收到该应答后，向服务器表达身份，**告知自己SMTP服务器的域名，具体命令为`HELO`**
    - SMTP服务器若**认为身份有效，则发回应答代码250**。否则发回其他代码，例如421表示服务不可用
    - SMTP客户收到该应答后，使用**命令`MAIL FROM`来告诉服务器邮件来自何方**
    - SMTP服务器若**认为合理，则发回应答代码250**。否则发回其他错误代码
    - SMTP客户收到该应答后，使用**命令`RCPT TO`来高速服务器邮件去往何地，也就是收件人邮箱**
    - SMTP服务器中如果**有该收件人邮箱，则发回应答代码250**。否则发回其他错误代码
    - SMTP客户收到该应答后，使用**命令`DATA`来告诉服务器自己准备发送邮件内容了**
    - SMTP服务器如果**准备好接收，则发回应答代码354**。否则发回其他错误代码
    - SMTP客户收到该应答后，就**向服务器发送邮件内容。SMTP客户发送完邮件内容后，还要发送结束符**
    - SMTP服务器**若收件成功，则发回应答代码250**。否则发回其他错误代码
    - SMTP客户收到应答后，使用**命令`QUIT`向服务器请求断开连接**
    - SMTP服务器发回**应答代码221表示接受请求并主动断开连接**

- 为解决SMTP传送非ASCII码文本的问题，提出了**多用途因特网邮件扩展MIME**

  - 增加了**5个新的邮件首部字段**，这些字段提供了有关邮件主体的信息
  - 定义了**许多邮件内容的格式**，对多媒体电子邮件的表示方法进行了标准化
  - 定义了**传送编码**，可对任何内容格式进行转换，而不会被邮件系统改变

- 电子邮件的信息格式

  - 电子邮件的信息格式并不是由SMTP定义的，而是在RFC 822中单独定义的。一个电子邮件有**信封**和**内容**两部分。而内容又由**首部**和**主体**两部分构成

  - 首部中有一些关键字，如：

    - From：后面填入发件人的电子邮件地址，一般由邮件系统自动填入
    - To：后面填入一个或多个收件人的电子邮件
    - Cc：后面填入一个或多个收件人以外的抄送人的电子邮件地址。抄送人收到邮件后，可看可不看邮件，可回可不回邮件
    - Subject：后面填入邮件的主题，它反映了邮件的内容

  - 首部填写完成后，邮件系统将自动提取所需信息并写在信封上

    

- 常用的**邮件读取协议**有以下两个：

  - **邮局协议POP3**：非常简单、功能有限的邮件读取协议。用户只能以下载并删除方式或下载并保留方式从邮件服务器下载邮件到用户方计算机。**不允许用户在邮件服务器上管理自己的邮件**
  - **因特网邮件访问协议IMAP**：功能比POP3强大的邮件读取协议。**用户在自己的计算机上就可以操控邮件服务器中的邮箱**，就像在本地操控一样，因此IMAP是一个联机协议
  - POP3和IMAP4都采用**基于TCP连接的客户/服务器方式**。POP3使用端口110，IMAP4使用端口143

- 基于万维网的电子邮件

  - 通过**浏览器**登录（提供用户名和口令）**邮件服务器万维网网站**就可以撰写，收发，阅读和管理电子邮件。这种工作模式与IMAP很类似，不同的是用户计算机无需安装专门的用户代理程序，只需要使用通用的万维网浏览器
  - 这种工作模式在**用户浏览器与邮件服务器网站之间使用HTTP协议**，而**邮件服务器之间使用SMTP协议**







### 6.7 万维网

- 万维网WWW（Worid Wide Web）是一个大规模的、联机式的信息储藏所，是运行在因特网上的一个**分布式应用**

- 浏览器最重要的部分是**渲染引擎**，也就是**浏览器内核**，负责对网页内容进行解析和显示

- 万维网使用**统一资源定位符URL**来指明因特网上任何种类"资源"的位置。其一般形式为：`<协议>://<主机>:<端口>/<路径>`

- 万维网文档

  - **超文本标记语言HTML**，使用多种"标签"来描述网页的结构和内容。（网页扩展名为.html）
  - **层叠样式表CSS**，从审美角度来描述网页的样式。（文件扩展名为.css）
  - **脚本语言JavaScript**，控制网页的行为。（文件扩展名为.js）

- **超文本传输协议HTTP**（HyperText Transfer Protocol）定义了浏览器（即万维网客户进程）怎样向万维网服务器请求万维网文档，以及万维网服务器怎样把万维网文档传送给浏览器。

  - HTTP/1.0采用**非持续连接**方式。每次浏览器要请求一个文件都要与服务器建立TCP连接（80端口），当收到响应后就立即关闭连接
    - **每请求一个文档就要有两倍的RTT（传输时延）的开销**。若一个网页上有很多引用对象（例如图片等），那么请求每一个对象都需要花费2RTT的时间
    - 为了减少时延，**浏览器通常会建立多个并行的TCP连接同时请求多个对象**。但是，这会大量占用万维网服务器的资源，特别是万维网服务器往往要同时服务于大量客户的请求，这会使其负担很重
  - HTTP/1.1采用**持续连接**方式。万维网服务器在发送响应后仍然保持这条连接，使同一个客户（浏览器）和该服务器可以继续在这条连接上传送后续的HTTP请求报文和响应报文。为了进一步提高效率，还可采用**流水线**方式，即浏览器在收到HTTP的响应报文之前就能够连续发送多个请求报文

- HTTP有两类报文：**请求报文和响应报文**。报文中的每一个**字段**都是一些**ASCII码串**，并且每个字段的**长度**都是**不确定**的

- Cookie提供了一种机制使得万维网服务器能够"记住"用户，而无需用户主动提供用户标识信息。也就是说，**Cookie是一种对无状态的HTTP进行状态化的技术**

- 万维网缓存与代理服务器

  - 在万维网中还可以使用缓存机制以提高万维网的效率。
  - 万维网缓存又称为**Web缓存**，可位于客户机，也可位于中间系统上，位于中间系统上的Web缓存又称为**代理服务器**
  - Web缓存把最近的一些请求和响应暂存在本地磁盘中。**当新请求到达时，若发现这个请求与暂时存放的请求相同，就返回暂存的响应，而不需要按URL的地址再次去因特网访问该资源**

  
