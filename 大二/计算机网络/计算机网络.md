# 计算机网络

## 一.概述

### 1.1 计算机网络在信息时代的作用

- 计算机网络已由一种**通信基础设施**发展成为一种重要的**信息服务基础设施**
- 计算机网络已经像水、电、煤气这些基础设施一样，成为我们**生活中不可或缺**的一部分



### 1.2 因特网概述

#### 1.2.1 网络、互联网和因特网

- 网络（Network）由若干**结点**(Node)和连接这些节点的**链路**（Link）组成
- 多个网络还可以通过路由器互连起来，这样就构成了一个覆盖范围更大的网络，即互联网（互连网）。因此，互联网是"**网络的网络**"
- 因特网（Internet）是世界上最大的互连网络（用户数以亿计，互连的网络数以百万计）
- `internet`和`Internet`的区别
  - `internet`（互联网或互连网）是一个通用名词，它泛指由多个计算机网络互连而成的网络。在这些网络之间的通信协议可以是任意的
  - `Internet`（因特网）则是一个专用名词，它指当前全球最大的、开放的、由众多网络相互连接而成的特定计算机网络，它采用TCP/IP协议族作为通信的规则，其前身是美国的ARPANET



#### 1.2.2 因特网发展的三个阶段

- 从单个网络ARPANET向互联网发展
  - 1969年，第一个分组交换网**ARPANET**
  - 70年代中期，研究多种网络之间的互连
  - 1983年，**TCP/IP协议**成为ARPANET的标准协议（因特网诞生时间）
- 逐步建成三级结构的因特网
  - 1985年，NSF围绕六个大型计算机中心建设**NSFNET**（主干网、地区网和校园网）
  - 1990年，ARPANET任务完成，正式关闭
  - 1991年，美国政府将因特网主干网交给私人公司经营，并开始对接入因特网的单位收费
- 逐步形成了多层次ISP结构的因特网
  - 1993年，NSFNET逐渐被若干个商用因特网主干网替代；政府机构不再负责因特网运营，让各种**因特网服务提供者ISP**来运营
  - 1994年，**万维网WWW技术**促使英特网迅猛发展
  - 1995年，NSFNET停止运作，**因特网彻底商业化**



#### 1.2.3 因特网的标准化工作

- 因特网服务提供者**ISP**（Internet Service Provider）
- 因特网的标准化工作对因特网的发展起到了非常重要的作用
- 因特网在制定其标准上的一个很大的特点是**面向公众**
  - 因特网所有的RFC（Request For Comments）技术文档都可以从因特网上免费下载（http://www.ietf.org/rfc.html)
  - 任何人都可以随时用电子邮件发表对某个文档的意见或建议
- **因特网协会ISOC**是一个国际性组织，它负责对因特网进行全面管理，以及在世界范围内促进其发展和使用
  - 因特网体系结构委员会IAB，负责管理因特网有关协议的开发；
  - 因特网工程部IETF，负责研究中短期工程问题，主要针对协议的开发和标准化
  - 因特网研究部IRTF，从事理论方面的研究和开发一些需要长期考虑的问题
- 制定因特网的正式标准要经过以下**4个阶段**：
  - 因特网草案（在这个阶段还不是RFC文档）
  - 建议标准（从这个阶段开始就成为RFC文档）
  - 草案标准
  - 因特网标准



#### 1.2.4 因特网的组成

- 边缘部分

  - 由所有连接在因特网上的**主机**组成。这部分是**用户直接使用**的，用来进行**通信**（传送数据、音频或视频）和**资源共享**

- 核心部分

  - 由**大量网络**和连接这些网络的**路由器**组成。这部分是**为边缘部分提供服务**的（提供连通性和交换）

  

### 1.3 三种交换方式

- 电路交换(Circuit Switching)

  - 电话交换机接通电话线的方式称为电路交换
  - 从通信资源的分配角度来看，交换（Switching）就是按照某种方式动态地分配传输线路的资源
  - 电路交换的三个步骤：
    - 建立连接（分配通信资源）
    - 通话（一直占用通信资源）
    - 释放连接（归还通信资源）

- **分组交换(Packet Switching)**

  - 比如发送方要给接收方发送一段消息，**表示该消息的整块数据称为一个报文**。**在发送报文之前，先把较长的报文划分成为一个个更小的等长数据段，在每一个数据段前面，加上一些由必要的控制信息组成的首部后，就构成为一个分组，也可称为"包"**
  - 发送方需要：构造分组，发送分组
  - 路由器需要：缓存分组，转发分组
  - 接收方需要：接收分组，还原报文

- 报文交换(Message Switching)

  - 与分组交换类似，但是报文大小没有限制

- 电路交换、报文交换、分组交换的对比

  - 电路交换
    - 优点：通信时延小、有序传输、没有冲突、适用范围广、实时性强、控制简单
    - 缺点：建立连接时间长、线路独占，使用效率低、灵活性差、难以规格化
  - 报文交换
    - 优点：无需建立连接、动态分配线路、提高线路可靠性、提高线路利用率、提供多目标服务
    - 缺点：引起了转发时延、需要较大存储缓存空间、需要传输额外的信息量
  - **分组交换**
    - 优点：无需建立连接、线路利用率高、简化了存储管理、加速传输、减少出错概率和重发数据量
    - 缺点：引起了转发时延、需要传输额外的信息量、对于数据报服务，存在失序、丢失或重复分组的问题；对于虚电路服务，存在呼叫建立、数据传输和虚电路释放三个过程

  

### 1.4 计算机网络的定义和分类

#### 1.4.1  计算机网络的定义

- 计算机网络的精确定义并未统一

- 计算机网络最简单的定义是：**一些互<u>相连接的</u>、<u>自治</u>的计算机的<u>集合</u>**

  - 互连：是指计算机之间可以通过有线或无线的方式进行数据通信
  - 自治：是指独立的计算机，它具有自己的硬件和软件，可以单独运行使用
  - 集合：是指至少需要两台计算机 

- 计算机网络的较好的定义是：计算机网络主要是由一些**通用的、可编程的硬件互连**而成的，而这些硬件并非专门用来实现某一特定目的（例如，传送数据或视频信号）。这些可编程的硬件能够用来**传送多种不同类型的数据**，并能**支持广泛的和日益增长的应用**

  - 计算机网络所连接的硬件，并不限于一般的计算机，而是包括了智能手机等智能硬件
  - 计算机网络并非专门用来传送数据，而是能够支持很多种的应用（包括今后可能出现的各种应用）

  

#### 1.4.2 计算机网络的分类

- **按交换技术分类**

  - 电路交换网络
  - 报文交换网络
  - 分组交换网络

- **按使用者分类**

  - **公用网：指电信公司出资建造的大型网络**
    - "公用"的意思就是所有愿意按电信公司的规定缴纳费用的人都可以使用这种网络
    - 因此公用网也可称为公众网
  - **专用网：指某个部门为本单位的特殊业务工作的需要而建造的网络**
    - 不向本单位以外的人提供服务。如：军队、铁路、电力等系统均有本系统的专用网

- **按传输介质分类**

  - **有线网络**
    - 包括双绞线网络、光纤网络等
  - **无线网络**
    - WIFI技术应用比较普遍

- **按网络覆盖范围分类**

  - **广域网WAN**
    - 作用距离为几十至几千公里，可以覆盖一个国家、地区，甚至横跨几个洲
    - 有时也称为远程网
    - 是因特网的核心部分，其任务是为核心路由器提供远距离（例如，跨越不同国家的）高速连接，互连分布在不同区域的城域网和局域网
  - **城域网MAN**
    - 作用距离为5到50公里。覆盖范围一般是一个城市，可跨越几个街区甚至整个城市
    - 城域网通常作为城市骨干网，互连大量企业、机构和校园局域网
  - **局域网LAN**
    - 局域网一般用微型计算机或工作站通过高速通信线路相连，速率通常在10Mbit/s以上
    - 地理上局限在较小范围内，如一个实验室，一栋楼或一个校园内，距离一般在一公里左右
    - 局域网通常由某个单位单独拥有、使用和维护
  - **个域网PAN**
    - 是个人区域网络的简称
    - 也称为无线个人区域为WPAN，覆盖范围大约为10米

- **按拓扑结构分类**

  - **总线型网络**
    - **使用单根传输线把计算机连接起来**
    - 优点是建网容易、增减节点方便、节省线路
    - 缺点是重负载时通信效率不高，总线任意一处出现故障，则全网瘫痪
  - **星型网络**
    - **是将每个计算机都以单独的线路与中央设备相连**
    - 中央设备早期是计算机，后来是集线器。现在一般是交换机或路由器
    - 这种网络拓扑便于网络的集中控制和管理，因为端用户之间的通信必须经过中央设备
    - 缺点是成本高，中央设备对故障敏感
  - **环形网络**
    - **环形网络是将所有计算机的网络接口连接成一个环**。最典型的例子是令牌环局域网
    - 环可以是单环，也可以是双环，**环中信号是单向传输的**
  - 网状型网络
    - **一般情况下，每个结点至少由两条路径与其他结点相连**，多用在广域网中
    - 优点是可靠性高，缺点是控制复杂、线路成本高
  - 注意：以上四种基本的网络拓扑还可以互连成为更复杂的网络

  





### 1.5 计算机网络的性能指标

- 性能指标可以从不同的方面来度量计算机网络的性能
- **常用的计算机网络的性能指标有以下8个：**
  - 速率
  - 带宽
  - 吞吐量
  - 时延
  - 时延带宽积
  - 往返时间
  - 利用率
  - 丢包率
- **速率**
  - 比特(bit)：比特是计算机中**数据量的单位**，也是信息论中信息量的单位。一个比特就是二进制数字中的一个1或一个0
  - 常用的数据量单位有：
    - 字节（Byte）：8 bit = 1 Byte
    - 千字节（KB），这里的K为2的10次方：1 KB = 2的十次方B = 1024 B
    - 兆字节（MB）：1 MB = 1024 KB
    - 吉字节（GB）：1 GB = 1024 MB
    - 太字节（TB）：1 TB = 1024 GB
  - **速率：指连接在计算机网络上的主机在数字信道上传送比特的速率，也成为<u>比特率</u>或<u>数据率</u>**
  - 常用数据率单位有：
    - bit/s（b/s，bps）
    - kb/s = 1000 b/s（bps）
    - Mb/s = k*kb/s = 1000 * 1000 b/s = 10的六次方b/s（bps）
    - Gb/s = k*Mb/s = 10的三次方 * 10的六次方 = 10的九次方 b/s（bps）
    - Tb/s = k*Gb/s = 10的三次方 * 10的九次方 = 10的十二次方 b/s（bps）
  - **注意：数据率中的k常用小写，而数据量中的K常用大写。小写k在速率单位中的值为10的三次方，也就是1000；而大写K在数据量单位中的值为2的10次方，也就是1024**

- **带宽**

  - **带宽在模拟信号系统中的意义：**
    - **是指<u>信号</u>所包含的各种不同频率成分所占据的<u>频率范围</u>**
    - 单位：Hz(kHz,MHz,GHz)
  - **带宽在计算机网络中的意义：**
    - 用来表示网络的**通信线路**所能传送数据的能力，因此网络带宽表示在单位时间内从网络中的某一点到另一点所能通过的**"最高数据率"**
    - 单位：b/s (kb/s,Mb/s,Gb/s,Tb/s)
  - **带宽的这两种表述之间有着密切的联系。一条通信线路的"频带宽度"越宽，其所传输数据的"最高数据率"也越高**

- 吞吐量

  - **吞吐量表示在单位时间内通过某个网络（或信道、接口）的数据量**
  - 吞吐量经常被用于对现实世界中的网络的一种策略，以便知道实际上到底有多少数据量能够通过网络
  - **吞吐量受网络的带宽或额定速率的限制**

- 时延

  - 分组从源主机传送给目的主机的过程中，**网络时延由三部分构成：**
    - **源主机将分组发往传输线路**，这需要花费一定时间，我们把这段时间称为**发送时延**
      - **计算公式：`分组长度(b) 除以 发送速率(b/s)`**
    - **代表分组的电信号在链路上传输**，这也需要一定的时间，我们把这段时间称为**传播时延**
      - **计算公式：`信道长度(m) 除以 电磁波传播速率(m/s)`**
      - **电磁波在自由空间中的传播速率为`3*10的八次方m/s`；在网络传输媒体中的传播速率比在自由空间中要略低一些，在铜线电缆中约为`2.3*10的八次方m/s`，在光纤中的传播速率约为`2.0*10的八次方m/s`**
      - 因此，**要计算传播时延，首先应该确定采用的是什么传输媒体，进而确定电磁波在该传输媒体中的传播速率**
    - **路由器收到分组后，对其进行存储转发**，这也需要花费一定时间，我们称为**处理时延**
      - 一般不方便计算

- 时延带宽积

  - **指的是传播时延与带宽的乘积**（可以类比为体积）
  - 若发送端连续发送数据，则在发送的第一个比特即将到达终点时，发送端就已经发送了时延带宽积个比特
  - 链路的时延带宽积又称为**以比特为单位的链路长度**

- 往返时间

  - 在很多情况下，因特网上的信息不仅仅单方向传输，而是双向交互；我们有时候很需要知道双向交互一次所需的时间。因此，**往返时间RTT**（Round-Trip Time）也是一个重要的性能指标
  - **往返时间是指：从源主机发送分组开始，直到源主机收到来自目的主机的确认分组为止，所需要的时间**

- 利用率

  - 信道利用率
    - 用来表示某信道有百分之几的时间是被利用的（有数据通过）
  - 网络利用率
    - 全网络的信道利用率的加权平均
  - 根据排队论， 当某信道的利用率增大时，该信道引起的时延也会迅速增加。因此，**信道利用率并非越高越好**
  - 如果令**D0表示网络空闲时的时延，D表示网络当前的时延**，那么在适当的假定条件下，可以用下面的简单公式来表示**D、D0和利用率U之间的关系：`D = D0/(1-U)`**。以D为纵轴，U为横轴画图可知：
    - 当网络的利用率达到50%时，时延就要加倍
    - 当网络的利用率超过50%时，时延急剧增大
    - 当网络的利用率接近100%时，时延就趋于无穷大
    - 因此，一些拥有较大主干网的ISP通常会控制它们的信道利用率不超过50%。如果超过了，就要准备扩容，增大线路的带宽
  - 也不能使信道利用率太低，这会使宝贵的通信资源被白白浪费。应该使用一些机制，可以根据情况动态调整输入到网络中的通信量，使网络利用率保持在一个合理的范围内

- 丢包率

  - **丢包率即分组丢失率，是指在一定的时间范围内，传输过程中<u>丢失的分组数量与总分组数量的比率</u>**

  - 丢包率具体可分为接口丢包率、结点丢包率、链路丢包率、路径丢包率、网络丢包率等

  - 丢包率是网络运维人员非常关系的一个网络性能指标，但对于普通用户来说往往并不关心这个指标，因为它们通常意识不到网络丢包

  - 分包丢失主要有两种情况：

    - 分组在传输过程中出现**误码**，被结点丢弃
    - 分组到达一台队列已满的分组交换机时被丢弃；在通信量较大时就可能造成**网络拥塞**

  - 因此，丢包率反映了网络的拥塞情况：

    - 无拥塞时路径丢包率为0
    - 轻度拥塞时路径丢包率为1%~4%
    - 严重拥塞时路径丢包率为5%~15%

    





### 1.6 计算机网络体系结构

#### 1.6.1 常见的计算机网络体系结构

-  **OSI体系结构**
  - **从下往上依次是：物理层、数据链路层、网络层、运输层（自下而上第一个提供<u>端到端</u>服务的层次）、会话层、表示层、应用层**
  - 是法律上的国际标准
- **TCP/IP体系结构**
  - **从下往上依次是：网络接口层、网际层、运输层、应用层**
  - 是事实上的国际标准
  - 路由器一般只包含网际层和网络接口层
  - TCP/IP体系结构的网络接口层并没有规定什么具体的内容，目的是可以互连全世界各种不同的网络接口
  - **IP协议**是TCP/IP体系结构**网际层的核心协议**
  - **TCP和UDP**是TCP/IP体系**结构运输层的两个重要协议**
    - TCP协议在享受IP协议提供的网络互连服务的基础上，可**向应用层**的相应协议**提供可靠传输的服务**
    - UDP协议在享受IP**协议提供的网络互连服务的基础上**，可**向应用层**的相应协议**提供不可靠传输的服务**
  - IP协议一方面负责互连不同的网络接口（IP over everything）；另一方面为各种网络应用提供服务（Everything over IP）
- **原理体系结构**
  - **从下往上依次是：物理层、数据链路层、网络层、运输层、应用层**





#### 1.6.2 计算机网络体系结构分层的必要性

- 计算机网络是个非常复杂的系统。早在最初的ARPANET设计时就提出了分层的设计理念
- "分层"可将庞大而复杂的问题，转化为若干较小的局部问题，而这些较小的局部问题就比较易于研究和处理
- 下面将按照由简单到复杂的顺序，来看看计算机网络要面临哪些主要的问题，以及如何将这些问题划分到对应的层次，层层处理
- 比如：
  - 最简单的两台计算机通过一条网线连接起来，需要考虑：
    - 采用怎样的传输媒体（介质）
    - 采用怎样的物理接口
    - 使用怎样的信号表示比特0和1
    - 上面三个问题可以划归到物理层
  - 主机A,B,C,D,E通过总线互连，构成了一共总线型网络。假设已经解决了上面所说的物理层的问题，那么还需要考虑：
    - 如何标识网络中的各主机（主机编址问题，例如MAC地址）
    - 目的主机如何从信号所表示的一连串比特流中区分出地址和数据
    - 如何协调各主机争用总线
    - 上面的问题可以划归到数据链路层
  - 由三个路由器、四个网络互连起来的小型互连网
    - 如何表示各网络以及网络中的各主机（网络和主机共同编址的问题，例如IP地址）
    - 路由器如何转发分组，如何进行路由选择
    - 上面的问题可以划归到网络层
  - 如果主机运行着两个进程（浏览器进程和QQ进程），服务器运行着一个进程
    - 此时如果主机收到服务器发送的一个分组，那么这个分组该给哪个进程使用呢。这是如何解决进程之间基于网络的通信问题
    - 出现传输错误时，如何处理
    - 以上问题可以划归到运输层
  - 通过应用进程间的交互来完成特定的网络应用
    - 如支持万维网应用的HTTP协议
    - 支持电子邮件的SMTP协议
    - 支持文件传送的FTP协议
    - 上面的问题划归到应用层
- **总结：**
  - **物理层解决使用何种信号来传输比特的问题**
  - **数据链路层解决分组在一个网络（或一段链路）上传输的问题**
  - **网络层解决文组在多个网络上传输（路由）的问题**
  - **运输层解决进程之间基于网络的通信问题**
  - **应用层解决通过应用进程的交互来实现特定网络应用的问题**





#### 1.6.3 计算机网络体系结构分层思想举例

-  实例：主机属于网络N1，Web服务器属于网络N2

  - 如：`主机——N1——路由器——N2——Web服务器`
  - 使用主机中的浏览器访问服务器
  - 主机与服务器之间基于网络的通信，实际上是主机中的浏览器应用进程与Web服务器中的Web服务器应用进程之间基于网络的通信

- 体系中各层起到的作用（自上而下）：

  - 主机（用户端）

    - **应用层**按HTTP协议的规定，**构建一个HTTP请求报文**。应用层将该HTTP报文交给运输层处理
    - **运输层给HTTP请求报文添加一个TCP首部**，使之**成为TCP报文段**；该**首部的作用主要是为了区分应用进程以及实现可靠传输**。运输层将TCP报文段交给网络层处理
    - **网络层给TCP报文段添加一个IP首部**，使之**成为IP数据报**；该**首部的作用主要是为了使IP数据报可以在互连网上传输，也就是被路由器转发**。网络层将IP数据报交付给数据链路层处理
    - **数据链路层给IP数据报添加一个首部（ETH）和一个尾部（ETH）使之成为帧**；该**首部的作用主要是为了让帧能够在一段链路上或一个网络上传输，能够被相应的目的主机接收；尾部的作用是为了让目的主机检查所接收到的帧是否有误码。**数据链路层将帧交付给物理层
    - **物理层将帧看作是比特流**。由于网络N1是以太网，因此**物理层还会给该比特流前面添加前导码**。**其作用是为了让目的主机做好接收帧的准备**。**物理层将添加有前导码的比特流，变换成相应的信号发送到传输媒体**。
    - 信号通过传输媒体到达路由器

  - 路由器

    - **物理层将信号变换为比特流**，然后去掉前导码后，将其交付给数据链路层（实际上交付的是帧）。
    - **数据链路层将帧的首部和尾部去掉**后，将其交付给网络层（实际上交付的是IP数据报）
    - **网络层解析IP数据报的首部，从中提取出目的网络地址，然后查找自身的路由表，确定转发端口，以便进行转发**，网络层将IP数据报交付给数据链路层
    - **数据链路层给IP数据报添加一个首部（ETH）和一个尾部（ETH）使之成为帧**。数据链路层将帧交付给物理层
    - **物理层将帧看作是比特流**。由于网络N2是以太网，因此**物理层还会给该比特流前面添加前导码**。**其作用是为了让目的主机做好接收帧的准备**。**物理层将添加有前导码的比特流，变换成相应的信号发送到传输媒体**。
    - 信号通过传输媒体到达Web服务器

  - Web服务器

    - **物理层将信号变换为比特流**，然后去掉前导码后，将其交付给数据链路层（实际上交付的是帧）。
    - **数据链路层将帧的首部和尾部去掉**后，将其交付给网络层（实际上交付的是IP数据报）
    - **网络层将IP数据报的首部去掉**后，将其交付给运输层（实际上交付的是TCP报文段）
    - **运输层将TCP报文段的首部去掉**后，将其交付给应用层（实际上交付的是HTTP请求报文）
    - **应用层对HTTP请求报文进行解析，然后给主机发回HTTP响应报文**
    - 与上面类似，HTTP响应报文需要经过层层包装变为相应的信号，再通过传输媒体传输到路由器，路由器转发该响应报文给主机，主机通过物理层将收到的信号转换为比特流，之后通过逐层解封，最终取出HTTP响应报文

    





#### 1.6.4 计算机网络体系结构中的专用术语

- **实体**

  - **实体是指任何可发送或接收信息的<u>硬件或软件进程</u>**

  - **对等实体**：指收发双方**相同层次中的实体**

- **协议**

  - **协议是指控制两个对等实体进行逻辑通信的规则的集合**
  - 如：
    - 应用层使用HTTP,SMTP等进行通信
    - 运输层使用TCP,UDP等进行通信
    - 网络层使用IP进行通信
    - 链路层使用传统以太网CSMA/CD进行通信
    - 物理层协议（如传统以太网使用曼彻斯特编码）进行通信
  - 协议的三要素
    - 语法：定义通信双方所交换信息的格式
    - 语义：定义通信双方所要完成的操作
    - 同步：定义收发双方的时序关系

- **服务**

  - 在协议的控制下，两个对等实体间的逻辑通信使得本层能够向上一层提供服务（如物理层协议为数据链路层提供服务）

  - 要实现本层协议，还需要使用下面一层所提供的服务（如链路层享受物理层提供的服务，实现链路层协议并进行逻辑通信，给网络层提供服务；最后到应用层，应用层是给用户提供服务）

  - 协议是**"水平的"**，而服务是**"垂直的"**

  - 实体看得见相邻下层所提供的服务，但并不知道实现该服务的具体协议。也就是说，下面的协议对上面的实体是**"透明"**的

  - **服务访问点**：指在统一系统中，**相邻两层的实体交换信息的逻辑接口**，用于区分不同的服务类型

    - 如数据链路层的服务访问点为帧的"类型"字段
    - 网络层的服务访问点为IP数据报首部中的"协议字段"
    - 运输层的服务访问点为"端口号"

  - **服务原语**：**上层使用下层所提供的服务**，必须通过与下层**交换一些命令**，这些命令称为服务原语

  - **协议数据单元PDU**：**对等层次之间传送的数据包**称为该层的协议数据单元

    - 如物理层的数据包为：比特流（bit stream）
    - 数据链路层的数据包为：帧（frame）
    - 网络层的数据包为：IP数据或分组（packet）
    - 运输层的数据包为：TCP报文段（segment）或UDP用户数据报（datagram）
    - 应用层的数据包为：报文（message）

  - **服务数据单元SDU**：**同一系统内，层与层之间交换的数据包**称为服务数据单元

  - **多个SDU可以合成为一个PDU；一个SDU也可划分为几个PDU**

    







## 二.物理层

### 2.1 物理层的基本概念

- 传输媒体
  - 导引型传输媒体
    - 双绞线
    - 同轴电缆
    - 光纤
  - 非导引型传输媒体
    - 微波通信（2~40GHz）
- 物理层协议的主要任务
  - **机械特性**：指明接口所用接线器的**形状和尺寸**、**引脚数目和排列**、**固定和锁定装置**
  - **电气特性**：指明在接口电缆的各条线上出现的**电压的范围**
  - **功能特性**：指明某条线上出现的某一电平的**电压表示何种意义**
  - **过程特性**：指明对于不同功能的各种可能**事件的出现顺序**
- 物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流
- 物理层为数据链路层屏蔽了各种传输媒体的差异，使数据链路层只需要考虑如何完成本层的协议和服务，而不必考虑网络具体的传输媒体是什么





### 2.2 物理层下面的传输媒体

#### 2.2.1 导引型传输媒体

- 电磁波被导引沿着固体媒体传播

- 常见的导引型传输媒体：

  - 同轴电缆
  - 双绞线
  - 光纤
  - 电力线

  

- **同轴电缆**

  - 从内到外有：内导体、绝缘层、屏蔽层、绝缘保护套层（因为都是同轴的所以称为同轴电缆）
  - 有两种，分别为：
    - 基带同轴电缆（50Ω）：数据传输，过去用于局域网
    - 宽带同轴电缆（75Ω）：模拟传输，目前主要用于有线电视
  - 同轴电缆价格较贵且布线不够灵活和方便，随着集线器的出现，在局域网领域基本上都是采用双绞线作为传输媒体

  

- **双绞线**

  - 有两种，分别为：

    - 无屏蔽双绞线UTP电缆
    - 屏蔽双绞线STP电缆（比无屏蔽双绞线UTP电缆**增加了金属丝编织的屏蔽层，提高了抗电磁干扰的能力**）

  - **绞合规则**

    - 蓝和蓝白
    - 橙和橙白
    - 绿和绿白
    - 棕和棕白

  - <u>**绞合的作用**</u>

    - 抵御部分来自外界的电磁波干扰
    - 减少相邻导线的电磁干扰

  - | 绞合线类别   | 带宽   | 线缆特点                  | 典型应用                               |
    | ------------ | ------ | ------------------------- | -------------------------------------- |
    | 3            | 16MHz  | 2对4芯双绞线              | 模拟电话；曾用于传统以太网（10Mbit/s） |
    | 4            | 20MHz  | 4对8芯双绞线              | 曾用于令牌局域网                       |
    | 5            | 100MHz | 与4类相比增加了绞合度     | 传输速率不超过100Mbit/s的应用          |
    | 5E（超五类） | 125MHz | 与5类相比衰减更小         | 传输速率不超过1Gbit/s的应用            |
    | 6            | 250MHz | 与5类相比改善了串扰等性能 | 传输速率高于1Gbit/s的应用              |
    | 7            | 600MHz | 使用屏蔽双绞线            | 传输速率高于10Gbit/s的应用             |

  

- 光纤

  - 一根光缆少则一根光纤，多则数十甚至数百条光纤
  - 纤芯直径
    - 多模光纤：50微米，62.5微米
    - 单模光纤：9微米
  - 包层直径125微米
  - 工作波长：
    - 0.85微米（衰减较大）
    - 1.30微米（衰减较小）
    - 1.55微米（衰减较小）
  - 光纤的优点：
    - 通信容量大（25000~30000GHz的带宽）
    - 传输损耗小，远距离传输时更加经济
    - 抗雷电和电磁干扰性好。这在大电流脉冲干扰的环境下尤为重要
    - 无串音干扰，保密性好，不易被窃听
    - 体积小，重量轻
  - 光纤的缺点：
    - 割接需要专用设备
    - 光电接口价格较贵
  - 光在光纤中传输的基本原理
    - 光纤包含：纤芯（非常透明的石英玻璃拉成细丝，直径8~100微米），包层（折射率比纤芯低的玻璃封套，直径125微米）
    - 在发送端，可以采用发光二极管或半导体激光器作为光源
    - 在接收端，可以采用光电二极管或激光检波器检测光脉冲
    - 当光从**高折射率**的媒体射**向低折射率**的媒体时，其**折射角将大于入射角**；因此，如果**入射角足够大**，就会**出现全反射**，即光碰到包层时，就会反射回纤芯
    - **光在纤芯中传输的方式是不断地全反射**
    - **如果可以存在多条不同角度入射的光线在一条光纤中传输，这种光纤称为多模光纤**
      - 由于色散（模式、材料、波导色散），光在多模光纤中传输一定距离后必然产生信号失真（**脉冲展宽**）
      - 因此，多模光纤只适合**近距离传输**（建筑物内）。
      - 发送光源：发光二极管；接收检测：光电二极管
    - **如果光纤的直径减小到只有一个光的波长，则光纤就像一个波导那样，可以使光线一直向前传播，而不会产生多次反射，这种光纤叫做单模光纤**
      - **没有模式色散**，在1.31微米波长附近材料色散和波导色散大小相等符号相反，两者正好抵消
      - 单模光纤适合**长距离传输**且衰减小，但其制造成本高，对光源要求高
      - 发送光源：激光发生器；接收检测：激光检波器





#### 2.2.2 非导引型传输媒体

- 常见的非导引型传输媒体：

  - 无线电波
  - 微波
  - 红外线
  - 可见光

- 国际电信联盟ITU对电磁波频段的划分

  | ITU波段号 | 频段名称 | 缩写 | 频率范围       | 波段名称 | 波长范围           | 用途                                     | 电磁波谱对应名称 |
  | --------- | -------- | ---- | -------------- | -------- | ------------------ | ---------------------------------------- | ---------------- |
  | 1         | 极低频   | ELF  | 3Hz ~ 30Hz     | 极长波   | 100000km ~ 10000km | 潜艇通讯或直接转换成声音                 |                  |
  | 2         | 超低频   | SLF  | 30Hz ~ 300Hz   | 超长波   | 10000km ~ 1000km   | 直接转换成声音或交流输电系统（50~60Hz）  |                  |
  | 3         | 特地频   | ULF  | 300Hz ~ 3kHz   | 特长波   | 1000km ~ 100km     | 矿场通讯或直接转换成声音                 |                  |
  | 4         | 甚低频   | VLF  | 3kHz ~ 30kHz   | 甚长波   | 100km ~ 10km       | 直接转换成声音、超声，地球物理学研究     |                  |
  | 5         | 低频     | LF   | 30kHz ~ 300kHz | 长波     | 10km ~ 1km         | 国际广播，全向信标                       | 无线电波         |
  | 6         | 中频     | MF   | 300kHz ~ 3MHz  | 中波     | 1km ~ 100m         | 调幅(AM)广播，全向信标，海事及航空通讯   | 无线电波         |
  | 7         | 高频     | HF   | 3MHz ~ 30MHz   | 短波     | 100m ~ 10m         | 短波、民用电台                           | 无线电波         |
  | 8         | 甚高频   | VHF  | 30MHz ~ 300MHz | 米波     | 10m ~ 1m           | 调频（FM）广播，电视广播，航空通讯       | 无线电波         |
  | 9         | 特高频   | UHF  | 300MHz ~ 3GHz  | 分米波   | 1m ~ 100mm         | 电视广播，无线电话通讯，无线网络，微波炉 | 微波             |
  | 10        | 超高频   | SHF  | 3GHz ~ 30GHz   | 厘米波   | 100mm ~ 10mm       | 无线网络，雷达，人造卫星接收             | 微波             |
  | 11        | 极高频   | EHF  | 30GHz ~ 300GHz | 毫米波   | 10mm ~ 1mm         | 射电天文学，遥感，人体扫描安检仪         | 微波             |

- 无线电波

  - 低频和中频主要利用地面波进行传输
  - 高频和甚高频，主要考电离层的反射

- **微波**

  - 主要使用2~40GHz的频率范围
  - 在空间主要是直线传播
  - 由于微波会穿透电离层而进入宇宙空间，因此他不能经过电离层的反射传播到地面上很远的地方
  - 传统的微波通信主要有两种方式：
    - **地面微波接力通信**
    - **卫星通信**。特点是通信距离远，但传播时延也比较大

- 红外线

  - 如家用电器的红外遥控器
  - 点对点传输
  - 直线传输，中间不能有障碍物，传输距离短
  - 传输速率低（4Mb/s~16Mb/s）





### 2.3 传输方式

#### 2.3.1 串行传输和并行传输

- 串行传输：指数据是一个比特一个比特一次发送的。在发送端和接收端之间只需要一条线路。
- 并行传输：指一次发送n个比特而不是一个比特。在发送端和接收端之间需要有n条线路
- 并行传输的优点是速度为串行传输的n倍，缺点是成本高



#### 2.3.2 同步传输和异步传输

- **同步传输：数据以稳定的比特流的形式传说，字节之间没有间隔**
  - 接收端在每个比特信号的中间时刻进行检测，以判别接收到的是比特0还是比特1
  - 在传输大量数据的过程中，所产生的判别时刻的累积误差，会导致接收端对比较信号的判别错位。因此需要采取方法使收发双方的时钟保持同步
  - 实现手法双方时钟同步的方法主要有两种：
    - 外同步：在收发双方之间添加一条单独的时钟信号线
    - 内同步：发送端将始终同步信号编码到发送数据中一起传输（例如曼彻斯特编码）
- **异步传输：以字节为独立的传输单位，字节之间的时间间隔不是固定的，接收端仅在每个字节的起始处对字节内的比特实现同步。**为此，**通常要在每个字节前后加上起始位和结束位**
  - 异步是指：字节之间异步（字节之间的时间间隔不固定）
  - 字节中的每个比特仍然要同步（各比特的持续时间是相同的)





#### 2.3.3 单向通信（单工）和双向交替通信（半双工）和双向同时通信（全双工）

-  **单工通信**

  - 又称单向通信，**通信双方只有一个数据传输方向**。
  - 只需要一条信道

- **半双工**

  - 又称双向交替通信，**通信双方可以相互传输数据，但不能同时进行**
  - 需要两条信道

- **全双工**

  - 又称双向同时通信，**通信双方可以同时发送和接受信息**
  - 需要两条信道

  



### 2.4 编码与调制

#### 2.4.1 基本介绍

- **需要发送的文字、图片、音频、视频可以统称为消息**，计算机将消息的比特0和比特1变换成相应的电信号发送到网线。**由信源发送的原始电信号称为基带信号**
- 基带信号可分为两类
  - 数字基带信号（如计算机内部CPU与内存之间传输的信号）
  - 模拟基带信号（如麦克风收到声音后产生的音频信号）
- 信号需要在信道中进行传输。**信道可分为数字信道和模拟信道**
- **<u>在不改变信号性质的前提下，仅对数字基带信号的波形进行变换，称为编码</u>。编码后产生的信号仍为数字信号，可以在数字信道中传输**
- **<u>把数字基带信号的频率范围搬移到较高的频段，并转换为模拟信号，称为调制</u>。调制后产生的信号是模拟信号，可以在模拟信道中传输**
- **码元：在使用时间域的波形表示数字信号时，<u>代表不同离散数值的基本波形</u>**（简单来说，码元就是构成信号的一个波形）



#### 2.4.2 常用编码

- 如何判断一段信号中码元的个数（**不归零编码**:即不存在零电平的编码）

  - 需要**额外一根传输线来传输时钟信号**，使发送方和接收方同步
  - 对于计算机网络，**宁愿使用这根传输线传输数据信号**，而不是传输时钟信号

- **归零编码**

  - **每个码元传输结束后信号都要"归零"**，所以接收方只要在信号归零后进行采样即可，不需要单独的时钟信号
  - 实际上，归零编码相当于把时钟信号用"归零"方式编码在了数据之内，这成为"**自同步**"信号
  - 但是，归零编码中大部分的**数据带宽**，都用来传输"归零"而**浪费**掉了

- **曼彻斯特编码**

  - 码元中间时刻的跳变既表示时钟，又表示数据

- **差分曼彻斯特编码**

  - 在每个码元时间的中间时刻，信号都会发生跳变
  - 但是跳变仅表示时钟
  - 用码元开始处电平是否发生变化表示数据

  

#### 2.4.3 调制方法

- 基本调制方法

  - **调幅（AM）**
    - 用无载波输出表示比特0，有载波输出表示比特1
  - **调频(FM)**
    - 用不同频率的信号表示，比如频率f1表示比特0，频率f2表示比特1
  - **调相（PM）**
    - 用初相位0度的波形表示比特0，用初相位180度的波形表示比特1
  - 但是使用基本调制方法，1个码元只能包含1个比特信息。如何能使1个码元包含更多的比特呢？

- 混合调制

  - 因为**频率和相位是相关**的，即频率是相位随时间的变化率。所以**一次只能调制频率和相位两个中的一个**

  - 通常情况下，相位和振幅可以结合起来一起调制，称为**正交振幅调制QAM**

  - 举例：QAM-16

    - 12种相位

    - 每种相位有1或2种振幅可选

    - 可以调制出16种码元（波形），每种码元可以对应4个比特

    - 码元与4个比特的对应关系采用格雷码（格雷码指的是任意两个相邻码元只有1个比特不同）

      



### 2.5 信道的极限容量

- **当输入信号通过通信质量较差的信道时，此时失真严重，在输出端无法识别信号的0和1，信号波形失去了码元之间的清晰界限，这种现象叫做码间串扰**

- **产生失真的因素**

  - 码元传输速率
  - 信号传输距离
  - 噪声干扰
  - 传输媒体质量

- **奈氏准则**

  - 在假定的理想条件下，**为了避免码间串扰，码元传输速率是有上限的**
  - 理想低通信道的最高码元传输速率 = 2W Baud
  - 理想带通信道的最高码元传输速率 = W Baud
    - W： 信道带宽（单位为Hz）
    - Baud： 波特，即码元/秒
  - **码元传输速率又称为波特率、调制速率、波形速率或符号速率。**它与比特率有一定关系：
    - 当1个码元只携带1比特的信息量时，则波特率（码元/秒）与比特率（比特/秒）在数值上是相等的
    - 当1个码元携带n比特的信息量时，则波特率转换成比特率时，数值要乘以n
  - **要提高信息传输速率（比特率），就必须设法使每一个码元能携带更多个比特的信息类。这需要采用多元制**
  - 实际的信道所能传输的最高码元速率，要明显低于奈氏准则给出的这个上限数值
  - 那么这么看，只要采用更好的调制方法，让码元可以携带更多的比特，岂不是可以无限制地提高信息的传输速率？
    - 答案是否定的。因为**信道的极限信息传输速率还要受限于**实际的信号在信道种传输时的**信噪比**

- 香农公式

  - **带宽受限且有高斯白噪声干扰的信道的极限信息传输速率**。公式：`c = W * log2(1 + S/N)`
    - c：信道的极限信息传输速率（单位：b/s）
    - W：信道带宽（单位：Hz）
    - S：信道内所传信号的平均功率
    - N：信道内的高斯噪声功率
    - S/N：信噪比，使用分贝（dB）作为度量单位
      - 信噪比（dB） = 10 * log10(S/N) (dB)
  - 信道带宽或信道中信噪比越大，信息的极限传输速率就越高
  - 在实际信道上能够达到的信息传输速率要比该公式的极限传输速率低比绍。这是因为在实际信道中，信号还要受到其他一些损伤，如各种脉冲干扰、信号在传输中的衰减和失真等，这些因素在香农公式中并未考虑

- 在信道带宽一定的情况下，根据奈氏准则和香农公式，想要**提高信息的传输速率**就必须采用**多元制**（更好的调制方法）和努力**提高信道中的信噪比**

- 自从香农公式发表后，各种**新的信号处理和调制方法就不断出现**，其目的都是为了尽可能地**接近香农公式给出的传输速率极限**

  







## 三.数据链路层

### 3.1 数据链路层概述

- **链路**（Link）就是从一个结点到相邻结点的一段物理线路，而中间没有任何其他的交换结点
- **数据链路**（Data Link）是指把实现通信协议的硬件和软件加到链路上，就构成了数据链路
- 数据链路层以**帧**为单位传输和处理数据
- **数据链路层的三个重要问题**
  - 封装成帧
    - 在包装数据的时候，网络层会给数据链路层一个网络层协议数据单元。此时，数据链路层会对其添加一个数据链路层协议首部，称为帧头；还要添加一个帧尾。**这个添加帧头和帧尾的操作，称为封装成帧**
    - 添加帧头和帧尾的目的，都是为了在链路上以帧为单元来传送数据，也就是为了实现数据链路层本身的功能
  - 差错检测
    - 发送方将封装好的帧通过物理层发送到传输媒体。帧在传输过程中遭遇干扰后可能会出现误码。那么接收方主机如何判断帧在传输过程中是否出现了误码？可以通过检错码来发现
    - **发送方在发送帧之前，基于待发送的数据和检错算法计算出检错码，并将其封装在帧尾。接收方主机收到帧后，通过检错码和检错算法，就可以判断出帧在传输过程中是否出现了误码**
  - 可靠传输
    - 接收方主机收到有误码的帧后，不会接收该帧，会将其丢弃。
    - 如果数据链路层向其上提供的是不可靠服务，那么丢弃了也没事
    - 如果数据链路层向其上提供的是可靠服务，那么就还需要其他设施可以接收到被丢弃的这个帧的正确版本
    - **倘若发送方发送什么，接收端最终收到什么，就称为可靠传输**
- **对于使用广播信道的数据链路层**，除了上面三个问题外，还有其他问题要解决：
  - **当多台主机连接在同一根总线上**时，接收主机如何直到该帧是发送给它的？
    - 在帧头加上目的地址和源地址
  - 当总线上多台主机同时使用总线来传输帧时，**传输信号就会产生碰撞**
    - 以太网的解决方法：**使用一种特殊的协议CSMA/CD**，也就是**载波监听多点接入/碰撞检测**
    - 802.11局域网的媒体介入**控制协议CSMA/CA**，也就是**载波监听多点接入/碰撞避免**
- 对于使用点对点链路和链路层交换机的交换式局域网，在有线（局域网）领域已完全取代了共享式局域网。那么**网络中的交换机又是如何转发帧的呢？**
  - 涉及到网桥和交换机的工作原理
  - 集线器（物理层互连设备）与交换机的区别





### 3.2 封装成帧

- **封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧**
  - 帧头和帧尾中包含有重要的控制信息
  - 帧头和帧尾的作用之一就是**帧定界**
    - 数据接收方可以根据帧头和帧尾的帧定界标志，从一串比特流中提取出一个个的帧（PPP帧格式）
    - 如果是MAC帧格式，则是在数据链路层将帧交付给物理层之后，物理层在MAC帧中添加前导码，然后再将比特流转换成电信号发送
- 透明传输是指**数据链路层对上层交付的传输数据没有任何限制**，就好像数据链路层不存在一样
  - 面向字节的物理链路 使用字节填充（或称字符填充）的方法实现透明传输
  - 面向比特的物理链路 使用比特填充的方法实现透明传输
- 为了提高帧的传输效率，应当使**帧的数据部分的长度尽可能大些**
- 考虑到差错控制等多种因素，每一种数据链路层协议都规定了帧的数据部分的长度上限，即**最大传送单元MTU**（Maximum Transfer Unit)





### 3.3 差错检测

- 实际的通信链路都不是理想的，比特在传输过程中可能会产生差错：1可能会变成0，而0也可能会变成1。这称为**比特差错（或误码）**

- 在一段时间内，传输错误的比特占所传输的比特总数的比率称为**误码率BER（Bit Error Rate）**

- 使用**差错检测码**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一

- **奇偶校验**

  - 在待发送的数据后面**添加1位奇偶校验位**，使整个数据（包括所添加的校验位在内）中**"1"的个数**为奇数（奇校验）或偶数（偶校验）
  - 如果有**奇数个位发生误码**，则奇偶性发生变化，**可以检查出误码**
  - 如果有**偶数个位发生误码**，则奇偶性不发生变化，**不能检查出误码（漏检）**

- **循环冗余校验CRC（Cyclic Redundancy Check）**

  - 收发双方约定好一个**生成多项式G(x)**
    - **生成多项式必须包含最低次项（常数项）**
  - 发送方基于待发送的数据和生成多项式计算出差错检测码（**冗余码**），将其添加到待传输数据的后面一起传输
    - 冗余码计算：**`待发送的数据 后面添加 生成多项式最高次个0 / 生成多项式各项系数构成的比特串`的<u>余数</u>就是计算出的冗余码**
    - 冗余码的长度与 生成多项式的最高次数相同
    - **注意：/表示异或运算**
  - 接收方通过生成多项式来计算收到的数据是否产生了误码
    - 接收方的处理：**`已接收的数据 后面添加 余数（冗余码） / 生成多项式各项系数构成的比特串`**，**得到余数**
    - **如果余数为0，可判定传输过程没有产生误码；如果余数不为0，可判定传输过程产生了误码**

- **检错码**只能检测出帧在传输过程中出现了差错，但并不能定位错误，因此**无法纠正错误**

- 要想纠正传输中的差错，可以使用冗余信息更多的**纠错码**进行**前向纠错**。但纠错码的开销比较大，在**计算机网络中较少使用**

- 循环冗余校验**CRC**有很好的检错能力（**漏检率非常低**），虽然计算较为复杂，但非常**易于用硬件实现**，因此被**广泛应用于数据链路层**

- 在计算机网络中通常采用后续课程中要讨论的**检错重传方式来纠正传输中的差错**，或者**仅仅是丢弃检测到差错的帧**，这取决于数据链路层向其上层提供的是可靠传输服务还是不可靠传输服务

  



### 3.4 可靠传输

#### 3.4.1可靠传输的基本概念

- 使用**差错检测技术**（例如循环冗余校验CRC），接收方的数据链路层就可检测出帧在传输过程中是否产生了**误码**（比特错误）

- 数据链路层向上层提供的服务类型

  - **不可靠传输服务**：**仅仅丢弃有误码的帧**，其他上面都不做
  - **可靠传输服务**：想办法实现**发送端发送什么，接收端就收到什么**

- 一般情况下，**有线链路**的误码率比较低，为了减小开销，并**不要求数据链路层**向上提供**可靠**传输服务。即使出现了误码，可靠传输的问题由其上层处理

- **无线链路**易受干扰，误码率比较高，因此**要求数据链路层**必须向上层提供**可靠**传输服务

- 传输差错

  - **比特差错**只是传输差错中的一种
  - 从整个计算机网络体系结构来看，传输差错还包括**分组丢失、分组失序和分组重复**
  - 分组丢失、分组失序以及分组重复这些传输差错，一般不会出现在数据链路层，而会出现在其上层

- **可靠传输服务并不局限于数据链路层**，其他各层均可选择实现可靠传输

- 可靠传输的实现比较复杂，开销也比较大，是否使用可靠传输取决于应用需求

  





#### 3.4.2 可靠传输的实现机制 — 停止-等待协议SW(Stop-and-Wait)

- 像停止-等待协议这种通过确认和重传机制实现的可靠传输协议，通常称为自动请求重传协议ARQ，意思是重传的请求是自动进行的。（因为不需要接收方显示的请求发送方重传某个出错的分组）

- 发送方发送给接收方一个DATA分组，然后**停止，等待接收方返回分组**

  - 如果接收方收到了，且**没有误码**，那就返回一个**ACK分组**；如果**有误码**，就返回一个**NAK分组**
  - 等到发送方收到了ACK或者NAK，才会发送下一个DATA分组

- 如果接收方收不到数据分组，就不会发送ACK或NAK。如果不采取其他措施，发送方就会一直处于等待接收方ACK或NAK的状态

  - 为解决该问题，可以在发送方发送完一个数据分组时，启动一个**超时计时器**。若到了超时计时器所设置的**重传时间**而发送方仍收不到接收方的ACK或NAK，则重传原来的数据分组，这就叫做**超时重传**
  - 一般可将重传时间选为略大于"从发送方到接收方的平均往返时间"

- 为**避免分组重复**这种传输错误，必须给**每个分组带上序号**

  - 对于停止-等待协议，由于每发送一个数据分组就停止等待，只要保证每发送一个新的数据分组，其发送序号与上次发送的数据分组的序号不同就可以了，因此用**一个比特来编号就够了**

- 注意事项：

  - 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传。但对于误码率较高的点对点链路，为使发送方**尽早重传**，也可**给发送端发送NAK分组**
  - 为了让接收方能够判断所收到的的数据分组是否重复的，需要给**数据分组编号**。由于等待-停止协议的停等特性，**只需1个比特编号**就够了，即变化0和1
  - 为了让发送方能够判断所受到的ACK分组是否是重复的，需要给**ACK分组编号**，所用比特数量**与数据分组编号所用比特数量一样**。数据链路层一般不会出现ACK分组迟到的情况，因此在**数据链路层实现停止-等待协议可以不用给ACK分组编号**
  - 超时计时器设置的**重传时间**应仔细选择。一般可将重传时间选为**略大于"从发送方到接收方的平均往返时间"**
    - 在数据链路层点对点的往返时间比较确定，重传时间比较好设定
    - 然而在运输层，由于端到端往返时间非常不确定，设置合适的重传时间有时并不容易

- 停止-等待协议的信道利用率

  - **设Td为发送方发送数据分组所耗费的发送时延，RTT为收发双方之间的往返时间，TA是接收方发送确认分组所耗费的发送时延**；则从发送一个数据分组到可以发送下一个数据分组所用的**总时间为：Td+RTT+TA**
  - 信道利用率为：`Td / Td+RTT+TA`（可以忽略TA，因为TA一般都远远小于Td）
    - **当往返时延RTT远大于数据帧发送时延Td时（例如使用卫星链路），信道利用率非常低**
    - 若出现重传，则对于传送有用的数据信息来说，信道利用率还要降低
    - 为了客服停止-等待协议信道利用率很低的缺点，就产生了另外两种协议，即后退N帧协议GBN和选择重传协议SR

  

  



#### 3.4.3 可靠传输的实现机制—回退N帧协议GBN（Go-Back-N）

- 示例：

  - 若采用3个比特给分组编序号，即序号0~7
  - 则发送窗口的尺寸WT的取值为：**1 < WT <= 2的三次方 -1**，本例取WT=5
    - 发送窗口内的分组可以发送
    - **若WT=1，则就是停止-等待协议**
    - **若WT超过取值范围的上限，会造成很严重的后果**
  - 接收窗口的尺寸WR的取值为：WR=1
    - 每成功接收一个分组，可以返回信息，然后WT下滑一格

- 累计确认

  - 接收方**不一定**要对收到的数据分组**逐个发送确认**，而是可以在收到几个数据分组后（由具体实现决定），**对按序到达的最后一个数据分组发送确认**。**ACKn表示序号为n及以前的所有数据分组都已正确接收**
  - 累计确认的优点：即使确认分组（接收方返回的分组）丢失，发送方也可能不必重传
  - 累计确认的缺点：不能向发送方及时反映出接收方已经正确接收的数据分组的信息

- 比如发送分组1，0，7，6，5， 若发送的分组5出现误码

  - 接收方会将分组5丢弃，并且返回给发送方ACK4
  - 因为分组5被丢弃，但此时接收窗口在5处，1、0、7、6都不符合，故都被丢弃了，并且返回4个ACK4
  - 发送方收到重复的确认，就知道之前所发送的数据分组出现了差错，于是可以不等超时器超时就立刻重传
  - 至于收到几个重复确认就立刻重传，由具体实现决定
  - **在本例中，尽管序号为6、7、0、1的数据分组正确到达接收方，但是由于5号分组误码不被接受，它们也"受到牵连"而不被接受，发送方还要重传这些数据分组，这就是所谓的Go-Back-N（回退N帧）**
  - 可见，当通信线路质量不好时，回退N帧协议的信道利用率并不比停止-等待协议高

- 若WT超过取值范围的上限，会出现什么情况？

  - 接收方无法分辨新、旧分组，进而会产生分组重复这种传输差错

- **回退N帧协议在流水线传输的基础上利用发送窗口来限制发送方连续发送数据分组的数量，是一种连续ARQ协议**

- **在协议的工作过程中发送窗口和接收窗口不断向前滑动，因此这类协议又称为滑动窗口协议**

- **小结**

  - 发送方
    - 发送窗口尺寸WT的取值范围是**1 < WT <= 2的n次方 -1**
      - 其中，n是构成分组序号的比特数量
      - 若WT=1，则就是停止-等待协议
      - 若WT > 2的n次方-1，则接收方无法分辨新、旧分组
    - 发送方可在未收到接收方确认分组的情况下，将序号落在发送窗口内的多个数据分组全部发送出去
    - 发送方**只有收到**对已发送数据分组的**确认时**，**发送窗口才能向前相应滑动**
    - 发送方**收到多个重复确认时**，**可**在重传计时器超时前**尽早开始重传**，由具体实现决定
    - **发送方发送窗口内某个已发送的数据分组产生超时重发时，其后续在发送窗口内且已发送的数据分组也必须全部重传，这就是回退N帧协议名称的由来**
    - d
  - 接收方
    - 接收方的接收窗口尺寸WR的取值范围是WR=1，因此**接收方只能按序接收数据分组**
    - 接收方只接受序号落在接收窗口内且无误码的数据分组，并且将接收窗口向前滑动一个位置，于此同时给发送方发回相应的确认分组。为了减小开销，**接收方不一定每收到一个按序到达且无误码的数据分组就给发送方发回一个确认分组**
      - **而是可以在连续收到好几个按序到达且无误码的数据分组后（由具体实现决定），才针对最后一个数据分组发送确认分组，这称为累积确认**
      - 或者可以在自己有数据要发送时才对之前按序且无误码的数据分组进行捎带确认
    - 接收方收到未按序到达的数据分组，除丢弃外，还要对最近按序接收的数据分组进行确认

  





#### 3.4.4 可靠传输的实现机制 — 选择重传协议SR（Selective Request）

- 在回退N帧协议中，接收窗口的尺寸WR只能等于1，这样一个数据分组的误码就会导致其后面多个数据分组被丢弃，这对通信资源很是浪费

  - 为了进一步提高性能，可设法只重传出现误码的数据分组。因此，**接收窗口的尺寸<u>WR不应再等于1（而应大于1）</u>，以便<u>接收方先收下失序到达但无误码并且序号落在接收窗口内的那些数据分组</u>，等到所缺分组收齐后再一并送交上层。这就是<u>选择重传协议</u>**
  - **注意：<u>选择重传协议</u>为了使发送方仅重传出现差错的分组，接收方<u>不能再采用累积确认</u>，而需要对每个正确接收到的数据分组进行<u>逐一确认</u>**

- **发送方的发送窗口尺寸必须满足：`1 < WT < 2的（n-1）次方`**

  - 其中n是构成分组序号的比特数量
  - 若WT=1，则与停止-等待协议相同
  - 若WT>2的（n-1）次方，则会造成接收方无法辨析新旧数据分组的问题

- **接收方的接收窗口尺寸必须满足：`1 < WR <= WT`**

  - 若WR=1，则与回退N帧协议相同
  - 若WR > WT，则没有意义

- **小结**

  - 发送方

    - **发送方的发送窗口尺寸必须满足：`1 < WT < 2的（n-1）次方`**
      - 其中n是构成分组序号的比特数量
      - 若WT=1，则与停止-等待协议相同
      - 若WT>2的（n-1）次方，则会造成接收方无法辨析新旧数据分组的问题
    - **发送方可在<u>未收到接收方确认分组</u>的情况下，将序号落在发送窗口内的多个数据分组全部发送出去**
    - 发送方**只有按序收到**对已发送数据分组的确认时，发送窗口**才能向前相应滑动**；**若收到未按序到达的确认分组时，对其进行记录，以防止其相应数据分组的超时重发，但发送窗口不能向前滑动**

  - 接收方

    - **接收方的接收窗口尺寸必须满足：`1 < WR <= WT`**

      - 若WR=1，则与回退N帧协议相同
      - 若WR > WT，则没有意义

    - **接收方可接收<u>未按序到达但没有误码并且序号落在接收窗口内</u>的数据分组**

      - 为了使发送方仅重传出现差错的分组，接收方**不能再采用累计确认**，而需要对每个正确接收到的数据分组进行**逐一确认**

    - **接收方只有在按序接收数据分组后，接收窗口才能向前相应滑动**

      





### 3.5 点对点协议PPP

- 点对点协议PPP（Point-to-Point Protocol）是目前使用最广泛的点对点数据链路层协议

- PPP协议在点对点链路传输各种协议数据报提供了一个标准方法，主要由以下三部分构成：

  - 对各种协议数据报的封装方法（封装成帧）
  - 链路控制协议LCP——用于建立、配置以及测试数据链路的连接
  - 一套网络控制协议NCPs——其中的每一个协议支持不同的网络层协议

- 帧格式

  - 帧的首部
    - 标志（Flag）字段：PPP帧的定界符，取值为0x7E
    - 地址（Address）字段：取值为0xFF，预留（目前没什么作用）
    - 控制（Control）字段：取值为0x03，预留（目前没什么作用）
    - 协议（Protocol）字段：指明帧的数据部分送交哪个协议处理
      - 取值0x0021表示：帧的数据部分为IP数据报
      - 取值0xC021表示：帧的数据部分为LCP分组
      - 取值0x8021表示：帧的数据部分为NCP分组
  - 帧的尾部
    - 帧检验序列（Frame Check Sequence）字段：CRC计算出的校验位

- 透明传输

  - 对于面向字节的异步链路

    - 采用字节填充法，插入"转义字符"
    - 发送方的处理：
      - 出现的每一个**7E**（PPP帧的定界符）字节转变成2字节序列（**7D，5E**）
      - 出现的每一个**7D**（转义字符）字节转变成2字节序列（**7D,5D**）
      - 出现的每一个ASCll码控制字符（**数值小于0x20的字符**），则在该字符前面插入一个**7D**字节，同时将该字符的编码**加上0x20**
    - 接收方的处理：进行**反变换**即可恢复出原来的帧的数据部分

  - 对于面向比特的同步链路

    - 采用比特填充发，插入"比特0"

    - 发送方的处理：

      - 对帧的数据部分进行扫描（一般由硬件实现）。只要发现**5个连续的比特1**，则立即**填充1个比特0**

    - 接收方的处理：

      - 对帧的数据部分进行扫描（一般由硬件实现）。只要发现**5个连续的比特1**，就**把其后的1个比特0删除**

      

- 差错检测

  - 采用的多项式：`CRC-CCITT = X的16次方 + X的12次方 + X的5次方 + 1`
  - 接收方每收到一个PPP帧，就进行CRC检验。若CRC检验正确，就收下这个帧；反之，就丢弃这个帧。使用PPP的数据链路层**向上不提供可靠传输服务**

- 工作状态

  - 开始是**静止状态**，当检测到载波并建立物理层连接，进入**建立状态**；
  - 此时链路控制协议LCP开始协商一些配置选项
    - 配置选项：
      - 最大帧长
      - 鉴别协议
        - 无需鉴别
        - 口令鉴别协议PAP
        - 挑战握手鉴别协议CHAP
    - 若协商成功，进入**鉴别状态**
    - 若协商失败，退回到**静止状态**
  - 进入**鉴别状态**后
    - 若无需鉴别或鉴别成功，则进入**网络状态**
    - 若鉴别失败，则进入**终止状态**
  - 进入**网络状态**后
    - 进行NCP配置，进入**打开状态**
      - NCP配置：PPP链路的两端互相交换网络层特定的NCP分组。如果在PPP链路上运行的是IP，则使用IP控制协议IPCP来对PPP链路的每一端配置IP模块（如分配IP地址）
  - 进入**打开状态**后
    - **就可以进行数据通信**
    - 如果出现故障或终止请求时，就进入**终止状态**
  - 进入**终止状态**后
    - 当载波停止时，就进入**静止状态**

  



### 3.6 媒体接入控制

#### 3.6.1 媒体接入控制的基本概念

- 共享信道要着重考虑的一个问题就是如何协调多个发送和接收站点对一个共享传输媒体的占用，即**媒体接入控制MAC**（Medium Access Control）

- 媒体接入控制可分为：

  - 静态划分信道
    - 预先固定分配好信道，这类方法非常不灵活，对于突发性数据传输信道利用率会很低
    - 通常在无线网络的物理层中使用，而不是在数据链路层中使用
    - 可分为：
      - 频分多址
      - 时分多址
      - 码分多址
  - 动态接入控制
    - 可分为：
      - 受控接入
        - 集中控制	（由一个主站以循环方式轮询每个站点有无数据发送，只有被轮询到的站点才能发送数据。最大缺点是存在单点故障问题）
        - 分散控制（各站点是平等的，并连接成一个环形网络。令牌（一个特殊的控制帧）沿环逐站传递，接收到令牌的站点才有权发送数据，并在发送完数据后将令牌传递给下一个站点）
      - 随机接入（所有站点通过竞争，随机地在信道上发送数据。如果恰巧有两个或更多的站点在同一时刻发送数据，则信号在共享媒体上就要产生碰撞（即发生了冲突）。使得这些站点的发送都失败。因此，这类协议要解决的关键问题是如何尽量避免冲突及在发生冲突后如何尽快恢复通信。著名的共享式以太网采用的就是随机接入）

- 随着技术的发展，交换技术的成熟和成本的降低，具有更高性能的使用点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了共享式局域网，但由于无线信道的广播天性，无线局域网仍然使用的是共享媒体技术

  



#### 3.6.2 媒体接入控制 — 静态划分信道

- 信道复用

  - 复用（Multiplexing）是通信技术中的一个重要概念。复用就是通过一条物理线路同时传输多路用户的信号

  - 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量时，可利用复用技术在一条物理线路上建立多条通信信道来充分利用传输媒体的带宽

  - 常见的信道复用有：

    - 频分复用FDM
    - 时分复用TDM
    - 波分复用WDM
    - 码分复用CDM

  - **频分复用FDM**

    - 将传输线路的频带资源划分成多个子频带，形成多个子信带，各子信道之间需要留出隔离频带，以免造成子信道间的干扰。当多路信号输入一个多路复用器时，这个复用器将每一路信号调制到不同频率的载波上。
    - 接收端由相应的分用器通过滤波将各路信号分开，将合成的复用信号恢复成原始的多路信号
    - **频分复用的所有用户同时占用不同的频带资源并行通信**

  - **时分复用TDM**

    - 将时间划分成一个个时隙。
    - **时分复用技术将传输线路的带宽资源按时隙轮流分配给不同的用户，每对用户只在所分配的时隙里使用线路传输数据**
    - **时分复用技术将时间划分成了一段段等长的时分复用帧，每一个时分复用的用户在每一个时分复用帧中占用固定序号的时隙** 
    - 每一个用户所占用的时隙是周期性出现的，其周期就是时分复用帧的长度
    - **时分复用的所有用户在不同的时间占用同样的频带宽度**

  - **波分复用WDM**

    - 波分复用其实就是光的频分复用

  - **码分复用CDM**

    - 码分复用CDM是另一种共享信道的方法。实际上，由于该技术主要用于多址接入，人们更常用的名词是码分多址CDMA（Code Division Multiple Access）

    - 同理，频分复用FDM和时分复用TDM同样可用于多址接入，相应的名词是频分多址FDMA和时分多址TDMA

    - 复用与多址

      - 复用是将单一媒体的频带资源划分成很多子信道，这些子信道之间相互独立，互不干扰。从媒体的整体频带资源上看，每个子信道只占用该媒体频带资源的一部分
      - 多址（更确切地应该称为多点接入）处理的是动态分配信道给用户。这在用户仅仅暂时性地占用信道的应用中是必须的，而所有的移动通信系统基本上都属于这种情况。相反，在信道永久性地分配给用户的应用中，多址是不需要的（对于无线广播或电视广播站就是这样）
      - 某种程度上，FDMA、TDMA、CDMA可以分别看成是FDM、TDM、CDM的应用

    - 与FDM和TDM不同，CDM的每一个用户可以**在同样的时间使用同样的频带进行通信**

    - 由于**各用户使用经过特殊挑选的不同码型**，因此各用户之间**不会造成干扰**

    - CDM最初是用于军事通信的，因为这种系统所发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现

    - **码分复用使用（直接序列扩频DSSS）**

      - 在CDMA中，每一个比特时间再划分为m个短的间隔，称为**码片**。通常m的值是64或128。为了简单起见，在后续的举例中，我们假设m为8
      - 使用CDMA的每一个站被指派一个唯一的**m bit码片序列**。
        - 一个站如果要发送**比特1**，则**发送它自己的m bit码片序列**
        - 一个站如果要发送**比特0**，则**发送它自己的m bit码片序列的二进制反码**
      - 码片序列的挑选原则如下：
        - 分配给每个站的**码片序列必须各不相同**，实际常采用伪随机码序列
        - 分配给每个站的**码片序列必须相互正交**（规格化内积为0）
          - 令向量S表示站S的码片序列，令向量T表示其他任何站的码片序列。**两个不同站S和T的码片序列正交，就是相邻S和T的规格化内积为0。即`S * T = 0`**

    - 码分多址使用

      - 假设接收方D接收到了`A + B的共轭`，发送方A发送`A（比特1）`，发送方B发送`B（比特0）`，发送方C未发送
      - 假设所有站所发送的码片序列都是同步的，接收方D直到其他各站所特有的码片序列。接收站D对所接收到的叠加信号进行判断：**`用D所接收到的码片序列 与发送方发送的码片序列 进行规格化内积（点乘）`**
        - **结果为1，对方发送比特1**
        - **结果为-1，对方发送比特0**
        - **结果为0，对方未发送**

      



#### 3.6.3  媒体接入控制 — 动态接入控制 — 随机接入（CSMA/CD协议）

- **总线局域网使用的协议：载波监听多址接入/碰撞检测（CSMA/CD）协议**

- 多址接入MA

  - 多个站连接在一条总线上，竞争使用总线

- 载波监听CS

  - 每一个站在发送帧之前先要检测一下总线上是否有其他站点在发送帧（"先听后说"）：
    - 若检测到总线空闲96比特时间，则发送这个帧；
    - 若检测到总线忙，则继续检测并等待总线转为空闲96比特时间，然后发送这个帧
    - **96比特时间是指发送96比特所耗费的时间，也称为帧间最小间隔，其作用是使接收方可以检测出一个帧的结束，同时也使得所有其他站点都能有机会平等竞争信道并发送帧**

- 碰撞检测CD

  - 每一个正在发送帧的站边发送边检测碰撞（"边说边听"）
    - 一旦发现总线上出现碰撞，则立即停止发送，退避一段随机时间后在次发送（"一旦冲突，立即停说，等待时间，重新再说"）
  - 以太网还采取一种叫做**强化碰撞**的措施。这就是当发送帧的站点一旦检测到碰撞，除了立即停止发送帧以外，还要再继续发送**32比特或48比特的人为干扰信号，以便有足够多的碰撞信号使所有站点都能检测出碰撞**

  

- **CSMA/CD协议 —— 争用期（碰撞窗口）**

  - 假设以太网单程端传播时延为T
  - 那么**主机最多经过2T的时长就可检测到本次发送是否遭受了碰撞**
  - 因此，**以太网的端到端往返传播时延2T称为<u>争用期</u>或<u>碰撞窗口</u>**
  - 经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞
  - 每一个主机在自己发送帧之后的一小段时间内，存在着遭遇碰撞的可能性。这一小段时间是不确定的。它取决于另一个发送帧的主机到本主机的举例，但不会超过总线的端到端往返传播时延，即一个争用期时间
  - 显然，在以太网中发送帧的主机越多，端到端往返传播时延越大，发生碰撞的概率就越大。因此，**共享式以太网不能连接太多的主机，使用的总线也不能太长**
    - 10Mb/s以太网把争用期定位512比特发送时间，即51.2微妙，因此其总线长度不能超过5120m，但考虑到其他一些因素，如信号衰减等，以太网规定总线长度不能超过2500m

- **CSMA/CD协议 —— 最小帧长**

  - **以太网规定最小帧长为64字节**，即512比特（512比特时间即为争用期）
    - 如果要发送的数据非常少，那么必须加入一些填充字节，使帧长不小于64字节
  - 以太网的**最小帧长确保了主机可在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞**
    - 如果在争用期（共发送64字节）没有检测到碰撞，那么后续发送的数据就一定不会发生碰撞
    - 如果在争用期内检测到碰撞，就立即中止发送，这时已经发送出去的数据就一定小于64字节。因此**凡长度小于64字节的帧都是由于碰撞而异常中止的无效帧**

- **CSMA/CD协议 —— 截断二进制指数退避算法**

  - `退避时间 = 基本退避时间（争用期2T） * 随机数r（r从离散的整数集合{0，1，... ，(2的k次方-1)}中随机选出一个数k = Min[重传次数，10]`
  - 若连续多次发生碰撞，就表明可能有较多的主机参与竞争信道。但使用上述退避算法可**使重传需要推迟的平均时间随重传次数而增大**（这也称为**动态退避**），因而**减小发生碰撞的概率**，有利于整个系统的稳定
  - **当重传达16次仍不能成功时**，表明同时打算发送帧的主机太多，以至于连续发生碰撞，则**丢弃该帧**，并向高层报告

- **CSMA/CD协议 —— 信道利用率**

  - 考虑以下这种理想情况：
    - 各主机发送帧都不会产生碰撞
    - 总线一旦空闲就有某个主机立即发送帧
    - 发送一帧占用总线的时间为T0+ T，而帧本身的发送时间是T0
  - 故极限信道利用率为`S = T0 / T0 + T`
  - 要提高信道利用率，需要：
    - 减小以太网端到端的距离 
    - 增长以太网帧的长度

- **CSMA/CD协议 —— 帧发送流程**

  - 首先监听信道，查看信道是否活跃

    - 若否，继续监听
    - 若是，开始接收帧

  - 判断是否接收完成

    - 否，继续接收
    - 是，判断帧是否太短

  - 帧是否太短**（小于最短帧长则认为遭遇了碰撞）**

    - 是，丢弃帧
    - 否，判断地址是否正确

  - 地址是否正确**（帧的目的MAC地址与接收方的MAC地址相同或是广播地址）**

    - 否，丢弃帧
    - 是，判断是否校验正确

  - 是否校验正确**（使用CRC检查帧是否出现了误码）**

    - 否，丢弃该帧
    - 是，接收该帧，接收结束

    





#### 3.6.4  媒体接入控制 — 动态接入控制 — 随机接入（CSMA/CA协议）

- **无线局域网使用的协议：载波监听多址接入/碰撞避免（CSMA/CA）协议**

- 既然CSMA/CD协议已经成功地应用于使用广播信道的有线局域网，那么同样使用广播信道的无线局域网能不能也使用CSMA/CD协议呢？

  - **在无线局域网中，仍然可以使用载波监听多址接入CSMA**，即在发送帧之前先对传输媒体进行载波监听。若发现有其他站在发送帧，就推迟发送以免发生碰撞
  - **在无线局域网中，不能使用碰撞检测CD**，原因如下：
    - 由于无线信道的传输条件特殊，其信号强度的动态范围非常大，无线网卡上接收到的信号强度往往会远远小于发送信号的强度（可能相差百万倍）。**如果要在无线网卡上实现碰撞检测CD，对硬件的要求非常高**
    - 即使能够在硬件上实现无线局域网的碰撞检测功能，但由于无线电波传播的特殊性**（存在隐蔽站问题），进行碰撞检测的意义也不大**

- **载波监听多址接入/碰撞避免（CSMA/CA）**

  - **802.11无线局域网**使用CSMA/CA协议，在CSMA的基础上增加了一个**碰撞避免CA功能**，而不再实现碰撞检测功能
  - 由于**不可能避免所有的碰撞**，并且**无线信道误码率较高**，802.11标准还使用了**数据链路层确认机制（停止-等待协议）**来保证数据被正确接收
  - 802.11的MAC层标准定义了两种不同的媒体接入控制方式：
    - **分布式协调功能DCF**（Distributed Coordination Function）。在DCF方式下，没有中心控制站点，每个站点使用CSMA/CA协议通过争用信道来获取发送权，这是802.11定义的默认方式
    - **点协调功能PCF**（Point Coordination Function）。PCF方式使用集中控制的接入算法（一般在接入点AP实现集中控制），是802.11定义的可选方式，在实际中较少使用

- **帧间间隔IFS（InterFrame Space）**

  - 802.11标准规定，所有的**站点必须在持续检测到信道空闲一段时间后才能发送帧**，这段时间称为帧间间隔IFS 
  - 帧间间隔的长短取决于该站点要发送的帧的类型：
    - 高优先级帧需要等待的时间较短，因此可优先获得发送权
    - 低优先级帧需要等待的时间较长。若某个站的低优先级帧还没来得及发送，而其他站的高优先级帧已发送到信道上，则信道变为忙态，因而低优先级帧就只能再推迟发送了。这样就减少了发生碰撞的机会
  - 常用的两种帧间间隔如下：
    - **短帧间间隔SIFS（28微秒）**，是最短的帧间间隔，用来分隔开属于一次对话的各帧。一个站点应当能够在这段时间内从发送方式切换到接收方式。使用SIFS的帧类型有ACK帧、CTS帧、由过长的MAC帧分片后的数据帧、以及所有回答AP探询的帧和在PCF方式中接入点AP发送出的任何帧
    - **DCF帧间间隔DIFS（128微秒）**，它比短帧间间隔SIFS要长的多，在DCF方式中用来发送数据帧和管理帧

- **CSMA/CA协议的工作原理**

  - 源站有数据帧要发送，此时**检测到信道是空闲的**，则**源站在等待帧间间隔DIFS后发送该数据帧**。**目的站**若正确接收到该数据帧，则**经过帧间间隔SIFS后**，**向源站发送确认帧ACK**。（若源站没有在规定时间内收到ACK，则由重传计时器控制这段时间，就必须重传该数据帧，直到收到确认ACK为止。或者经过若干次的重传失败后放弃发送）

  - 源站为什么要检测到信道空闲后还要再等待一段时间DIFS？

    - 就是考虑到可能有其他的站有高优先级的帧要发送。若有，就让高优先级帧先发送。

  - 目的站为什么正确接收数据帧后还要等待一段时间SIFS才能发送ACK帧？

    - SIFS是最短的帧间间隔，用来分隔开属于一次对话的各帧。在这段时间内，一个站点应当能够从发送方式切换到接收方式

  - 在信道忙的时候，其他站要发送数据需要退避。当信道由忙转为空闲后，其他站需要等待一段时间DIFS，然后再退避一段随机时间才能使用信道发送下一帧

    - 为什么当**信道由忙转为空闲并经过一段时间DIFS后，还要再退避一段随机时间才能使用信道**？
      - **这样做的目的在于，防止多个站点同时发送数据而产生碰撞**

  - **当站点检测到信道是空闲的，并且所发送的数据帧不是成功发送完上一个数据帧之后立即连续发送的数据帧，则不使用退避算法**

  - 以下情况必须使用退避算法：

    - 在发送数据帧之前检测到信道处于忙状态时；
    - 在每一次重传一个数据帧时
    - 在每一次成功发送后要连续发送下一个帧时（这是为了避免一个站点长时间占用信道）

    

- **<u>CSMA/CA协议的退避算法</u>**

  - 在执行退避算法时，站点为退避计时器设置一个随机的退避时间

    - 当退避计时器的时间减小到零时，就开始发送数据
    - 当退避计时器的时间还未减小到零时而信道又转变为忙状态，这时就冻结退避计时器的数值，重新等待信道变为空闲，再经过时间DIFS后，继续启动退避计时器

  - 在进行第i次退避时，退避时间在时隙编号{0,1,...,2的2+i次方-1}中随机选择一个，然后乘以基本退避时间（也就是一个时隙的长度）就可以得到随机的退避时间。这样做是为了使不同站点选择相同退避时间的概率减少。当时隙编号达到255时（对应于第6次退避）就不再增加了

    

- **CSMA/CA协议的信道预约和虚拟载波监听**

  - 为了**尽可能减少碰撞的概率**和降低碰撞的影响，802.11标准允许要发送数据的站点**对信道进行预约**

    1. 源站在发送数据帧之前先发送一个短的控制帧，称为**请求发送RTS**（Request To Send），它包括源地址、目的地址以及这次通信（包括相应的确认帧）所需的持续时间
    2. 若目的站正确收到源站发来的RTS帧，且媒体空闲，就发送一个响应控制帧，称为**允许发送CTS**（Clear To Send），它也包括这次通信所需的持续时间（从RTS帧中将此持续时间复制到CTS帧中）
    3. 源站收到CTS帧后，再等待一段时间SIFS后，就可发送其数据帧
    4. 若目的站正确收到了源站发来的数据帧，在等待时间SIFS后，就向源站发送确认帧ACK 

  - 除源站和目的站以外的**其他各站**，在**收到CTS帧（或数据帧）后就推迟接入到无线局域网中**。这样就保证了源站和目的站之间的通信不会收到其他站的干扰

  - 如果RTS帧发生碰撞，源站就收不到CTS帧，需执行退避算法重传RTS帧

  - 由于**RTS帧和CTS帧很短，发送碰撞的概率、碰撞产生的开销及本身的开销都很小**。而对于一般的数据帧，其发送时延往往大于传播时延（因为是局域网），碰撞的概率很大，且一旦发生碰撞而导致数据帧重发，则浪费的时间就很多，因此**用很小的代价对信道进行预约往往是值得的**。802.11标准规定了3中情况供用户选择

    - 使用RTS帧和CTS帧
    - 不使用RTS帧和CTS帧
    - 只有当数据帧的长度超过某一数值时才使用RTS帧和CTS帧

    

  - 除RST帧和CTS帧会携带通信需要持续的时间，数据帧也能携带通信需要持续的时间，这称为802.11的**虚拟载波监听**机制

  - 由于利用虚拟载波监听机制，**站点只需要监听到RTS帧、CTS帧或数据帧中的任何一个，就能知道信道被占用的持续时间**，而不需要真正监听到信道上的信号，因此**虚拟载波监听机制能减少隐蔽站带来的碰撞问题**

    







### 3.7 MAC地址、IP地址以及ARP协议

#### 3.7.1 MAC地址

- **MAC地址是以太网的MAC子层所使用的地址（数据链路层）**

- 使用情况

  - 使用点对点信道的数据链路层不需要使用地址
  - 使用广播信道的数据链路层必须使用地址来区分各主机

- 当多个主机连接在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个唯一的标识，即一个数据链路层地址；

- 在每个主机发送的**帧中必须携带标识发送主机和接收主机的地址**。由于这类地址是用于媒体接入控制MAC（Media Access Control），因此这类地址被称为**MAC地址**

  - MAC地址一般被固化在网卡（网络适配器）的点可擦可编程只读存储器EEPROM中，因此MAC地址也被称为**硬件地址**
  - MAC地址有时也被称为**物理地址**。但是注意：**这并不意味着MAC地址属于网络体系结构中的物理层**

- 一般情况下，用户主机会包含两个网络适配器：有线局域网适配器（有线网卡）和无线局域网适配器（无线网卡）。每个网络适配器都有一个全球唯一的MAC地址。而交换机和路由器往往拥有更多的网络接口，所以会拥有更多的MAC地址。综上所述，**严格来说，MAC地址是对网络上个接口的唯一标识，而不是对网络上各设备的唯一标识**

- IEEE 802局域网的MAC地址格式

  - 这种标识符称为**扩展的唯一标识符EUI-48**

  - 共有6个字节，每个字节有8个比特(b7,b6,b5,b4,b3,b2,b1,b0)

  - 前三个字节为组织唯一的标识符OUI（由IEEE的注册管理机构分配）

  - 后三个字节是网络接口标识符（获得OUI的厂商可自行随意分配）

  - 表示法

    - 标准表示法：将四个比特写为一个十六进制的数，连接起来`XX-XX-XX-XX-XX-XX`
    - 其他表示法：`XX:XX:XX:XX:XX:XX`或`XXXX.XXXX.XXXX`

  - MAC地址第一字节的b0位

    - 取1时，表示该地址是多播地址，又称为组播地址
    - 取0时，表示该地址是单播地址

  - MAC地址第一字节的b1位

    - 取0时，表示该地址是全球管理的，也就是全球唯一的
    - 取1时，表示该地址是本地管理

  - | 第一字节的b1位 | 第一字节的b0位 | MAC地址类型                                                  | 地址数量占比 | 总地址数量                                  |
    | -------------- | -------------- | ------------------------------------------------------------ | ------------ | ------------------------------------------- |
    | 0              | 0              | 全球管理，单播地址；厂商生产网络设备（网卡，交换机，路由去）时固化 | 1/4          | 2的48次方=281474976710656（二百八十多万亿） |
    | 0              | 1              | 全球管理，多播地址；标准网络设备所支持的多播地址，用于特定功能 | 1/4          | 2的48次方=281474976710656（二百八十多万亿） |
    | 1              | 0              | 本地管理，单播地址；由网络管理员分配，覆盖网络接口的全球管理单播地址 | 1/4          | 2的48次方=281474976710656（二百八十多万亿） |
    | 1              | 1              | 本地管理，多播地址；用户对主机进行软件配置，以表面其属于哪些多播组。**注意：剩余46位全为1时，就是广播地址FF-FF-FF-FF-FF-FF** | 1/4          | 2的48次方=281474976710656（二百八十多万亿） |

  - 发送顺序：

    - 字节发送顺序：第一字节到第六字节
    - 字节内比特发送顺序： b0到b7

- **单播MAC地址**举例

  - 一条总线上连着A,B,C三台主机
  - 假设主机B要给主机C发送单播帧。
    - 主机B首先要构建该单播帧：在帧首部中的目的地址字段填入主机C的MAC地址，源地址字段填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该单播帧
    - 主机B将该单播帧发送出去，主机A和C都会收到该单播帧
    - 主机A发现目的地址与自己不匹配，丢弃该帧
    - 主机C发现目的地址与自己匹配，接收该帧，并交给上层处理

- **广播MAC地址**举例

  - 假设主机B要发送广播帧
    - 主机B首先要构建该广播帧：在帧首部的目的地址字段填入**广播地址（也就是十六进制的全F`FF-FF-FF-FF-FF-FF`）**，源地址字段填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该广播帧
    - 主机B将该广播帧发送出去，主机A和C都会收到该广播帧，发现该帧首部中的目的地址字段的内容是广播帧，就知道该帧是广播帧，接收该帧并交给上层处理

- **多播MAC地址**举例

  - 一条总线上连着A,B,C,D四台主机
  - 假设主机A要发送多播帧给该多播地址
    - 将该多播地址的左起第一个字节写成8个比特（最低比特位b0是1，表明这是一个多播地址）
      - **快速判断MAC地址是否是多播地址的方法：左起第一位十六进制数不能整除2（1，3，5，7，9，B，D，F），则为多播地址**
    - 主机A首先要构建该多播帧：在帧首部的目的地址字段填入该多播地址，源地址字段填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该多播帧
    - 主机A将该多播帧发送出去，主机B,C,D都会收到该多播帧，主机B，C发现该多播帧的目的MAC地址在自己的多播组列表中，接收该帧并传交给上层处理
    - 主机D发现该多播帧的目的MAC地址不在自己的多播组列表中，丢弃该帧





#### 3.7.2 IP地址

- **IP地址是TCP/IP体系结构网际层所使用的地址（网际层），用于标识两部分信息：**

  - 网络编号：标识因特网上数以百万计的网络
  - 主机编号：标识同一网络上不同主机（或路由器接口）

- 很显然，上面的MAC地址不具备区分不同网络的功能

  - 如果只是一个单独的网络，不接入因特网，可以只使用MAC地址（这不是一般用户的应用方式）
  - 如果主机所在的网络需要接入因特网，则IP地址和MAC地址都需要使用

- 数据包转发过程中IP地址与MAC地址的变化情况

  - 假设此时的连接情况为：`主机H1——路由器R1——路由器R2——主机H2`，此时H1要给H2发送一个数据包

  - H1发送到路由器R1

    - 网络层时，H1数据包的源IP地址应填写主机H1的IP地址IP1，目的IP地址应填写主机H2的IP地址IP2
    - 数据链路层时，数据包的源MAC地址应填写主机H1的MAC地址MAC1，目的MAC地址应填写路由器R1的MAC地址MAC3

  - 路由器R1转发到路由器R2

    - 网络层时，数据包的源IP地址仍填写主机H1的IP地址IP1，目的IP地址仍填写主机H2的IP地址IP2
    - 数据链路层时，H1数据包的源MAC地址应填写路由器R1的MAC地址MAC4，目的MAC地址应填写路由器R2的MAC地址MAC5（MAC3和MAC4是R1中的不同接口）

  - 路由器R2转发给主机H2

    - 网络层时，H1数据包的源IP地址仍填写主机H1的IP地址IP1，目的IP地址仍填写主机H2的IP地址IP2
    - 数据链路层时，H1数据包的源MAC地址应填写路由器R2的MAC地址MAC6，目的MAC地址应填写主机H2的MAC地址MAC2

  - 可看出：

    - **数据包转发过程中源IP地址和目的IP地址保持不变**
    - **数据包转发过程中源MAC地址和目的MAC地址逐个链路（或逐个网络）改变**

    



#### 3.7.3 ARP协议

- **ARP协议属于TCP/IP体系结构的网际层，<u>其作用是已知设备所分配到的IP地址，使用ARP协议可以通过该IP地址获取到设备的MAC地址</u>（网际层）**

- **实际上每台主机都会有一个ARP高速缓存表，其中记录有IP地址和MAC地址的对应关系**

  - **ARP高速缓存表中的每一条记录，都有其类型，分为动态和静态：**
    - **动态：自动获取，生命周期默认为两分钟；（生命周期结束时，记录将自动删除——因为IP地址与MAC地址的对应关系并不是永久性的）**
    - **静态：手工设置，不同操作系统下的生命周期不同，例如系统重启后不存在或系统重启后依然有效**

- **发送过程**

  - 源主机在自己的**ARP高速缓存表**中查找目的主机的IP地址所对应的MAC地址，若找到了，则可以封装MAC帧进行发送；若找不到，则发送**ARP请求（封装在广播MAC帧中）**

  - 目的主机收到ARP请求后，将源主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后给源主机发送**ARP响应（封装在单播MAC帧中）**，ARP响应中包含有目的主机的IP地址和MAC地址

  - 源主机收到ARP响应后，将目的主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后就可以封装之前想发送的MAC帧并发送给目的主机

    

- 例子：

  - 假设此时一根总线上有主机A,B,C

  - B要给C发送数据包，B知道C的IP地址但不知道C的MAC地址，因此B的数据链路层在封装MAC帧时就无法填写目的的MAC地址

    - A收到B发送的帧，交给上层，发现IP地址不对应，丢弃该帧
    - C收到B发送的帧，交给上层，上层的ARP进程解析ARP报文，发现询问的IP地址是自己的IP地址，需要进行响应
      - **主机C首先将B的IP地址与MAC地址记录到自己的ARP高速缓存表中**
      - **然后给主机B发送ARP响应（单播帧），以告知自己的MAC地址**
      - **ARP响应报文内容：我的IP地址和我的MAC地址**

  - 主机C给主机B发送ARP单播帧

    - 主机A收到后发现其MAC地址不匹配，丢弃该帧

    - 主机B收到后发现MAC地址匹配，接收该帧交付上层，

      - **上层解析ARP报文，将C的IP地址与MAC地址记录到自己的ARP高速缓存表中**

        

- ARP请求报文（广播）

  - **封装在MAC帧中，目的地址为FF-FF-FF-FF-FF-FF（广播地址）**
  - 我的IP地址为192.168.0.2
  - 我的MAC地址为00-E0-F9-A3-43-77
  - **我想知道IP地址为192.168.0.3的主机的MAC地址**

- **作用范围：ARP协议只能在一段链路或一个网络上使用，而不能跨网络使用**

- **除ARP请求和响应外，ARP还有其他类型的报文**（例如用于检查IP地址冲突的"无故ARP、免费ARP"）

- ARP没有安全验证机制，**存在ARP欺骗（攻击）问题**

  































































